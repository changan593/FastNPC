# è§’è‰²å¤´åƒåŠŸèƒ½è¯´æ˜

## âœ¨ åŠŸèƒ½æ¦‚è¿°

FastNPC ç°åœ¨æ”¯æŒä»æ•°æ®æºï¼ˆå¦‚ç™¾åº¦ç™¾ç§‘ï¼‰è‡ªåŠ¨æŠ“å–è§’è‰²å›¾ç‰‡ä½œä¸ºå¤´åƒï¼Œå¹¶åœ¨ç•Œé¢ä¸­ä»¥åœ†è§’æ­£æ–¹å½¢çš„å½¢å¼å±•ç¤ºã€‚

## ğŸ¯ åŠŸèƒ½ç‰¹æ€§

### 1. è‡ªåŠ¨æŠ“å–å¤´åƒ
- åœ¨åˆ›å»ºè§’è‰²æ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨ä»ç™¾åº¦ç™¾ç§‘é¡µé¢æŠ“å–è§’è‰²å›¾ç‰‡
- ä½¿ç”¨CSSé€‰æ‹©å™¨ `#side > div.abstractAlbum_jhNeu > img` ç­‰å¤šç§é€‰æ‹©å™¨æå–å›¾ç‰‡
- æ”¯æŒå¤šç§å¤‡ç”¨é€‰æ‹©å™¨ï¼Œæé«˜æŠ“å–æˆåŠŸç‡

### 2. å›¾ç‰‡å¤„ç†
- è‡ªåŠ¨è£å‰ªä¸ºæ­£æ–¹å½¢ï¼ˆä¸­å¿ƒè£å‰ªï¼‰
- ç»Ÿä¸€è°ƒæ•´ä¸º 256x256 åƒç´ 
- è½¬æ¢ä¸º JPEG æ ¼å¼ï¼Œä¼˜åŒ–å­˜å‚¨ç©ºé—´ï¼ˆquality=85ï¼‰
- è‡ªåŠ¨å¤„ç†é€æ˜èƒŒæ™¯ï¼ˆè½¬æ¢ä¸ºç™½è‰²èƒŒæ™¯ï¼‰

### 3. å­˜å‚¨ä¸å±•ç¤º
- å¤´åƒä¿å­˜åœ¨ `Avatars/` ç›®å½•
- æ–‡ä»¶å‘½åæ ¼å¼ï¼š`user_{ç”¨æˆ·ID}_{è§’è‰²å}.jpg`
- åœ¨ä¾§è¾¹æ æ˜¾ç¤ºä¸º 40x40 åƒç´ çš„åœ†è§’æ­£æ–¹å½¢
- å¦‚æœæ²¡æœ‰å¤´åƒï¼Œæ˜¾ç¤ºé»˜è®¤å›¾æ ‡ï¼ˆğŸ‘¤ï¼‰

## ğŸ“‚ æ–‡ä»¶ç»“æ„

```
FastNPC/
â”œâ”€â”€ Avatars/                          # å¤´åƒå­˜å‚¨ç›®å½•ï¼ˆè‡ªåŠ¨åˆ›å»ºï¼‰
â”‚   â”œâ”€â”€ user_1_å“ªå’.jpg
â”‚   â””â”€â”€ user_1_å­™æ‚Ÿç©º.jpg
â”œâ”€â”€ fastnpc/
â”‚   â”œâ”€â”€ utils/
â”‚   â”‚   â””â”€â”€ image_utils.py           # å›¾ç‰‡å¤„ç†å·¥å…·æ¨¡å— â­ æ–°å¢
â”‚   â”œâ”€â”€ datasources/
â”‚   â”‚   â””â”€â”€ baike_robust.py          # ç™¾åº¦ç™¾ç§‘çˆ¬è™«ï¼ˆå·²ä¿®æ”¹ï¼Œæ·»åŠ å¤´åƒæå–ï¼‰
â”‚   â””â”€â”€ api/
â”‚       â”œâ”€â”€ server.py                 # æ·»åŠ äº† /avatars é™æ€æ–‡ä»¶æœåŠ¡
â”‚       â”œâ”€â”€ state.py                  # è§’è‰²åˆ›å»ºæµç¨‹ï¼ˆæ·»åŠ å¤´åƒä¸‹è½½é€»è¾‘ï¼‰
â”‚       â”œâ”€â”€ utils.py                  # è§’è‰²åˆ—è¡¨APIï¼ˆæ·»åŠ avatar_urlå­—æ®µï¼‰
â”‚       â””â”€â”€ auth/
â”‚           â”œâ”€â”€ db_init.py            # æ•°æ®åº“è¡¨ï¼ˆæ·»åŠ avatar_urlå­—æ®µï¼‰
â”‚           â””â”€â”€ char_data.py          # è§’è‰²æ•°æ®æ“ä½œï¼ˆæ”¯æŒavatar_urlï¼‰
â””â”€â”€ web/fastnpc-web/src/
    â”œâ”€â”€ types.ts                      # ç±»å‹å®šä¹‰ï¼ˆæ·»åŠ avatar_urlå­—æ®µï¼‰
    â””â”€â”€ components/
        â””â”€â”€ Sidebar.tsx               # ä¾§è¾¹æ ï¼ˆæ˜¾ç¤ºåœ†è§’æ­£æ–¹å½¢å¤´åƒï¼‰â­ ä¿®æ”¹
```

## ğŸ”§ æŠ€æœ¯å®ç°

### åç«¯

#### 1. æ•°æ®åº“å˜æ›´
```sql
ALTER TABLE characters ADD COLUMN avatar_url TEXT;
```

#### 2. å›¾ç‰‡å¤„ç†ï¼ˆ`fastnpc/utils/image_utils.py`ï¼‰
```python
download_and_crop_avatar(
    image_url: str,      # å›¾ç‰‡URL
    save_dir: str,       # ä¿å­˜ç›®å½•
    filename: str,       # æ–‡ä»¶åï¼ˆä¸å«æ‰©å±•åï¼‰
    size: (256, 256),    # ç›®æ ‡å°ºå¯¸
    timeout: 15          # ä¸‹è½½è¶…æ—¶ï¼ˆç§’ï¼‰
) -> Optional[str]       # è¿”å›ä¿å­˜çš„æ–‡ä»¶å
```

ä¸»è¦æ­¥éª¤ï¼š
1. ä¸‹è½½å›¾ç‰‡ï¼ˆå¸¦ Referer é˜²åçˆ¬ï¼‰
2. ä½¿ç”¨ Pillow åŠ è½½å›¾ç‰‡
3. å¤„ç†é€æ˜é€šé“ï¼ˆè½¬ä¸ºç™½è‰²èƒŒæ™¯ï¼‰
4. ä¸­å¿ƒè£å‰ªä¸ºæ­£æ–¹å½¢
5. è°ƒæ•´å°ºå¯¸ä¸º 256x256
6. ä¿å­˜ä¸º JPEGï¼ˆquality=85ï¼‰

#### 3. çˆ¬è™«é›†æˆï¼ˆ`fastnpc/datasources/baike_robust.py`ï¼‰
åœ¨ `_parse_html_content` å‡½æ•°ä¸­æ·»åŠ å¤´åƒæå–é€»è¾‘ï¼š
```python
# å°è¯•å¤šç§é€‰æ‹©å™¨æå–å¤´åƒ
avatar_selectors = [
    '#side div.abstractAlbum_jhNeu img',
    'div.abstractAlbum_jhNeu img',
    'div.summary-pic img',
    'div.lemma-summary img',
    '#side img',
]
```

#### 4. è§’è‰²åˆ›å»ºæµç¨‹ï¼ˆ`fastnpc/api/state.py`ï¼‰
```python
# å¤„ç†å¤´åƒï¼ˆå¦‚æœæœ‰ï¼‰
if raw_data.get('avatar_url'):
    avatar_saved = download_and_crop_avatar(
        image_url=raw_data['avatar_url'],
        save_dir=avatar_dir,
        filename=f"user_{user_id}_{role}",
        size=(256, 256),
        timeout=15
    )
    if avatar_saved:
        avatar_saved_path = f"/avatars/{avatar_saved}"
```

#### 5. API è¿”å›ï¼ˆ`fastnpc/api/utils.py`ï¼‰
è§’è‰²åˆ—è¡¨APIç°åœ¨åŒ…å« `avatar_url` å­—æ®µï¼š
```json
{
  "items": [
    {
      "role": "å“ªå’",
      "path": "db://characters/123",
      "updated_at": 1234567890,
      "preview": "å“ªå’ï¼Œä¸­å›½å¤ä»£ç¥è¯ä¼ è¯´äººç‰©...",
      "avatar_url": "/avatars/user_1_å“ªå’.jpg"
    }
  ]
}
```

### å‰ç«¯

#### 1. ç±»å‹å®šä¹‰ï¼ˆ`types.ts`ï¼‰
```typescript
export interface CharacterItem {
  role: string;
  path: string;
  updated_at: number;
  preview?: string;
  avatar_url?: string;  // â­ æ–°å¢
}
```

#### 2. ä¾§è¾¹æ æ˜¾ç¤ºï¼ˆ`Sidebar.tsx`ï¼‰
```tsx
{item.type === 'character' && item.data.avatar_url ? (
  <div 
    className="avatar" 
    style={{ 
      width: 40, 
      height: 40, 
      borderRadius: 8,  // åœ†è§’æ­£æ–¹å½¢
      overflow: 'hidden',
      marginRight: 12,
      flexShrink: 0
    }}
  >
    <img 
      src={item.data.avatar_url} 
      alt={item.name}
      style={{ width: '100%', height: '100%', objectFit: 'cover' }}
    />
  </div>
) : null}
```

## ğŸ“¦ ä¾èµ–é¡¹

### æ–°å¢ä¾èµ–
åœ¨ `requirements.txt` ä¸­æ·»åŠ ï¼š
```
Pillow>=10.0.0
```

### å®‰è£…ä¾èµ–
```bash
pip install Pillow>=10.0.0
```

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### 1. æ›´æ–°ä»£ç 
```bash
git pull
```

### 2. å®‰è£…æ–°ä¾èµ–
```bash
pip install -r requirements.txt
```

### 3. æ•°æ®åº“è¿ç§»
ç³»ç»Ÿä¼šåœ¨å¯åŠ¨æ—¶è‡ªåŠ¨æ£€æµ‹å¹¶æ·»åŠ  `avatar_url` å­—æ®µï¼Œæ— éœ€æ‰‹åŠ¨æ“ä½œã€‚

å¦‚æœéœ€è¦æ‰‹åŠ¨è¿ç§»ï¼Œå¯ä»¥æ‰§è¡Œï¼š
```bash
# PostgreSQL
psql -U your_user -d your_db -f migrations/add_avatar_url.sql

# SQLite
sqlite3 your_database.db < migrations/add_avatar_url.sql
```

### 4. é‡å¯æœåŠ¡
```bash
# å¦‚æœä½¿ç”¨ start_dev.sh
./start_dev.sh

# æˆ–è€…ç›´æ¥è¿è¡Œ
python -m fastnpc.api.server
```

### 5. å‰ç«¯é‡æ–°æ„å»ºï¼ˆå¦‚æœä¿®æ”¹äº†å‰ç«¯ä»£ç ï¼‰
```bash
cd web/fastnpc-web
npm install
npm run build
```

## ğŸ¨ æ ·å¼è¯´æ˜

### å¤´åƒæ˜¾ç¤ºæ ·å¼
- **å°ºå¯¸**: 40x40 åƒç´ ï¼ˆä¾§è¾¹æ ï¼‰
- **å½¢çŠ¶**: åœ†è§’æ­£æ–¹å½¢ï¼ˆ`borderRadius: 8px`ï¼‰
- **å¯¹é½**: å·¦å¯¹é½ï¼Œå³ä¾§æ˜¾ç¤ºè§’è‰²åç§°å’Œæ—¶é—´
- **å›é€€**: å¦‚æœæ²¡æœ‰å¤´åƒï¼Œæ˜¾ç¤º ğŸ‘¤ å›¾æ ‡

### æ”¯æŒçš„å›¾ç‰‡æ ¼å¼
- è¾“å…¥ï¼šJPEG, PNG, GIF, WebP ç­‰ï¼ˆPillow æ”¯æŒçš„æ ¼å¼ï¼‰
- è¾“å‡ºï¼šJPEGï¼ˆç»Ÿä¸€æ ¼å¼ï¼Œä½“ç§¯ä¼˜åŒ–ï¼‰
- é€æ˜èƒŒæ™¯è‡ªåŠ¨è½¬æ¢ä¸ºç™½è‰²èƒŒæ™¯

## ğŸ” æ•…éšœæ’æŸ¥

### 1. å¤´åƒæœªæ˜¾ç¤º
**å¯èƒ½åŸå› **ï¼š
- ç™¾åº¦ç™¾ç§‘é¡µé¢æ²¡æœ‰å›¾ç‰‡
- å›¾ç‰‡ä¸‹è½½å¤±è´¥ï¼ˆç½‘ç»œé—®é¢˜ï¼‰
- å›¾ç‰‡URLæå–å¤±è´¥ï¼ˆé¡µé¢ç»“æ„å˜åŒ–ï¼‰

**è§£å†³æ–¹æ³•**ï¼š
- æŸ¥çœ‹åç«¯æ—¥å¿—ï¼Œç¡®è®¤æ˜¯å¦æœ‰å›¾ç‰‡URLæå–æˆåŠŸçš„æ—¥å¿—
- æ£€æŸ¥ `Avatars/` ç›®å½•æ˜¯å¦æœ‰å¯¹åº”æ–‡ä»¶
- å¦‚æœæ˜¯ç½‘ç»œé—®é¢˜ï¼Œå¯ä»¥æ‰‹åŠ¨ä¸‹è½½å›¾ç‰‡å¹¶æ”¾åˆ° `Avatars/` ç›®å½•

### 2. å¤´åƒæ˜¾ç¤ºæ¨¡ç³Š
**åŸå› **ï¼šåŸå§‹å›¾ç‰‡åˆ†è¾¨ç‡è¾ƒä½

**è§£å†³æ–¹æ³•**ï¼š
- ç›®æ ‡å°ºå¯¸è®¾ç½®ä¸º 256x256ï¼Œè¶³å¤Ÿæ¸…æ™°
- å¯ä»¥æ‰‹åŠ¨æ›¿æ¢æ›´é«˜æ¸…çš„å›¾ç‰‡

### 3. Pillow å®‰è£…å¤±è´¥
**å¯èƒ½åŸå› **ï¼šç¼ºå°‘ç³»ç»Ÿä¾èµ–

**è§£å†³æ–¹æ³•**ï¼š
```bash
# Ubuntu/Debian
sudo apt-get install libjpeg-dev libpng-dev

# CentOS/RHEL
sudo yum install libjpeg-devel libpng-devel

# macOS
brew install libjpeg libpng
```

### 4. å¤´åƒæ–‡ä»¶å ç”¨ç©ºé—´è¿‡å¤§
**è§£å†³æ–¹æ³•**ï¼š
- ç³»ç»Ÿå·²è‡ªåŠ¨ä¼˜åŒ–ï¼ˆJPEG quality=85ï¼‰
- æ¯ä¸ªå¤´åƒçº¦ 10-50KB
- å®šæœŸæ¸…ç†ä¸å†ä½¿ç”¨çš„å¤´åƒæ–‡ä»¶

## ğŸ“Š æ€§èƒ½å½±å“

### å­˜å‚¨ç©ºé—´
- æ¯ä¸ªå¤´åƒçº¦ 10-50KB
- 1000ä¸ªè§’è‰²çº¦å ç”¨ 10-50MB

### ç½‘ç»œå¸¦å®½
- é¦–æ¬¡åŠ è½½å¤´åƒæ—¶éœ€è¦ä¸‹è½½
- æµè§ˆå™¨ä¼šè‡ªåŠ¨ç¼“å­˜
- å»ºè®®é…ç½® CDN åŠ é€Ÿ

### åˆ›å»ºè§’è‰²æ—¶é—´
- å¢åŠ çº¦ 2-5 ç§’ï¼ˆå›¾ç‰‡ä¸‹è½½å’Œå¤„ç†ï¼‰
- å¼‚æ­¥å¤„ç†ï¼Œä¸é˜»å¡ä¸»æµç¨‹
- å¦‚æœä¸‹è½½å¤±è´¥ï¼Œä¸å½±å“è§’è‰²åˆ›å»º

## ğŸ” å®‰å…¨è€ƒè™‘

### 1. æ–‡ä»¶å‘½å
- ä½¿ç”¨å›ºå®šæ ¼å¼ï¼š`user_{user_id}_{role}.jpg`
- é˜²æ­¢è·¯å¾„éå†æ”»å‡»

### 2. æ–‡ä»¶å¤§å°é™åˆ¶
- ä¸‹è½½è¶…æ—¶ï¼š15ç§’
- ç›®æ ‡å°ºå¯¸å›ºå®šï¼š256x256
- æ ¼å¼ç»Ÿä¸€ï¼šJPEG

### 3. é™æ€æ–‡ä»¶æœåŠ¡
- ä½¿ç”¨ FastAPI çš„ StaticFiles
- ä»…å…è®¸è®¿é—® `/avatars/` ç›®å½•
- ä¸å…è®¸ç›®å½•åˆ—è¡¨

## ğŸ“ æœªæ¥ä¼˜åŒ–æ–¹å‘

### 1. æ‰‹åŠ¨ä¸Šä¼ å¤´åƒ
- å…è®¸ç”¨æˆ·æ‰‹åŠ¨ä¸Šä¼ è‡ªå®šä¹‰å¤´åƒ
- æ·»åŠ å¤´åƒç¼–è¾‘åŠŸèƒ½ï¼ˆè£å‰ªã€æ—‹è½¬ï¼‰

### 2. CDN åŠ é€Ÿ
- å°†å¤´åƒä¸Šä¼ åˆ° OSSï¼ˆå¦‚é˜¿é‡Œäº‘ã€è…¾è®¯äº‘ï¼‰
- ä½¿ç”¨ CDN åŠ é€Ÿè®¿é—®

### 3. æ™ºèƒ½è£å‰ª
- ä½¿ç”¨äººè„¸è¯†åˆ«è‡ªåŠ¨å®šä½è£å‰ªåŒºåŸŸ
- æé«˜å¤´åƒè´¨é‡

### 4. å¤šå°ºå¯¸æ”¯æŒ
- ç”Ÿæˆå¤šç§å°ºå¯¸çš„ç¼©ç•¥å›¾
- å“åº”å¼åŠ è½½ï¼ˆç§»åŠ¨ç«¯åŠ è½½å°å°ºå¯¸ï¼‰

### 5. ç¼“å­˜ä¼˜åŒ–
- ä½¿ç”¨ Redis ç¼“å­˜å¤´åƒURL
- å‡å°‘æ•°æ®åº“æŸ¥è¯¢

## âœ… æµ‹è¯•æ¸…å•

- [ ] åˆ›å»ºæ–°è§’è‰²æ—¶ï¼Œå¤´åƒè‡ªåŠ¨æŠ“å–å¹¶æ˜¾ç¤º
- [ ] å¤åˆ¶è§’è‰²æ—¶ï¼Œå¤´åƒä¸€èµ·å¤åˆ¶
- [ ] é‡å‘½åè§’è‰²æ—¶ï¼Œå¤´åƒä¿æŒä¸å˜
- [ ] åˆ é™¤è§’è‰²æ—¶ï¼Œå¤´åƒæ–‡ä»¶æ˜¯å¦éœ€è¦æ¸…ç†ï¼ˆå¾…å®šï¼‰
- [ ] æ²¡æœ‰å¤´åƒçš„è§’è‰²æ˜¾ç¤ºé»˜è®¤å›¾æ ‡
- [ ] å¤´åƒæ˜¾ç¤ºä¸ºåœ†è§’æ­£æ–¹å½¢
- [ ] å¤´åƒåœ¨ä¸åŒåˆ†è¾¨ç‡ä¸‹æ˜¾ç¤ºæ­£å¸¸
- [ ] ä¾§è¾¹æ å¤´åƒå¤§å°é€‚ä¸­ï¼Œä¸é®æŒ¡æ–‡å­—
- [ ] æ•°æ®åº“è¿ç§»æˆåŠŸæ·»åŠ  avatar_url å­—æ®µ
- [ ] Avatars ç›®å½•æƒé™æ­£ç¡®ï¼Œå¯è¯»å†™

## ğŸ“š ç›¸å…³æ–‡ä»¶

### åç«¯
- `fastnpc/utils/image_utils.py` - å›¾ç‰‡å¤„ç†å·¥å…· â­ æ–°å¢
- `fastnpc/datasources/baike_robust.py` - å¤´åƒURLæå–
- `fastnpc/api/state.py` - è§’è‰²åˆ›å»ºæµç¨‹
- `fastnpc/api/server.py` - é™æ€æ–‡ä»¶æœåŠ¡
- `fastnpc/api/utils.py` - è§’è‰²åˆ—è¡¨API
- `fastnpc/api/auth/db_init.py` - æ•°æ®åº“è¡¨å®šä¹‰
- `fastnpc/api/auth/char_data.py` - è§’è‰²æ•°æ®æ“ä½œ
- `fastnpc/api/routes/character_routes.py` - è§’è‰²å¤åˆ¶åŠŸèƒ½

### å‰ç«¯
- `web/fastnpc-web/src/types.ts` - ç±»å‹å®šä¹‰
- `web/fastnpc-web/src/components/Sidebar.tsx` - å¤´åƒæ˜¾ç¤º â­ ä¿®æ”¹

### é…ç½®
- `requirements.txt` - æ·»åŠ  Pillow ä¾èµ–
- `migrations/add_avatar_url.sql` - æ•°æ®åº“è¿ç§»è„šæœ¬ â­ æ–°å¢

## ğŸ’¡ ä½¿ç”¨æç¤º

1. **é¦–æ¬¡éƒ¨ç½²**ï¼šè®°å¾—å®‰è£… Pillow ä¾èµ–å¹¶é‡å¯æœåŠ¡
2. **å·²æœ‰è§’è‰²**ï¼šéœ€è¦é‡æ–°åˆ›å»ºæ‰ä¼šæœ‰å¤´åƒï¼Œæˆ–æ‰‹åŠ¨æ·»åŠ å¤´åƒæ–‡ä»¶
3. **ç™¾åº¦ç™¾ç§‘**ï¼šå¦‚æœé¡µé¢ç»“æ„å˜åŒ–ï¼Œå¯èƒ½éœ€è¦æ›´æ–°é€‰æ‹©å™¨
4. **ç½‘ç»œé—®é¢˜**ï¼šå¯ä»¥åœ¨ `image_utils.py` ä¸­é…ç½®ä»£ç†
5. **å¤´åƒæ›¿æ¢**ï¼šç›´æ¥æ›¿æ¢ `Avatars/` ç›®å½•ä¸­çš„æ–‡ä»¶å³å¯ï¼ˆéœ€æ¸…é™¤ç¼“å­˜ï¼‰

---

**å¼€å‘æ—¥æœŸ**: 2025-10-18  
**ç‰ˆæœ¬**: 1.0.0  
**è´Ÿè´£äºº**: FastNPC Team

