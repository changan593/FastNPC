# 🖼️ 角色头像上传功能 - 使用指南

## ✨ 功能概览

在角色结构化配置页面，您现在可以：
- ✅ 查看角色当前头像
- ✅ 上传新头像（支持点击和拖拽）
- ✅ 自动裁剪为正方形（256x256）
- ✅ 删除头像
- ✅ 实时预览

---

## 🚀 使用方法

### 方法1：从React前端进入

1. **打开FastNPC** (http://localhost:5173/)
2. **在侧边栏右键点击角色**
3. **选择"管理"**
4. **点击"🔧 打开角色配置页面"**

### 方法2：直接访问

浏览器访问：
```
http://localhost:8000/structured/view?role=角色名称
```

例如：
```
http://localhost:8000/structured/view?role=孙悟空202510181802
```

---

## 📸 上传头像

### 方式1：点击上传

1. 点击头像区域或"上传头像"按钮
2. 选择图片文件
3. 自动上传并裁剪
4. 立即显示新头像

### 方式2：拖拽上传 ⭐

1. 直接拖动图片文件到头像区域
2. 松开鼠标
3. 自动上传完成

### 支持的格式

- ✅ JPG / JPEG
- ✅ PNG
- ✅ GIF
- ✅ WebP
- ✅ 其他常见图片格式

### 文件要求

- **大小限制**: 10MB
- **自动处理**: 
  - 裁剪为正方形（中心裁剪）
  - 调整为 256x256 像素
  - 转换为 JPEG 格式
  - 优化文件大小

---

## 🗑️ 删除头像

1. 点击"删除"按钮
2. 确认删除
3. 恢复为默认图标（👤）

---

## 🎨 界面说明

### 头像显示区域

```
┌─────────────────────────────┐
│      角色头像               │
│  ┌───────────────────┐      │
│  │                   │      │
│  │   [头像图片]      │      │ ← 200x200，圆角16px
│  │   或 👤          │      │
│  │                   │      │
│  └───────────────────┘      │
│                             │
│  [上传头像] [删除]           │ ← 按钮
│  状态信息...                │ ← 上传状态
│                             │
│  支持 JPG、PNG、GIF 等格式   │
│  图片将自动裁剪为正方形       │
└─────────────────────────────┘
```

### 状态提示

- **上传中...** - 正在处理
- **上传成功！** - 绿色，3秒后消失
- **删除中...** - 正在删除
- **已删除** - 绿色，3秒后消失
- **错误信息** - 灰色，显示具体原因

---

## 🔧 技术细节

### 后端API

#### 上传头像
```
POST /api/characters/{role}/avatar
Content-Type: multipart/form-data

Body: 
  file: [图片文件]

Response:
{
  "ok": true,
  "avatar_url": "/avatars/user_5_角色名.jpg",
  "message": "头像上传成功"
}
```

#### 删除头像
```
DELETE /api/characters/{role}/avatar

Response:
{
  "ok": true,
  "message": "头像已删除"
}
```

### 图片处理流程

1. **上传** → 2. **验证** → 3. **读取** → 4. **转RGB** → 5. **裁剪** → 6. **缩放** → 7. **保存** → 8. **更新数据库**

```python
# 自动处理步骤
1. 验证文件类型和大小
2. 转换为RGB（处理透明背景）
3. 中心裁剪为正方形
4. 缩放到256x256
5. 保存为JPEG (quality=85)
6. 更新数据库avatar_url字段
7. 清除Redis缓存
```

### 存储位置

- **文件**: `/home/changan/MyProject/FastNPC/Avatars/user_{用户ID}_{角色名}.jpg`
- **数据库**: `characters.avatar_url` 字段
- **URL**: `http://localhost:8000/avatars/user_5_角色名.jpg`

---

## 🎯 常见问题

### Q1: 上传后侧边栏没有立即更新？

**A**: 关闭配置页面，在主页面刷新一下（F5）即可看到新头像。

### Q2: 上传失败？

**A**: 检查：
1. 文件是否为图片格式
2. 文件大小是否超过10MB
3. 后端服务是否正常运行
4. 浏览器控制台是否有错误

### Q3: 头像显示不清晰？

**A**: 上传更高分辨率的原图。系统会自动缩放到256x256，但原图分辨率越高，效果越好。

### Q4: 可以上传动图吗？

**A**: 可以上传GIF，但会被转换为静态JPEG图片。

### Q5: 头像会同步到其他地方吗？

**A**: 是的！头像会自动显示在：
- ✅ 侧边栏角色列表
- ✅ 角色配置页面
- ✅ 未来的群聊界面（规划中）

---

## 🔄 更新头像

要更换头像，只需：
1. 再次上传新图片
2. 系统会自动覆盖旧头像
3. 立即生效

---

## 📝 注意事项

### ⚠️ 重要

1. **文件名规范**: 系统会自动处理文件名，不需要手动重命名
2. **图片质量**: 建议上传至少 512x512 像素的图片，裁剪后效果更好
3. **透明背景**: PNG透明背景会自动转换为白色背景
4. **缓存问题**: 如果头像没更新，强制刷新浏览器（Ctrl+Shift+R）

### ✅ 最佳实践

- 📐 **正方形图片** - 上传前预先裁剪为正方形，效果最好
- 🎨 **清晰图片** - 选择高质量、清晰的图片
- 📊 **适当大小** - 500KB - 2MB 的图片最合适
- 🖼️ **人物居中** - 确保人物位于图片中心，避免被裁剪

---

## 🎨 UI美化建议

### 当前样式
- 200x200 显示尺寸
- 圆角16px（圆角正方形）
- 边框2px (#e5e7eb)
- 灰色背景 (#f9fafb)

### 拖拽效果
- 拖入时：蓝色边框 + 淡蓝背景
- 拖出时：恢复原样

---

## 🛠️ 开发者信息

### 相关文件

#### 后端
- `fastnpc/api/routes/avatar_routes.py` - 头像管理API
- `fastnpc/utils/image_utils.py` - 图片处理工具
- `fastnpc/api/server.py` - 路由注册

#### 前端
- `fastnpc/web/templates/partials/structured_editor.html` - 配置页面模板

#### 数据库
- `characters.avatar_url` - 头像URL字段

### API端点

```python
# 注册的路由
app.include_router(avatar_router)  # 头像管理路由

# 端点
POST   /api/characters/{role}/avatar   # 上传
DELETE /api/characters/{role}/avatar   # 删除
```

---

## 📊 完整流程图

```
┌──────────────┐
│  用户操作    │
└──────┬───────┘
       │
       ├─ 点击/拖拽上传
       │     │
       │     ├─ 选择文件
       │     ├─ 验证（类型、大小）
       │     ├─ 上传到服务器
       │     │
       │     ├─ 后端处理:
       │     │   ├─ 读取图片
       │     │   ├─ 转RGB
       │     │   ├─ 裁剪正方形
       │     │   ├─ 缩放256x256
       │     │   ├─ 保存JPEG
       │     │   ├─ 更新数据库
       │     │   └─ 清除缓存
       │     │
       │     └─ 返回新URL
       │
       ├─ 点击删除
       │     │
       │     ├─ 确认对话框
       │     ├─ 删除文件
       │     ├─ 更新数据库
       │     └─ 清除缓存
       │
       └─ 加载页面
             │
             ├─ 获取角色数据
             ├─ 检查avatar_url
             └─ 显示头像/默认图标
```

---

## 🎉 享受新功能！

现在您可以为每个角色上传独特的头像，让您的NPC更加生动！

**问题反馈**: 如有问题，请查看后端日志或浏览器控制台。

---

**版本**: v1.2.0  
**更新日期**: 2025-10-18  
**作者**: FastNPC Team

