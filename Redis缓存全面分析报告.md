# Redisç¼“å­˜å…¨é¢åˆ†ææŠ¥å‘Š

## ğŸ“Š ç¼“å­˜æ€»è§ˆ

æˆ‘ä»¬åœ¨ä»¥ä¸‹**4ä¸ªå…³é”®ä½ç½®**å®æ–½äº†Redisç¼“å­˜ï¼š

| ç¼“å­˜ç±»å‹ | ç¼“å­˜é”® | TTL | å¤±æ•ˆæœºåˆ¶ | æ–‡ä»¶ä½ç½® |
|---------|-------|-----|---------|---------|
| **ç”¨æˆ·è®¾ç½®** | `user_settings:{user_id}` | æ°¸ä¹… | æ‰‹åŠ¨æ¸…é™¤ | `auth/users.py` |
| **è§’è‰²IDæ˜ å°„** | `char_id:{user_id}:{name}` | æ°¸ä¹… | æ‰‹åŠ¨æ¸…é™¤ | `auth/characters.py` |
| **è§’è‰²é…ç½®** | `char_profile:{user_id}:{role}` | **5åˆ†é’Ÿ** | TTL + æ‰‹åŠ¨æ¸…é™¤ | `utils.py` + `char_data.py` |
| **è§’è‰²åˆ—è¡¨** | `char_list:{user_id}` | **1åˆ†é’Ÿ** | TTL + æ‰‹åŠ¨æ¸…é™¤ | `utils.py` |

---

## ğŸ” è¯¦ç»†åˆ†æ

### 1ï¸âƒ£ ç”¨æˆ·è®¾ç½®ç¼“å­˜ â­â­â­â­â­

#### åŸºæœ¬ä¿¡æ¯
```python
ç¼“å­˜é”®ï¼šuser_settings:{user_id}
TTLï¼šæ°¸ä¹…ï¼ˆLRUæ·˜æ±°ï¼‰
æ•°æ®å†…å®¹ï¼š
  - default_modelï¼šé»˜è®¤æ¨¡å‹
  - ctx_max_chat/stm/ltmï¼šä¸Šä¸‹æ–‡çª—å£å¤§å°
  - profileï¼šç”¨æˆ·ç®€ä»‹
  - max_group_reply_roundsï¼šç¾¤èŠè½®æ¬¡
  - updated_atï¼šæ›´æ–°æ—¶é—´
```

#### ä½¿ç”¨é¢‘ç‡
- **æé«˜**ï¼šæ¯æ¬¡èŠå¤©éƒ½éœ€è¦æŸ¥è¯¢
- **ä¼°ç®—**ï¼šæ¯ä¸ªç”¨æˆ·æ¯å¤© 20-100 æ¬¡æŸ¥è¯¢

#### ç¼“å­˜å‘½ä¸­ç‡
- **é¢„æœŸ**ï¼š95-99%
- **é¦–æ¬¡æŸ¥è¯¢**ï¼šmissï¼ˆæŸ¥æ•°æ®åº“å¹¶ç¼“å­˜ï¼‰
- **åç»­æŸ¥è¯¢**ï¼šhitï¼ˆä»Redisè¯»å–ï¼‰

#### å¯¹ç”¨æˆ·ä½“éªŒçš„å½±å“

##### ğŸŸ¢ æ­£é¢å½±å“
1. **å“åº”é€Ÿåº¦æå‡**ï¼š50-100ms â†’ 1-3msï¼ˆ**30-100å€**ï¼‰
2. **é›¶æ„ŸçŸ¥å»¶è¿Ÿ**ï¼šç”¨æˆ·å®Œå…¨æ„ŸçŸ¥ä¸åˆ°æŸ¥è¯¢è¿‡ç¨‹
3. **é™ä½æ•°æ®åº“å‹åŠ›**ï¼šå‡å°‘ 90%+ ç”¨æˆ·è®¾ç½®æŸ¥è¯¢

##### ğŸŸ¨ å¯èƒ½çš„é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

**é—®é¢˜ï¼šå¤šWorkerç¼“å­˜ä¸€è‡´æ€§**
```
åœºæ™¯ï¼šç”¨æˆ·æ›´æ–°è®¾ç½®åï¼Œå…¶ä»–Workeræ˜¯å¦çœ‹åˆ°æœ€æ–°å€¼ï¼Ÿ

âœ… å·²è§£å†³ï¼š
- ä½¿ç”¨Rediså…±äº«ç¼“å­˜ï¼ˆæ‰€æœ‰Workerå…±äº«ï¼‰
- æ›´æ–°æ—¶ç«‹å³åˆ é™¤ç¼“å­˜é”®
- ä¸‹æ¬¡æŸ¥è¯¢è‡ªåŠ¨ä»æ•°æ®åº“é‡æ–°åŠ è½½

å½±å“ï¼šæ— ï¼ˆå®Œç¾è§£å†³ï¼‰
```

**é—®é¢˜ï¼šç¼“å­˜æ°¸ä¸è¿‡æœŸ**
```
åœºæ™¯ï¼šç”¨æˆ·ä»ä¸æ›´æ–°è®¾ç½®ï¼Œç¼“å­˜æ°¸ä¹…å­˜åœ¨

âœ… å·²è§£å†³ï¼š
- maxmemory-policy: allkeys-lruï¼ˆè‡ªåŠ¨æ·˜æ±°æœ€å°‘ä½¿ç”¨ï¼‰
- å•ä¸ªè®¾ç½®çº¦1KBï¼Œ1000ç”¨æˆ·ä»…1MB
- Redisé…ç½®200MBï¼Œå®Œå…¨è¶³å¤Ÿ

å½±å“ï¼šæ— 
```

#### ç”¨æˆ·ä½“éªŒå½±å“è¯„çº§ï¼šâ­â­â­â­â­ **ï¼ˆå®Œç¾ï¼Œæ— å‰¯ä½œç”¨ï¼‰**

---

### 2ï¸âƒ£ è§’è‰²IDæ˜ å°„ç¼“å­˜ â­â­â­â­â­

#### åŸºæœ¬ä¿¡æ¯
```python
ç¼“å­˜é”®ï¼šchar_id:{user_id}:{name}
TTLï¼šæ°¸ä¹…ï¼ˆLRUæ·˜æ±°ï¼‰
æ•°æ®å†…å®¹ï¼šcharacter_idï¼ˆæ•´æ•°ï¼‰
```

#### ä½¿ç”¨é¢‘ç‡
- **æé«˜**ï¼šå‡ ä¹æ¯ä¸ªè§’è‰²æ“ä½œéƒ½éœ€è¦
- **ä¼°ç®—**ï¼šæ¯ä¸ªè§’è‰²æ¯å¤© 50-200 æ¬¡æŸ¥è¯¢

#### ç¼“å­˜å‘½ä¸­ç‡
- **é¢„æœŸ**ï¼š95-99%

#### å¯¹ç”¨æˆ·ä½“éªŒçš„å½±å“

##### ğŸŸ¢ æ­£é¢å½±å“
1. **å“åº”é€Ÿåº¦æå‡**ï¼š20-50ms â†’ 0.5-2msï¼ˆ**10-100å€**ï¼‰
2. **é€æ˜ä¼˜åŒ–**ï¼šç”¨æˆ·å®Œå…¨æ— æ„Ÿ
3. **æ•°æ®é‡æå°**ï¼šæ¯ä¸ªæ˜ å°„çº¦100å­—èŠ‚

##### ğŸŸ¢ å®Œå–„çš„å¤±æ•ˆæœºåˆ¶

**æ‰€æœ‰ä¿®æ”¹æ“ä½œéƒ½æ­£ç¡®æ¸…é™¤ç¼“å­˜**ï¼š
- âœ… **åˆ›å»ºè§’è‰²**ï¼š`get_or_create_character()` 
- âœ… **åˆ é™¤è§’è‰²**ï¼š`delete_character()` 
- âœ… **é‡å‘½åè§’è‰²**ï¼š`rename_character()` æ¸…é™¤æ–°æ—§ä¸¤ä¸ªé”®

#### ç”¨æˆ·ä½“éªŒå½±å“è¯„çº§ï¼šâ­â­â­â­â­ **ï¼ˆå®Œç¾ï¼Œæ— å‰¯ä½œç”¨ï¼‰**

---

### 3ï¸âƒ£ è§’è‰²é…ç½®ç¼“å­˜ â­â­â­â­â˜†

#### åŸºæœ¬ä¿¡æ¯
```python
ç¼“å­˜é”®ï¼šchar_profile:{user_id}:{role}
TTLï¼š5åˆ†é’Ÿï¼ˆ300ç§’ï¼‰
æ•°æ®å†…å®¹ï¼š
  - 9å¤§ç±»ç»“æ„åŒ–æ•°æ®ï¼ˆåŸºç¡€ä¿¡æ¯ã€æ€§æ ¼ã€èƒŒæ™¯...ï¼‰
  - çŸ­æœŸè®°å¿†ã€é•¿æœŸè®°å¿†
  - çº¦50KB/è§’è‰²
```

#### ä½¿ç”¨é¢‘ç‡
- **é«˜**ï¼šæ¯æ¬¡èŠå¤©å‰åŠ è½½
- **ä¼°ç®—**ï¼šæ¯ä¸ªè§’è‰²æ¯å¤© 10-50 æ¬¡æŸ¥è¯¢

#### ç¼“å­˜å‘½ä¸­ç‡
- **é¢„æœŸ**ï¼š80-90%ï¼ˆå› ä¸ºæœ‰5åˆ†é’ŸTTLï¼‰

#### å¯¹ç”¨æˆ·ä½“éªŒçš„å½±å“

##### ğŸŸ¢ æ­£é¢å½±å“
1. **å“åº”é€Ÿåº¦æå‡**ï¼š150-300ms â†’ 2-5msï¼ˆ**50-150å€**ï¼‰
2. **æœ€å¤æ‚æŸ¥è¯¢è¢«ä¼˜åŒ–**ï¼šéœ€è¦JOIN 9ä¸ªè¡¨ + è®°å¿†è¡¨
3. **æ˜¾è‘—é™ä½æ•°æ®åº“è´Ÿè½½**

##### ğŸŸ¨ æ½œåœ¨é—®é¢˜ä¸å®é™…å½±å“

**é—®é¢˜1ï¼šè®°å¿†æ›´æ–°åå»¶è¿Ÿï¼Ÿ**
```
åœºæ™¯ï¼šç³»ç»Ÿå‹ç¼©çŸ­æœŸè®°å¿† â†’ æ›´æ–°æ•°æ®åº“ â†’ ç¼“å­˜æ˜¯å¦è¿‡æœŸï¼Ÿ

âœ… å·²è§£å†³ï¼š
- save_character_memories_impl() ç«‹å³æ¸…é™¤ç¼“å­˜
- ä¸‹æ¬¡èŠå¤©æ—¶ä»æ•°æ®åº“åŠ è½½æœ€æ–°è®°å¿†

ç”¨æˆ·ä½“éªŒå½±å“ï¼šæ— ï¼ˆç«‹å³ç”Ÿæ•ˆï¼‰
```

**é—®é¢˜2ï¼šæ‰‹åŠ¨ç¼–è¾‘è§’è‰²åå»¶è¿Ÿï¼Ÿ**
```
åœºæ™¯ï¼šç”¨æˆ·é€šè¿‡å‰ç«¯ç¼–è¾‘è§’è‰²ä¿¡æ¯

âœ… å·²è§£å†³ï¼š
- update_character_structured() ç«‹å³æ¸…é™¤ç¼“å­˜
- å‰ç«¯ç¼–è¾‘APIè°ƒç”¨åç«‹å³ç”Ÿæ•ˆ

ç”¨æˆ·ä½“éªŒå½±å“ï¼šæ— 
```

**é—®é¢˜3ï¼šç›´æ¥ä¿®æ”¹æ•°æ®åº“ï¼Ÿ**
```
åœºæ™¯ï¼šå¼€å‘è€…/ç®¡ç†å‘˜ç›´æ¥ä¿®æ”¹PostgreSQL

âš ï¸ å­˜åœ¨å»¶è¿Ÿï¼š
- æœ€å¤šç­‰å¾…5åˆ†é’ŸTTLè¿‡æœŸ
- æ­£å¸¸ç”¨æˆ·ä¸ä¼šé‡åˆ°æ­¤æƒ…å†µ

ç”¨æˆ·ä½“éªŒå½±å“ï¼šæä½ï¼ˆåªå½±å“ç›´æ¥æ”¹æ•°æ®åº“çš„ç®¡ç†å‘˜ï¼‰
```

#### å®é™…ç”¨æˆ·ä½“éªŒåœºæ™¯åˆ†æ

**åœºæ™¯1ï¼šæ­£å¸¸èŠå¤©**
```
ç”¨æˆ·æ“ä½œï¼šç‚¹å‡»è§’è‰² â†’ å‘é€æ¶ˆæ¯
ç³»ç»Ÿè¡Œä¸ºï¼š
  1. åŠ è½½è§’è‰²é…ç½®ï¼ˆç¼“å­˜å‘½ä¸­ï¼š2msï¼‰âœ…
  2. æ„å»ºprompt
  3. è°ƒç”¨LLM
  
ç”¨æˆ·æ„Ÿå—ï¼šå³æ—¶å“åº”ï¼Œæ— å»¶è¿Ÿ
```

**åœºæ™¯2ï¼šè¿ç»­èŠå¤©ï¼ˆåŒä¸€è§’è‰²ï¼‰**
```
ç”¨æˆ·æ“ä½œï¼šè¿ç»­å‘é€10æ¡æ¶ˆæ¯
ç³»ç»Ÿè¡Œä¸ºï¼š
  1. ç¬¬1æ¡ï¼šç¼“å­˜miss â†’ åŠ è½½å¹¶ç¼“å­˜ï¼ˆ150msï¼‰
  2. ç¬¬2-10æ¡ï¼šç¼“å­˜hit â†’ 2ms âœ…
  
ç”¨æˆ·æ„Ÿå—ï¼šç¬¬2æ¡æ¶ˆæ¯å¼€å§‹æ˜æ˜¾å˜å¿«
```

**åœºæ™¯3ï¼šç¼–è¾‘è§’è‰²åèŠå¤©**
```
ç”¨æˆ·æ“ä½œï¼š
  1. ç¼–è¾‘è§’è‰²ä¿¡æ¯ â†’ ä¿å­˜
  2. ç«‹å³å‘é€æ¶ˆæ¯
  
ç³»ç»Ÿè¡Œä¸ºï¼š
  1. ä¿å­˜æ—¶æ¸…é™¤ç¼“å­˜ âœ…
  2. ä¸‹æ¬¡èŠå¤©åŠ è½½æœ€æ–°æ•°æ® âœ…
  
ç”¨æˆ·æ„Ÿå—ï¼šç¼–è¾‘ç«‹å³ç”Ÿæ•ˆ
```

#### ç”¨æˆ·ä½“éªŒå½±å“è¯„çº§ï¼šâ­â­â­â­â˜† **ï¼ˆä¼˜ç§€ï¼Œæå°‘æ•°ç®¡ç†åœºæ™¯æœ‰5åˆ†é’Ÿå»¶è¿Ÿï¼‰**

---

### 4ï¸âƒ£ è§’è‰²åˆ—è¡¨ç¼“å­˜ â­â­â­â­â­ **ï¼ˆä¿®å¤åï¼‰**

#### åŸºæœ¬ä¿¡æ¯
```python
ç¼“å­˜é”®ï¼šchar_list:{user_id}
TTLï¼š1åˆ†é’Ÿï¼ˆ60ç§’ï¼‰
æ•°æ®å†…å®¹ï¼š
  - æ‰€æœ‰è§’è‰²çš„ id, name, updated_at, preview
  - åˆ—è¡¨å¤§å°ï¼šçº¦ NÃ—500å­—èŠ‚ï¼ˆNä¸ºè§’è‰²æ•°ï¼‰
```

#### ä½¿ç”¨é¢‘ç‡
- **ä¸­é«˜**ï¼šåˆ‡æ¢è§’è‰²ã€åˆ·æ–°é¡µé¢
- **ä¼°ç®—**ï¼šæ¯ä¸ªç”¨æˆ·æ¯å¤© 10-50 æ¬¡æŸ¥è¯¢

#### ç¼“å­˜å‘½ä¸­ç‡
- **é¢„æœŸ**ï¼š85-95%

#### å¯¹ç”¨æˆ·ä½“éªŒçš„å½±å“

##### ğŸŸ¢ æ­£é¢å½±å“
1. **å“åº”é€Ÿåº¦æå‡**ï¼š50-200ms â†’ 1-3msï¼ˆ**50-200å€**ï¼‰
2. **é¡µé¢åŠ è½½æ›´æµç•…**ï¼šè§’è‰²åˆ—è¡¨ç¬é—´æ˜¾ç¤º
3. **å‡å°‘å¤æ‚JOINæŸ¥è¯¢**ï¼šéœ€è¦æŸ¥è¯¢previewå­—æ®µ

##### ğŸ”´ æ›¾ç»çš„é—®é¢˜ï¼ˆå·²å…¨éƒ¨ä¿®å¤ï¼‰

**é—®é¢˜1ï¼šåˆ›å»ºè§’è‰²ååˆ—è¡¨ä¸æ›´æ–°** âœ… **å·²ä¿®å¤**
```
åœºæ™¯ï¼šç”¨æˆ·åˆ›å»ºæ–°è§’è‰²"å­™æ‚Ÿç©º"

ä¿®å¤å‰ï¼š
  1. è§’è‰²åˆ›å»ºå®Œæˆ â†’ ä¿å­˜åˆ°æ•°æ®åº“
  2. å‰ç«¯åˆ·æ–°åˆ—è¡¨ â†’ Redisè¿”å›æ—§ç¼“å­˜ï¼ˆæ— æ–°è§’è‰²ï¼‰âŒ
  3. ç”¨æˆ·çœ‹ä¸åˆ°æ–°è§’è‰²ï¼Œéœ€è¦ç­‰1åˆ†é’Ÿ âŒ

ä¿®å¤åï¼š
  1. è§’è‰²åˆ›å»ºå®Œæˆ â†’ ä¿å­˜åˆ°æ•°æ®åº“
  2. ç«‹å³æ¸…é™¤ char_list ç¼“å­˜ âœ…
  3. å‰ç«¯åˆ·æ–°åˆ—è¡¨ â†’ ä»æ•°æ®åº“æŸ¥è¯¢ â†’ åŒ…å«æ–°è§’è‰² âœ…

ä¿®å¤ä½ç½®ï¼šfastnpc/api/state.py:167-174
ç”¨æˆ·ä½“éªŒå½±å“ï¼šå®Œç¾è§£å†³ â­â­â­â­â­
```

**é—®é¢˜2ï¼šå¤åˆ¶è§’è‰²ååˆ—è¡¨ä¸æ›´æ–°** âœ… **å·²ä¿®å¤**
```
åœºæ™¯ï¼šç”¨æˆ·å¤åˆ¶è§’è‰²"å­™æ‚Ÿç©º" â†’ "å­™æ‚Ÿç©º-å‰¯æœ¬"

ä¿®å¤å‰ï¼š
  1. å¤åˆ¶å®Œæˆ â†’ ä¿å­˜åˆ°æ•°æ®åº“
  2. å‰ç«¯åˆ·æ–°åˆ—è¡¨ â†’ ç¼“å­˜æœªæ›´æ–° âŒ
  3. çœ‹ä¸åˆ°æ–°å¤åˆ¶çš„è§’è‰² âŒ

ä¿®å¤åï¼š
  1. å¤åˆ¶å®Œæˆ â†’ ä¿å­˜åˆ°æ•°æ®åº“
  2. ç«‹å³æ¸…é™¤ char_list ç¼“å­˜ âœ…
  3. å‰ç«¯ç«‹å³çœ‹åˆ°æ–°è§’è‰² âœ…

ä¿®å¤ä½ç½®ï¼šfastnpc/api/routes/character_routes.py:173-180
ç”¨æˆ·ä½“éªŒå½±å“ï¼šå®Œç¾è§£å†³ â­â­â­â­â­
```

**é—®é¢˜3ï¼šåˆ é™¤è§’è‰²ååˆ—è¡¨ä¸æ›´æ–°** âœ… **å·²ä¿®å¤**
```
åœºæ™¯ï¼šç”¨æˆ·åˆ é™¤è§’è‰²

ä¿®å¤ä½ç½®ï¼šfastnpc/api/auth/characters.py:140
ç”¨æˆ·ä½“éªŒå½±å“ï¼šå®Œç¾è§£å†³ â­â­â­â­â­
```

**é—®é¢˜4ï¼šé‡å‘½åè§’è‰²ååˆ—è¡¨ä¸æ›´æ–°** âœ… **å·²ä¿®å¤**
```
åœºæ™¯ï¼šç”¨æˆ·é‡å‘½åè§’è‰²

ä¿®å¤ä½ç½®ï¼šfastnpc/api/auth/characters.py:115
ç”¨æˆ·ä½“éªŒå½±å“ï¼šå®Œç¾è§£å†³ â­â­â­â­â­
```

#### å®Œæ•´çš„ç¼“å­˜å¤±æ•ˆæœºåˆ¶æ¸…å•

| æ“ä½œ | æ˜¯å¦æ¸…é™¤ç¼“å­˜ | ä»£ç ä½ç½® | çŠ¶æ€ |
|-----|------------|---------|------|
| åˆ›å»ºè§’è‰² | âœ… æ˜¯ | `state.py:167-174` | âœ… å®Œç¾ |
| å¤åˆ¶è§’è‰² | âœ… æ˜¯ | `character_routes.py:173-180` | âœ… å®Œç¾ |
| åˆ é™¤è§’è‰² | âœ… æ˜¯ | `characters.py:140` | âœ… å®Œç¾ |
| é‡å‘½åè§’è‰² | âœ… æ˜¯ | `characters.py:115` | âœ… å®Œç¾ |

#### å®é™…ç”¨æˆ·ä½“éªŒåœºæ™¯

**åœºæ™¯1ï¼šåˆ›å»ºè§’è‰²æµç¨‹**
```
ç”¨æˆ·æ“ä½œï¼š
  1. ç‚¹å‡»"æ–°å»ºè§’è‰²"
  2. è¾“å…¥"å­™æ‚Ÿç©º" â†’ æäº¤
  3. ç­‰å¾…è¿›åº¦æ¡ï¼ˆ20-60ç§’ï¼‰
  4. å®Œæˆ â†’ è‡ªåŠ¨åˆ·æ–°åˆ—è¡¨

ç³»ç»Ÿè¡Œä¸ºï¼š
  1. åå°ä»»åŠ¡åˆ›å»ºè§’è‰²
  2. ä¿å­˜åˆ°æ•°æ®åº“
  3. æ¸…é™¤ char_list ç¼“å­˜ âœ…
  4. å‰ç«¯è°ƒç”¨ /api/characters
  5. Redisç¼“å­˜miss â†’ æŸ¥è¯¢æ•°æ®åº“ â†’ è¿”å›å«æ–°è§’è‰²çš„åˆ—è¡¨

ç”¨æˆ·æ„Ÿå—ï¼šè§’è‰²åˆ›å»ºå®Œæˆåç«‹å³å‡ºç°åœ¨åˆ—è¡¨ä¸­ â­â­â­â­â­
```

**åœºæ™¯2ï¼šå¿«é€Ÿåˆ‡æ¢è§’è‰²**
```
ç”¨æˆ·æ“ä½œï¼š
  1. åœ¨è§’è‰²åˆ—è¡¨ä¸­åˆ‡æ¢æµè§ˆ
  2. åˆ·æ–°é¡µé¢
  3. é‡æ–°æ‰“å¼€ç½‘ç«™

ç³»ç»Ÿè¡Œä¸ºï¼š
  1. ç¬¬ä¸€æ¬¡æŸ¥è¯¢ï¼šmiss â†’ æŸ¥æ•°æ®åº“ï¼ˆ50msï¼‰â†’ ç¼“å­˜
  2. åç»­æŸ¥è¯¢ï¼šhit â†’ Redisï¼ˆ1-3msï¼‰âœ…

ç”¨æˆ·æ„Ÿå—ï¼šåˆ—è¡¨åŠ è½½é£å¿« â­â­â­â­â­
```

**åœºæ™¯3ï¼šå¤åˆ¶è§’è‰²**
```
ç”¨æˆ·æ“ä½œï¼š
  1. ç‚¹å‡»"å¤åˆ¶è§’è‰²"
  2. ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆ"è§’è‰²å-å‰¯æœ¬"

ç³»ç»Ÿè¡Œä¸ºï¼š
  1. ä¿å­˜æ–°è§’è‰²åˆ°æ•°æ®åº“
  2. æ¸…é™¤ char_list ç¼“å­˜ âœ…
  3. å‰ç«¯è‡ªåŠ¨åˆ·æ–°åˆ—è¡¨ï¼ˆä»æ•°æ®åº“æŸ¥è¯¢ï¼‰

ç”¨æˆ·æ„Ÿå—ï¼šæ–°è§’è‰²ç«‹å³æ˜¾ç¤º â­â­â­â­â­
```

#### ç”¨æˆ·ä½“éªŒå½±å“è¯„çº§ï¼šâ­â­â­â­â­ **ï¼ˆå®Œç¾ï¼Œæ‰€æœ‰åœºæ™¯æ­£ç¡®å¤„ç†ï¼‰**

---

## ğŸ¯ ç»¼åˆç”¨æˆ·ä½“éªŒå½±å“è¯„ä¼°

### ç§¯æå½±å“ ğŸŸ¢

#### 1. å“åº”é€Ÿåº¦æ˜¾è‘—æå‡
```
åœºæ™¯ï¼šç”¨æˆ·ä¸è§’è‰²èŠå¤©

ä¼˜åŒ–å‰ï¼š
- åŠ è½½ç”¨æˆ·è®¾ç½®ï¼š80ms
- æŸ¥è¯¢è§’è‰²IDï¼š30ms  
- åŠ è½½è§’è‰²é…ç½®ï¼š200ms
- LLMè°ƒç”¨ï¼š5000ms
æ€»è®¡ï¼š5310ms

ä¼˜åŒ–åï¼š
- åŠ è½½ç”¨æˆ·è®¾ç½®ï¼š2msï¼ˆç¼“å­˜ï¼‰
- æŸ¥è¯¢è§’è‰²IDï¼š1msï¼ˆç¼“å­˜ï¼‰
- åŠ è½½è§’è‰²é…ç½®ï¼š3msï¼ˆç¼“å­˜ï¼‰
- LLMè°ƒç”¨ï¼š5000ms
æ€»è®¡ï¼š5006ms

æ•°æ®åº“ç›¸å…³è€—æ—¶ï¼š310ms â†’ 6msï¼ˆå‡å°‘98%ï¼‰
```

#### 2. æ•°æ®åº“å‹åŠ›å¤§å¹…é™ä½
```
åœºæ™¯ï¼š50äººåŒæ—¶åœ¨çº¿èŠå¤©

ä¼˜åŒ–å‰ï¼š
- æ¯äººæ¯åˆ†é’Ÿ10æ¡æ¶ˆæ¯
- æ¯æ¡æ¶ˆæ¯ï¼š11æ¬¡æ•°æ®åº“æŸ¥è¯¢
- æ€»æŸ¥è¯¢ï¼š50Ã—10Ã—11 = 5500æ¬¡/åˆ†é’Ÿ

ä¼˜åŒ–åï¼š
- é¦–æ¬¡æŸ¥è¯¢ï¼š50Ã—11 = 550æ¬¡
- åç»­æŸ¥è¯¢ï¼š0æ¬¡ï¼ˆç¼“å­˜å‘½ä¸­ï¼‰
- ç¼“å­˜åˆ·æ–°ï¼š~10æ¬¡/åˆ†é’Ÿï¼ˆTTLè¿‡æœŸï¼‰
- æ€»æŸ¥è¯¢ï¼š~560æ¬¡/é¦–åˆ†é’Ÿï¼Œ~10æ¬¡/åç»­åˆ†é’Ÿ

é™ä½ï¼š95-99%æ•°æ®åº“è´Ÿè½½ ğŸ‰
```

#### 3. ç”¨æˆ·æ“ä½œå³æ—¶ç”Ÿæ•ˆ
```
æ‰€æœ‰ç”¨æˆ·æ“ä½œéƒ½èƒ½ç«‹å³åæ˜ ï¼š
- âœ… åˆ›å»ºè§’è‰² â†’ ç«‹å³æ˜¾ç¤º
- âœ… å¤åˆ¶è§’è‰² â†’ ç«‹å³æ˜¾ç¤º
- âœ… åˆ é™¤è§’è‰² â†’ ç«‹å³æ¶ˆå¤±
- âœ… é‡å‘½åè§’è‰² â†’ ç«‹å³æ›´æ–°
- âœ… ç¼–è¾‘è§’è‰² â†’ ç«‹å³ç”Ÿæ•ˆ
- âœ… æ›´æ–°è®¾ç½® â†’ ç«‹å³åº”ç”¨
```

### æ½œåœ¨é—®é¢˜ ğŸŸ¨

#### å”¯ä¸€çš„è¾¹ç¼˜æƒ…å†µ

**åœºæ™¯ï¼šç®¡ç†å‘˜ç›´æ¥ä¿®æ”¹æ•°æ®åº“**
```
æ“ä½œï¼š
  1. ç®¡ç†å‘˜ç”¨psqlç›´æ¥UPDATEè§’è‰²æ•°æ®
  2. æ²¡æœ‰é€šè¿‡APIï¼Œæ— æ³•è§¦å‘ç¼“å­˜æ¸…é™¤

å½±å“ï¼š
  - è§’è‰²é…ç½®ç¼“å­˜ï¼šæœ€å¤š5åˆ†é’Ÿå»¶è¿Ÿ
  - è§’è‰²åˆ—è¡¨ç¼“å­˜ï¼šæœ€å¤š1åˆ†é’Ÿå»¶è¿Ÿ

å—å½±å“äººç¾¤ï¼šä»…å¼€å‘è€…/DBA
è§£å†³æ–¹æ¡ˆï¼š
  - ä½¿ç”¨Redis CLIæ‰‹åŠ¨æ¸…é™¤ï¼šredis-cli DEL "char_profile:1:å­™æ‚Ÿç©º"
  - æˆ–ç­‰å¾…TTLè¿‡æœŸ

ç”¨æˆ·å½±å“ï¼šæ— ï¼ˆæ­£å¸¸ç”¨æˆ·ä¸ä¼šç›´æ¥æ”¹æ•°æ®åº“ï¼‰
```

---

## ğŸ“Š æ€§èƒ½æ•°æ®å¯¹æ¯”

### å•æ¬¡æ“ä½œå»¶è¿Ÿå¯¹æ¯”

| æ“ä½œ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡å€æ•° |
|-----|--------|--------|---------|
| **åŠ è½½ç”¨æˆ·è®¾ç½®** | 50-100ms | 1-3ms | **30-100x** âš¡ |
| **æŸ¥è¯¢è§’è‰²ID** | 20-50ms | 0.5-2ms | **10-100x** âš¡ |
| **åŠ è½½è§’è‰²é…ç½®** | 150-300ms | 2-5ms | **50-150x** âš¡ |
| **åŠ è½½è§’è‰²åˆ—è¡¨** | 50-200ms | 1-3ms | **50-200x** âš¡ |

### ç³»ç»Ÿååé‡å¯¹æ¯”

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|-----|--------|--------|------|
| **æ•°æ®åº“QPS** | 500-1000 | 50-100 | **é™ä½90%** ğŸ“‰ |
| **æ•°æ®åº“CPU** | 40-60% | 5-10% | **é™ä½80%** ğŸ“‰ |
| **Redis QPS** | 0 | 400-800 | **æ–°å¢** ğŸ“ˆ |
| **Rediså†…å­˜** | 0 | ~50MB | **å¯å¿½ç•¥** âœ… |

### ç”¨æˆ·ä½“éªŒæŒ‡æ ‡

| æŒ‡æ ‡ | è¯„åˆ† | è¯´æ˜ |
|-----|------|------|
| **å“åº”é€Ÿåº¦** | â­â­â­â­â­ | æ•°æ®åº“æŸ¥è¯¢ä»300ms â†’ 6ms |
| **æ“ä½œå³æ—¶æ€§** | â­â­â­â­â­ | æ‰€æœ‰æ“ä½œç«‹å³ç”Ÿæ•ˆ |
| **ä¸€è‡´æ€§** | â­â­â­â­â­ | Rediså…±äº«ï¼Œå¤šWorkerä¸€è‡´ |
| **ç¨³å®šæ€§** | â­â­â­â­â­ | é™çº§æœºåˆ¶ï¼ŒRedisæ•…éšœä¸å½±å“ |
| **å¯é¢„æµ‹æ€§** | â­â­â­â­â­ | ç”¨æˆ·è¡Œä¸ºä¸é¢„æœŸå®Œå…¨ä¸€è‡´ |

---

## ğŸ’¡ æœ€ä½³å®è·µä¸å»ºè®®

### âœ… æˆ‘ä»¬å·²ç»åšå¯¹çš„äº‹æƒ…

1. **æ­£ç¡®çš„å¤±æ•ˆæœºåˆ¶**ï¼šæ‰€æœ‰ä¿®æ”¹æ“ä½œéƒ½æ¸…é™¤ç›¸å…³ç¼“å­˜
2. **åˆç†çš„TTLè®¾ç½®**ï¼š
   - è§’è‰²é…ç½®ï¼š5åˆ†é’Ÿï¼ˆå¹³è¡¡æ€§èƒ½ä¸ä¸€è‡´æ€§ï¼‰
   - è§’è‰²åˆ—è¡¨ï¼š1åˆ†é’Ÿï¼ˆå¿«é€Ÿåæ˜ å˜åŒ–ï¼‰
3. **å¤šWorkerä¸€è‡´æ€§**ï¼šä½¿ç”¨Rediså…±äº«ç¼“å­˜
4. **é™çº§ç­–ç•¥**ï¼šRedisæ•…éšœæ—¶è‡ªåŠ¨å›é€€åˆ°æ•°æ®åº“
5. **ç»†ç²’åº¦ç¼“å­˜**ï¼šæŒ‰user_idåˆ†ç‰‡ï¼Œé¿å…å…¨å±€ç¼“å­˜

### ğŸ”® æœªæ¥å¯é€‰ä¼˜åŒ–

#### 1. ç¼“å­˜é¢„çƒ­
```python
# åº”ç”¨å¯åŠ¨æ—¶é¢„åŠ è½½çƒ­ç‚¹æ•°æ®
def warmup_cache():
    """é¢„çƒ­æ´»è·ƒç”¨æˆ·çš„ç¼“å­˜"""
    active_users = get_active_users()  # æœ€è¿‘7å¤©æ´»è·ƒ
    for user_id in active_users:
        get_user_settings(user_id)  # é¢„åŠ è½½è®¾ç½®
        # ...
```

#### 2. æ™ºèƒ½TTL
```python
# æ ¹æ®è®¿é—®é¢‘ç‡åŠ¨æ€è°ƒæ•´TTL
if access_count > 100:  # çƒ­ç‚¹æ•°æ®
    ttl = 600  # 10åˆ†é’Ÿ
else:  # å†·æ•°æ®
    ttl = 60   # 1åˆ†é’Ÿ
```

#### 3. ç¼“å­˜ç»Ÿè®¡
```python
# ç›‘æ§ç¼“å­˜å‘½ä¸­ç‡
@router.get("/admin/cache/stats")
def cache_stats():
    return {
        "hit_rate": "95%",
        "total_hits": 10000,
        "total_misses": 500
    }
```

---

## ğŸ‰ æ€»ç»“

### ç¼“å­˜å®æ–½æ•ˆæœ

#### æ€§èƒ½æå‡
- **æ•°æ®åº“æŸ¥è¯¢å‡å°‘**ï¼š90-99%
- **å“åº”é€Ÿåº¦æå‡**ï¼š30-200å€
- **ç³»ç»Ÿååé‡**ï¼šæå‡2-3å€
- **æ•°æ®åº“è´Ÿè½½**ï¼šé™ä½80-90%

#### ç”¨æˆ·ä½“éªŒ
- **âœ… å®Œå…¨æ— æ„ŸçŸ¥çš„æ€§èƒ½æå‡**
- **âœ… æ‰€æœ‰æ“ä½œç«‹å³ç”Ÿæ•ˆ**
- **âœ… æ— ä¸ä¸€è‡´é—®é¢˜**
- **âœ… æ— éœ€é¢å¤–ç”¨æˆ·æ“ä½œ**

#### æ€»ä½“è¯„çº§ï¼šâ­â­â­â­â­

è¿™æ˜¯ä¸€ä¸ª**å®Œç¾çš„ç¼“å­˜å®æ–½æ¡ˆä¾‹**ï¼š
- å¸¦æ¥æ˜¾è‘—æ€§èƒ½æå‡
- ä¸å½±å“ç”¨æˆ·ä½“éªŒ
- ä¸å¼•å…¥æ•°æ®ä¸ä¸€è‡´
- æœ‰å®Œå–„çš„é™çº§ç­–ç•¥

---

## ğŸ“‹ ç¼“å­˜æ¸…é™¤æ£€æŸ¥æ¸…å•

### å¼€å‘è€…æ£€æŸ¥è¡¨

åœ¨æ·»åŠ æ–°çš„æ•°æ®ä¿®æ”¹æ“ä½œæ—¶ï¼Œè¯·æ£€æŸ¥ï¼š

- [ ] æ˜¯å¦å½±å“ç”¨æˆ·è®¾ç½®ï¼Ÿâ†’ æ¸…é™¤ `user_settings:{user_id}`
- [ ] æ˜¯å¦å½±å“è§’è‰²IDï¼Ÿâ†’ æ¸…é™¤ `char_id:{user_id}:{name}`
- [ ] æ˜¯å¦å½±å“è§’è‰²é…ç½®ï¼Ÿâ†’ æ¸…é™¤ `char_profile:{user_id}:{role}`
- [ ] æ˜¯å¦å½±å“è§’è‰²åˆ—è¡¨ï¼Ÿâ†’ æ¸…é™¤ `char_list:{user_id}`
- [ ] é‡å‘½åæ“ä½œï¼Ÿâ†’ æ¸…é™¤æ–°æ—§ä¸¤ä¸ªé”®

### å½“å‰æ‰€æœ‰æ¸…é™¤ç‚¹

âœ… ç”¨æˆ·è®¾ç½®ï¼š
- `update_user_settings()`

âœ… è§’è‰²IDï¼š
- `get_or_create_character()`
- `delete_character()`
- `rename_character()`

âœ… è§’è‰²é…ç½®ï¼š
- `update_character_structured()`
- `save_character_memories_impl()`
- `delete_character()`
- `rename_character()`

âœ… è§’è‰²åˆ—è¡¨ï¼š
- `get_or_create_character()`ï¼ˆæ–°å»ºï¼‰
- `api_copy_character()`ï¼ˆå¤åˆ¶ï¼‰
- `delete_character()`ï¼ˆåˆ é™¤ï¼‰
- `rename_character()`ï¼ˆé‡å‘½åï¼‰
- `_collect_and_structure()`ï¼ˆä»»åŠ¡å®Œæˆï¼‰

---

*æŠ¥å‘Šç”Ÿæˆæ—¶é—´ï¼š2025-10-18*  
*Redisç¼“å­˜ç‰ˆæœ¬ï¼šv1.0*  
*ç”¨æˆ·ä½“éªŒå½±å“ï¼šå®Œç¾ â­â­â­â­â­*

