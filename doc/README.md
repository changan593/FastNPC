# FastNPC 项目分析文档目录

> **生成时间**: 2025-10-19  
> **文档版本**: v1.0  
> **分析范围**: 完整项目架构、所有模块、移动端适配

---

## 📚 文档列表

### 1. [项目深度分析与移动端适配方案](./项目深度分析与移动端适配方案.md)

**内容**: 全面的项目架构分析和移动端适配完整方案

**章节**:
- 项目概述与核心特性
- 技术架构详解（前端+后端+数据库）
- 核心功能模块深入分析
  - 角色构建模块
  - 对话系统（单聊/群聊）
  - 用户系统与认证
  - 提示词管理
  - 测试评估系统
- 数据库设计分析
- 前端架构分析
- **移动端适配现状评估** ⭐
- **移动端适配优化方案（P0-P3）** ⭐
- 实施建议与优先级
- 总结与展望

**适合人群**: 
- 项目负责人
- 技术架构师
- 需要全面了解项目的开发者

**阅读时间**: 30-40分钟

---

### 2. [移动端适配快速实施指南](./移动端适配快速实施指南.md)

**内容**: 快速修复移动端问题的操作指南

**章节**:
- 关键问题速览（问题严重程度、修复时间、优先级）
- P0 紧急修复（3个核心问题）
  - 显示汉堡菜单按钮
  - 添加viewport配置
  - 修复遮罩层显示
- P1 高优先级优化
  - 触摸优化
  - 键盘遮挡处理
  - 长按菜单
  - 上下文菜单优化
- 测试与验证清单
- 调试技巧（Chrome DevTools、真机调试、Eruda）
- 常见问题排查
- 提交清单

**适合人群**:
- 前端开发者
- 需要快速修复问题的工程师
- QA测试人员

**阅读时间**: 15-20分钟

---

### 3. [代码修复示例](./代码修复示例.md)

**内容**: 可直接复制使用的完整代码示例

**包含**:
- App.tsx 修复代码（2处修改 + 1处添加）
- index.html 完整配置
- responsive.css 完整移动端样式
- Sidebar.tsx 长按功能实现
- 移动端测试页面（mobile-test.html）
- Git Patch使用方法

**适合人群**:
- 执行具体修复的开发者
- 需要参考代码实现的工程师

**阅读时间**: 10分钟（直接复制使用）

---

## 🔑 关键发现

### 项目优势

1. ✅ **架构优秀**: 前后端分离，模块化设计，易于维护
2. ✅ **功能完整**: 覆盖角色构建、对话、管理、测试的完整流程
3. ✅ **技术先进**: React 19、FastAPI、PostgreSQL等最新技术
4. ✅ **扩展性强**: 支持多数据源、多LLM模型、提示词版本管理
5. ✅ **性能优化**: Redis缓存、连接池、并发生成
6. ✅ **已有响应式基础**: CSS框架完善，只需修复关键问题

### 移动端问题

#### 🔴 P0 致命问题（必须立即修复）

1. **汉堡菜单按钮被隐藏**
   - 位置: `App.tsx` 第318、434行
   - 原因: 错误的内联样式 `style={{ display: 'none' }}`
   - 修复: 删除该行代码
   - 影响: 用户无法在移动端打开侧边栏
   - 修复时间: 5分钟

2. **缺少viewport配置**
   - 位置: `index.html`
   - 原因: 未设置移动端viewport meta标签
   - 修复: 添加完整的viewport配置
   - 影响: 页面缩放异常，布局错乱
   - 修复时间: 10分钟

3. **遮罩层显示异常**
   - 位置: `responsive.css`
   - 原因: 默认显示逻辑不明确
   - 修复: 明确设置默认隐藏
   - 影响: 可能出现黑色遮罩一直显示
   - 修复时间: 15分钟

#### 🟡 P1 重要问题（显著提升体验）

4. **触摸体验差**
   - 按钮过小（<44px）
   - 点击有高亮闪烁
   - 滚动不流畅
   - 修复时间: 2小时

5. **键盘遮挡输入框**
   - 键盘弹出后输入框被遮挡
   - 需要手动滚动才能看到
   - 修复时间: 1小时

6. **右键菜单不适配移动端**
   - 移动端无右键
   - 需要改为长按操作
   - 修复时间: 1小时

---

## 📊 技术栈总结

### 后端

| 技术 | 版本 | 用途 |
|------|------|------|
| FastAPI | 0.112+ | Web框架 |
| Uvicorn | 0.30+ | ASGI服务器（开发） |
| Gunicorn | 23.0+ | WSGI服务器（生产） |
| PostgreSQL | 13+ | 主数据库（生产） |
| SQLite | 3+ | 开发数据库 |
| Redis | 6+ | 缓存（可选） |
| OpenAI SDK | 1.40+ | LLM调用 |
| BeautifulSoup4 | 4.12+ | HTML解析 |
| Playwright | 1.40+ | 高级爬虫（可选） |
| Bcrypt | 4.0+ | 密码加密 |

### 前端

| 技术 | 版本 | 用途 |
|------|------|------|
| React | 19.1+ | UI框架 |
| TypeScript | 5.8+ | 类型安全 |
| Vite | 7.1+ | 构建工具 |
| Axios | 1.11+ | HTTP客户端 |
| CSS Modules | - | 模块化样式 |
| react-easy-crop | 5.5+ | 图片裁剪 |
| jsoneditor | 10.4+ | JSON编辑器 |

---

## 🗂️ 核心模块

### 1. 角色构建模块

```
datasources/      # 数据抓取
  ├── baike.py    # 百度百科
  └── zhwiki.py   # 维基百科

pipeline/         # 数据处理
  ├── collect.py  # 数据收集
  └── structure/  # 结构化处理
      ├── core.py
      ├── prompts.py
      └── processors.py
```

**功能**: 
- 从百科网站抓取数据
- 并发调用LLM生成9大类结构化画像
- 自动生成角色简介
- 头像管理

### 2. 对话系统模块

```
chat/
  ├── prompt_builder.py   # 六段式Prompt构建
  ├── memory_manager.py   # 三层记忆管理
  └── group_moderator.py  # 群聊智能中控
```

**功能**:
- 单角色对话（流式回复）
- 多角色群聊（智能判断发言顺序）
- 三层记忆系统（会话/短期/长期）
- 自动记忆压缩与整合

### 3. 用户系统模块

```
api/auth/
  ├── core.py          # 认证核心
  ├── users.py         # 用户管理
  ├── db_init.py       # 数据库初始化
  └── db_pool.py       # 连接池管理
```

**功能**:
- 用户注册/登录
- Cookie签名认证
- 密码哈希（Bcrypt）
- 用户配置管理
- 管理员权限

### 4. 提示词管理模块

```
prompt_manager.py        # 提示词管理器
api/routes/
  └── prompt_routes.py   # 提示词API
```

**功能**:
- 数据库驱动的提示词系统
- 完整的版本控制
- 一键激活/回滚
- 15种提示词类别

### 5. 测试评估模块

```
api/routes/
  └── test_case_routes.py    # 测试用例API
prompt_evaluator.py          # 评估器
```

**功能**:
- 测试用例管理（CRUD）
- 15个专用评估器
- LLM驱动的自动评估
- 结构化评分

---

## 🗄️ 数据库设计

### 核心表

1. **users** - 用户表
   - 用户名、密码哈希、管理员标识、头像

2. **characters** - 角色表
   - 角色名、结构化JSON、百科原文、头像

3. **messages** - 消息表
   - 单聊消息、压缩标识、system prompt快照

4. **groups** - 群聊表
   - 群聊名称、创建时间、更新时间

5. **group_members** - 群成员表
   - 成员类型（用户/角色）、成员ID、成员名

6. **group_messages** - 群消息表
   - 发送者类型、发送者名、消息内容、中控prompt

7. **prompt_templates** - 提示词表
   - 类别、子类别、版本、内容、激活状态

8. **test_cases** - 测试用例表
   - 版本、类别、目标类型、测试内容、预期行为

9. **test_executions** - 测试执行记录表
   - 执行时间、LLM响应、评估结果、评分

### 数据关系

```
users (1) ─── (*) characters
  │                 │
  │                 └─── (*) messages
  │
  └─── (*) groups
           │
           ├─── (*) group_members
           └─── (*) group_messages
```

---

## 🚀 快速实施步骤

### 第一步: P0紧急修复（30分钟）

1. 修复汉堡菜单按钮（5分钟）
   - 打开 `web/fastnpc-web/src/App.tsx`
   - 删除第318、434行的 `style={{ display: 'none' }}`

2. 添加viewport配置（10分钟）
   - 打开 `web/fastnpc-web/index.html`
   - 在 `<head>` 中添加viewport meta标签

3. 修复遮罩层（15分钟）
   - 打开 `web/fastnpc-web/src/styles/responsive.css`
   - 在文件开头添加 `.mobile-overlay { display: none; }`

### 第二步: 测试验证（30分钟）

1. 启动开发服务器
2. Chrome DevTools模拟移动端
3. 真机测试（iOS + Android）
4. 确认基本功能可用

### 第三步: P1优化（2-3小时）

1. 触摸优化（1小时）
2. 键盘处理（30分钟）
3. 长按菜单（1小时）

### 第四步: 全面测试（1小时）

1. 功能测试清单
2. 性能测试
3. 兼容性测试

---

## 📞 支持与反馈

### 问题反馈

如果在实施过程中遇到问题，请：

1. 查看 [常见问题排查](./移动端适配快速实施指南.md#常见问题排查)
2. 使用 [调试技巧](./移动端适配快速实施指南.md#调试技巧) 定位问题
3. 查看浏览器Console错误信息

### 文档更新

如果发现文档有误或需要补充，欢迎：

1. 提交Issue
2. 提交Pull Request
3. 联系文档维护者

---

## 📈 下一步计划

### 短期（1-2周）

- [ ] 完成P0紧急修复
- [ ] 完成P1高优先级优化
- [ ] 收集用户反馈

### 中期（1个月）

- [ ] P2性能优化（虚拟滚动、懒加载）
- [ ] 骨架屏加载
- [ ] 离线检测和提示

### 长期（2-3个月）

- [ ] PWA支持（可安装到主屏幕）
- [ ] 手势操作（滑动导航）
- [ ] 深色模式
- [ ] 横屏优化
- [ ] 分享功能

---

## 📖 参考资源

### 官方文档

- [React 19 文档](https://react.dev/)
- [FastAPI 文档](https://fastapi.tiangolo.com/)
- [Vite 文档](https://vitejs.dev/)
- [MDN Web文档](https://developer.mozilla.org/)

### 移动端开发

- [MDN 移动端Web开发指南](https://developer.mozilla.org/zh-CN/docs/Web/Guide/Mobile)
- [Google Web.dev](https://web.dev/)
- [iOS Safari开发文档](https://developer.apple.com/documentation/webkit)
- [Chrome DevTools](https://developer.chrome.com/docs/devtools/)

### 性能优化

- [Web Vitals](https://web.dev/vitals/)
- [React性能优化](https://react.dev/learn/render-and-commit)
- [Lighthouse](https://developers.google.com/web/tools/lighthouse)

---

## ✅ 文档完整性检查

- [x] 项目概述完整
- [x] 技术栈详细说明
- [x] 核心模块深入分析
- [x] 数据库设计文档
- [x] 移动端问题诊断
- [x] 完整的修复方案
- [x] 具体的代码示例
- [x] 测试验证清单
- [x] 调试技巧说明
- [x] 实施步骤清晰
- [x] 参考资源丰富

---

**文档生成完毕！祝开发顺利！** 🎉

