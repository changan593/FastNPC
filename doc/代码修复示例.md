# FastNPC 移动端适配 - 具体代码修复示例

> 本文档提供完整的代码修复示例，可直接复制使用

---

## 文件1: web/fastnpc-web/src/App.tsx

### 修改位置1: 第318行（群聊视图）

```typescript
// ❌ 修改前
<button className="mobile-menu-btn" onClick={() => setShowMobileSidebar(true)} style={{ display: 'none' }}>
  ☰
</button>

// ✅ 修改后
<button className="mobile-menu-btn" onClick={() => setShowMobileSidebar(true)}>
  ☰
</button>
```

### 修改位置2: 第434行（单聊视图）

```typescript
// ❌ 修改前
<button className="mobile-menu-btn" onClick={() => setShowMobileSidebar(true)} style={{ display: 'none' }}>
  ☰
</button>

// ✅ 修改后
<button className="mobile-menu-btn" onClick={() => setShowMobileSidebar(true)}>
  ☰
</button>
```

### 添加: 键盘遮挡处理（在第200行附近，其他useEffect之后）

```typescript
// 处理移动端键盘遮挡输入框
useEffect(() => {
  if (typeof window === 'undefined' || typeof window.visualViewport === 'undefined') {
    return
  }
  
  const handleViewportResize = () => {
    const viewportHeight = window.visualViewport?.height || 0
    const windowHeight = window.innerHeight
    const isKeyboardOpen = viewportHeight < windowHeight * 0.75
    
    if (isKeyboardOpen && chatBodyRef.current) {
      setTimeout(() => {
        if (chatBodyRef.current) {
          chatBodyRef.current.scrollTo({
            top: chatBodyRef.current.scrollHeight,
            behavior: 'smooth'
          })
        }
      }, 300)
    }
  }
  
  window.visualViewport?.addEventListener('resize', handleViewportResize)
  
  return () => {
    window.visualViewport?.removeEventListener('resize', handleViewportResize)
  }
}, [])
```

---

## 文件2: web/fastnpc-web/index.html

### 完整文件内容

```html
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/svg+xml" href="/vite.svg" />
  
  <!-- ✅ 移动端viewport配置 -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  
  <title>FastNPC - AI角色对话平台</title>
</head>
<body>
  <div id="root"></div>
  
  <!-- ✅ 开发环境：移动端调试工具（可选） -->
  <script>
    // 仅在localhost启用调试工具
    if (location.hostname === 'localhost' || location.hostname === '127.0.0.1') {
      const script = document.createElement('script')
      script.src = 'https://cdn.jsdelivr.net/npm/eruda'
      script.onload = () => {
        if (window.eruda) {
          window.eruda.init()
          console.log('Eruda调试工具已启动')
        }
      }
      document.body.appendChild(script)
    }
  </script>
  
  <script type="module" src="/src/main.tsx"></script>
</body>
</html>
```

---

## 文件3: web/fastnpc-web/src/styles/responsive.css

### 在文件开头添加（第1行）

```css
/* ========================================
   响应式设计 - Mobile Responsive
   ======================================== */

/* ===== 默认状态（桌面端）===== */
.mobile-overlay {
  display: none;  /* ✅ 桌面端默认隐藏 */
}

.mobile-menu-btn {
  display: none;  /* ✅ 桌面端默认隐藏 */
}
```

### 在 @media (max-width: 768px) 块中添加/修改

```css
/* ========== 移动端适配（768px 以下）========== */
@media (max-width: 768px) {
  /* ===== 主布局 ===== */
  .layout {
    grid-template-columns: 1fr;
    padding: 0;
    gap: 0;
  }
  
  /* ===== 遮罩层 ===== */
  .mobile-overlay {
    display: none;  /* ✅ 默认隐藏 */
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 999;
    pointer-events: auto;
  }
  
  .layout.mobile-sidebar-open .mobile-overlay {
    display: block;  /* ✅ 侧边栏打开时显示 */
  }
  
  /* ===== 侧边栏抽屉效果 ===== */
  .sidebar {
    position: fixed;
    top: 0;
    left: -100%;
    width: 80%;
    max-width: 320px;
    height: 100%;
    z-index: 1000;
    transition: left var(--transition-slow);
    box-shadow: 2px 0 8px rgba(0, 0, 0, 0.15);
  }
  
  .layout.mobile-sidebar-open .sidebar {
    left: 0;
  }
  
  /* ===== 汉堡菜单按钮 ===== */
  .mobile-menu-btn {
    display: flex !important;  /* ✅ 移动端显示 */
    align-items: center;
    justify-content: center;
    width: 36px;
    height: 36px;
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    background: #fff;
    cursor: pointer;
    margin-right: var(--spacing-sm);
    font-size: 20px;
    padding: 0;
    min-width: 36px;
    min-height: 36px;
  }
  
  /* ===== 触摸优化 ===== */
  
  /* 增加按钮触摸区域（最小44px） */
  button, 
  a, 
  .clickable {
    min-width: 44px;
    min-height: 44px;
  }
  
  /* 移除点击高亮（避免闪烁） */
  * {
    -webkit-tap-highlight-color: transparent;
    -webkit-touch-callout: none;
    -webkit-user-select: none;
    user-select: none;
  }
  
  /* 输入框和可编辑内容允许选择 */
  input, 
  textarea, 
  [contenteditable="true"] {
    -webkit-user-select: text;
    user-select: text;
  }
  
  /* 滚动优化（iOS惯性滚动） */
  .chat-body,
  .role-list,
  .info-content,
  .admin-content {
    -webkit-overflow-scrolling: touch;
    overscroll-behavior: contain;
  }
  
  /* 防止iOS自动缩放输入框 */
  input, 
  textarea, 
  select {
    font-size: 16px !important;
  }
  
  /* ===== 隐藏右侧信息栏 ===== */
  .group-info-panel,
  .single-chat-info {
    display: none !important;
  }
  
  /* ===== 聊天区顶部 ===== */
  .chat-head {
    padding: 10px var(--spacing-md);
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
  }
  
  .chat-head .title {
    flex: 1;
    font-size: var(--font-size-lg);
  }
  
  /* ===== 聊天消息 ===== */
  .msg .bubble {
    max-width: 85%;
  }
  
  /* ===== 群聊消息适配 ===== */
  .group-msg-item {
    padding: var(--spacing-sm);
  }
  
  .group-msg-item .avatar {
    width: 36px;
    height: 36px;
    font-size: 20px;
  }
  
  .group-msg-item .sender-name {
    font-size: 13px;
  }
  
  .group-msg-item .bubble {
    font-size: var(--font-size-base);
    padding: var(--spacing-sm) 10px;
    max-width: 80%;
  }
  
  /* ===== 聊天输入框 ===== */
  .chat-input {
    padding: 10px var(--spacing-md);
  }
  
  .chat-input input {
    font-size: var(--font-size-md);
    flex: 1;
  }
  
  .chat-input button {
    padding: var(--spacing-sm) 14px;
  }
  
  /* ===== 状态栏 ===== */
  .status-bar {
    padding: var(--spacing-sm) var(--spacing-md);
    font-size: 13px;
  }
  
  /* ===== 侧边栏列表 ===== */
  .role-list li {
    padding: var(--spacing-md) var(--spacing-lg);
    min-height: 60px;
  }
  
  .role-list .name {
    font-size: var(--font-size-base);
  }
  
  .role-list .time {
    font-size: var(--font-size-xs);
  }
  
  /* ===== 底部创建按钮 ===== */
  .sidebar .fab-container {
    left: var(--spacing-sm);
    bottom: var(--spacing-sm);
  }
  
  .sidebar .fab-container .fab {
    padding: var(--spacing-sm) var(--spacing-md);
    font-size: 14px;
    min-height: 44px;
  }
  
  /* ===== 对话框适配 ===== */
  .dialog {
    width: 92vw;
    max-width: none;
    max-height: 85vh;
    overflow: auto;
  }
  
  /* ===== 上下文菜单 ===== */
  .ctx-menu {
    min-width: 160px;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
    border-radius: 12px;
  }
  
  .ctx-menu button {
    padding: 14px 20px;
    font-size: 16px;
    min-height: 48px;
  }
  
  .ctx-menu button:active {
    background: var(--color-gray-200);
  }
  
  /* ===== 管理员界面 ===== */
  .admin-header {
    flex-direction: column;
    align-items: stretch;
    padding: var(--spacing-md);
    gap: var(--spacing-sm);
  }
  
  .admin-tabs {
    flex-wrap: nowrap;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }
  
  .admin-tabs button {
    padding: var(--spacing-sm) var(--spacing-md);
    font-size: 13px;
    white-space: nowrap;
  }
  
  .admin-actions {
    flex-direction: column;
    gap: var(--spacing-sm);
  }
  
  .admin-search {
    width: 100%;
    min-width: auto;
  }
  
  .admin-content {
    padding: var(--spacing-md);
  }
  
  /* ===== 表格改为卡片式 ===== */
  .admin-table {
    display: none;
  }
  
  .admin-card-list {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-md);
  }
  
  .admin-card {
    background: #fff;
    border: 1px solid var(--border);
    border-radius: var(--radius-md);
    padding: var(--spacing-md);
    box-shadow: var(--shadow-sm);
  }
  
  /* ===== 反馈弹窗适配 ===== */
  .feedback-dialog {
    width: 95vw !important;
    max-width: none;
  }
  
  .feedback-header {
    padding: var(--spacing-lg);
  }
  
  .feedback-tabs {
    padding: 0 var(--spacing-lg);
  }
  
  .feedback-tabs button {
    padding: var(--spacing-md) var(--spacing-lg);
    font-size: var(--font-size-base);
  }
  
  .feedback-content {
    padding: var(--spacing-lg);
  }
  
  .feedback-actions {
    padding: var(--spacing-md) var(--spacing-lg);
  }
}

/* ========== 横屏模式优化 ========== */
@media (max-width: 768px) and (orientation: landscape) {
  .chat-head {
    padding: 8px 12px;
  }
  
  .chat-input {
    padding: 8px 12px;
  }
  
  .mobile-menu-btn {
    width: 32px;
    height: 32px;
    font-size: 18px;
  }
  
  .sidebar {
    max-width: 280px;
  }
}
```

---

## 文件4: web/fastnpc-web/src/components/Sidebar.tsx

### 修改: 添加长按支持

在组件顶部添加状态：

```typescript
import { useState } from 'react'
import type { CharacterItem, GroupItem } from '../types'
import { useCharacter } from '../contexts/CharacterContext'

export function Sidebar({...props}) {
  const [q, setQ] = useState('')
  const [sort, setSort] = useState<'updated' | 'alpha'>('updated')
  
  // ✅ 添加长按相关状态
  const [pressTimer, setPressTimer] = useState<number | null>(null)
  
  const { 
    menuVisible, setMenuVisible, 
    menuPos, setMenuPos, 
    menuRole, setMenuRole, 
    renaming, setRenaming, 
    newName, setNewName, 
    renameRole, deleteRole, copyRole 
  } = useCharacter()
  
  // ... 其他代码
}
```

修改列表项（在 return 的 ul.role-list 中）：

```typescript
<ul className="role-list">
  {filteredItems.map(item => (
    <li
      key={`${item.type}-${item.type === 'character' ? item.data.role : item.data.id}`}
      className={
        (item.type === 'character' && activeType === 'character' && item.data.role === activeRole) ||
        (item.type === 'group' && activeType === 'group' && item.data.id === activeGroupId)
          ? 'active'
          : ''
      }
      
      {/* ✅ 保留右键菜单（桌面端） */}
      onContextMenu={e => {
        if (item.type === 'character') {
          e.preventDefault()
          setMenuRole(item.data.role)
          setMenuPos({ x: e.clientX, y: e.clientY })
          setMenuVisible(true)
        }
      }}
      
      {/* ✅ 添加长按支持（移动端） */}
      onTouchStart={e => {
        if (item.type === 'character') {
          const timer = window.setTimeout(() => {
            // 触发震动反馈（如果支持）
            if ('vibrate' in navigator) {
              navigator.vibrate(50)
            }
            
            const touch = e.touches[0]
            setMenuRole(item.data.role)
            setMenuPos({ x: touch.clientX, y: touch.clientY })
            setMenuVisible(true)
          }, 500)  // 长按500ms
          
          setPressTimer(timer)
        }
      }}
      onTouchEnd={() => {
        if (pressTimer) {
          clearTimeout(pressTimer)
          setPressTimer(null)
        }
      }}
      onTouchMove={() => {
        if (pressTimer) {
          clearTimeout(pressTimer)
          setPressTimer(null)
        }
      }}
    >
      <div
        className="row"
        onClick={() => {
          if (item.type === 'character') {
            setActiveType('character')
            setActiveRole(item.data.role)
            setActiveGroupId(null)
          } else {
            setActiveType('group')
            setActiveGroupId(item.data.id)
            setActiveRole('')
          }
        }}
      >
        {/* ... 列表项内容 */}
      </div>
    </li>
  ))}
</ul>
```

---

## 测试脚本

创建一个测试文件用于快速验证：

### 文件: web/fastnpc-web/public/mobile-test.html

```html
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>移动端适配测试</title>
  <style>
    body {
      margin: 0;
      padding: 20px;
      font-family: system-ui, sans-serif;
    }
    
    .test-section {
      margin-bottom: 30px;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 8px;
    }
    
    .test-button {
      min-width: 44px;
      min-height: 44px;
      padding: 12px 16px;
      margin: 5px;
      border: 1px solid #2563eb;
      background: #2563eb;
      color: white;
      border-radius: 6px;
      font-size: 16px;
      -webkit-tap-highlight-color: transparent;
    }
    
    .test-button:active {
      background: #1d4ed8;
    }
    
    .log {
      margin-top: 10px;
      padding: 10px;
      background: #f5f5f5;
      border-radius: 4px;
      font-size: 14px;
      max-height: 200px;
      overflow-y: auto;
    }
    
    .success {
      color: green;
    }
    
    .error {
      color: red;
    }
  </style>
</head>
<body>
  <h1>FastNPC 移动端适配测试</h1>
  
  <div class="test-section">
    <h2>1. Viewport 测试</h2>
    <p>屏幕宽度: <span id="screen-width"></span>px</p>
    <p>视口宽度: <span id="viewport-width"></span>px</p>
    <p>设备像素比: <span id="device-pixel-ratio"></span></p>
    <p class="success" id="viewport-result"></p>
  </div>
  
  <div class="test-section">
    <h2>2. 触摸事件测试</h2>
    <button class="test-button" id="touch-btn">长按我（0.5秒）</button>
    <div class="log" id="touch-log"></div>
  </div>
  
  <div class="test-section">
    <h2>3. 键盘测试</h2>
    <input type="text" placeholder="点击输入，观察键盘弹出" id="keyboard-input" 
           style="width: 100%; padding: 12px; font-size: 16px; border: 1px solid #ddd; border-radius: 4px;">
    <div class="log" id="keyboard-log"></div>
  </div>
  
  <div class="test-section">
    <h2>4. 滚动测试</h2>
    <div style="height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; -webkit-overflow-scrolling: touch;">
      <p>滚动内容测试</p>
      <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit.</p>
      <p>Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.</p>
      <p>Ut enim ad minim veniam, quis nostrud exercitation ullamco.</p>
      <p>Duis aute irure dolor in reprehenderit in voluptate velit.</p>
      <p>Excepteur sint occaecat cupidatat non proident.</p>
      <p>Sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
      <p>测试结束</p>
    </div>
  </div>
  
  <div class="test-section">
    <h2>5. 震动反馈测试</h2>
    <button class="test-button" id="vibrate-btn">测试震动</button>
    <div class="log" id="vibrate-log"></div>
  </div>
  
  <script>
    // 1. Viewport测试
    document.getElementById('screen-width').textContent = screen.width
    document.getElementById('viewport-width').textContent = window.innerWidth
    document.getElementById('device-pixel-ratio').textContent = window.devicePixelRatio
    
    if (window.innerWidth <= 768) {
      document.getElementById('viewport-result').textContent = '✅ 移动端视口正常'
    } else {
      document.getElementById('viewport-result').textContent = '⚠️ 当前为桌面端'
      document.getElementById('viewport-result').className = 'error'
    }
    
    // 2. 触摸事件测试
    const touchBtn = document.getElementById('touch-btn')
    const touchLog = document.getElementById('touch-log')
    let touchTimer = null
    
    function addLog(element, message) {
      const time = new Date().toLocaleTimeString()
      element.innerHTML += `<div>[${time}] ${message}</div>`
      element.scrollTop = element.scrollHeight
    }
    
    touchBtn.addEventListener('touchstart', (e) => {
      addLog(touchLog, '👆 触摸开始')
      touchTimer = setTimeout(() => {
        addLog(touchLog, '✅ 长按成功！（0.5秒）')
        if ('vibrate' in navigator) {
          navigator.vibrate(50)
        }
      }, 500)
    })
    
    touchBtn.addEventListener('touchend', () => {
      if (touchTimer) {
        clearTimeout(touchTimer)
        addLog(touchLog, '🔚 触摸结束')
      }
    })
    
    touchBtn.addEventListener('touchmove', () => {
      if (touchTimer) {
        clearTimeout(touchTimer)
        addLog(touchLog, '↔️ 触摸移动，长按取消')
      }
    })
    
    // 3. 键盘测试
    const keyboardInput = document.getElementById('keyboard-input')
    const keyboardLog = document.getElementById('keyboard-log')
    
    if (window.visualViewport) {
      window.visualViewport.addEventListener('resize', () => {
        const height = window.visualViewport.height
        const windowHeight = window.innerHeight
        
        if (height < windowHeight * 0.75) {
          addLog(keyboardLog, '⌨️ 键盘已弹出')
        } else {
          addLog(keyboardLog, '✅ 键盘已收起')
        }
      })
    } else {
      addLog(keyboardLog, '⚠️ visualViewport API不支持')
    }
    
    // 5. 震动测试
    const vibrateBtn = document.getElementById('vibrate-btn')
    const vibrateLog = document.getElementById('vibrate-log')
    
    vibrateBtn.addEventListener('click', () => {
      if ('vibrate' in navigator) {
        navigator.vibrate([100, 50, 100])
        addLog(vibrateLog, '✅ 震动反馈已触发')
      } else {
        addLog(vibrateLog, '❌ 当前设备不支持震动API')
      }
    })
    
    // 初始化日志
    addLog(touchLog, '等待触摸事件...')
    addLog(keyboardLog, '等待键盘事件...')
    addLog(vibrateLog, '点击按钮测试震动')
  </script>
</body>
</html>
```

### 使用方法

1. 启动开发服务器后访问: `http://localhost:5173/mobile-test.html`
2. 在真机上测试各项功能
3. 查看日志输出，确认功能正常

---

## 快速应用所有修复

### 方法1: 手动复制

按照上述文件逐个修改，复制代码到对应位置。

### 方法2: 使用Git Patch（推荐）

如果你熟悉Git，可以创建一个patch文件：

```bash
# 创建分支
git checkout -b mobile-fix

# 应用所有修改
# （手动修改文件）

# 提交更改
git add .
git commit -m "移动端适配修复: P0紧急修复"

# 生成patch
git format-patch main --stdout > mobile-fix.patch

# 应用patch（在其他环境）
git apply mobile-fix.patch
```

---

**完成以上修复后，请运行移动端测试确保一切正常！** ✅

