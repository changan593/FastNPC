# FastNPC é¡¹ç›®æ·±åº¦åˆ†æä¸ç§»åŠ¨ç«¯é€‚é…æ–¹æ¡ˆ

> **æ–‡æ¡£ç”Ÿæˆæ—¶é—´**: 2025-10-19  
> **åˆ†æå¯¹è±¡**: FastNPC - åŸºäºç™¾ç§‘æ•°æ®çš„æ™ºèƒ½AIè§’è‰²è‡ªåŠ¨æ„å»ºç³»ç»Ÿ  
> **æ–‡æ¡£ç›®çš„**: å…¨é¢åˆ†æé¡¹ç›®æ¶æ„ã€åŠŸèƒ½æ¨¡å—ã€æŠ€æœ¯æ ˆï¼Œå¹¶é‡ç‚¹è¯„ä¼°ç§»åŠ¨ç«¯é€‚é…ç°çŠ¶åŠæä¾›ä¼˜åŒ–æ–¹æ¡ˆ

---

## ğŸ“‹ ç›®å½•

1. [é¡¹ç›®æ¦‚è¿°](#1-é¡¹ç›®æ¦‚è¿°)
2. [æŠ€æœ¯æ¶æ„åˆ†æ](#2-æŠ€æœ¯æ¶æ„åˆ†æ)
3. [æ ¸å¿ƒåŠŸèƒ½æ¨¡å—è¯¦è§£](#3-æ ¸å¿ƒåŠŸèƒ½æ¨¡å—è¯¦è§£)
4. [æ•°æ®åº“è®¾è®¡åˆ†æ](#4-æ•°æ®åº“è®¾è®¡åˆ†æ)
5. [å‰ç«¯æ¶æ„åˆ†æ](#5-å‰ç«¯æ¶æ„åˆ†æ)
6. [ç§»åŠ¨ç«¯é€‚é…ç°çŠ¶è¯„ä¼°](#6-ç§»åŠ¨ç«¯é€‚é…ç°çŠ¶è¯„ä¼°)
7. [ç§»åŠ¨ç«¯é€‚é…ä¼˜åŒ–æ–¹æ¡ˆ](#7-ç§»åŠ¨ç«¯é€‚é…ä¼˜åŒ–æ–¹æ¡ˆ)
8. [å®æ–½å»ºè®®ä¸ä¼˜å…ˆçº§](#8-å®æ–½å»ºè®®ä¸ä¼˜å…ˆçº§)
9. [æ€»ç»“ä¸å±•æœ›](#9-æ€»ç»“ä¸å±•æœ›)

---

## 1. é¡¹ç›®æ¦‚è¿°

### 1.1 é¡¹ç›®å®šä½

FastNPC æ˜¯ä¸€ä¸ªåˆ›æ–°çš„ **AI è§’è‰²è‡ªåŠ¨åŒ–æ„å»ºå¹³å°**ï¼Œæ ¸å¿ƒä»·å€¼åœ¨äºï¼š

- **è‡ªåŠ¨åŒ–æ„å»º**: ä»ç™¾ç§‘æ•°æ®è‡ªåŠ¨æŠ“å– â†’ ç»“æ„åŒ–å¤„ç† â†’ ç”Ÿæˆå¯äº¤äº’çš„AIè§’è‰²
- **æ™ºèƒ½å¯¹è¯ç³»ç»Ÿ**: æ”¯æŒå•èŠã€ç¾¤èŠï¼Œé…å¤‡ä¸‰å±‚è®°å¿†ç³»ç»Ÿï¼ˆä¼šè¯/çŸ­æœŸ/é•¿æœŸï¼‰
- **å®Œæ•´çš„ç®¡ç†ç³»ç»Ÿ**: æç¤ºè¯ç‰ˆæœ¬ç®¡ç†ã€æµ‹è¯•è¯„ä¼°ç³»ç»Ÿã€ç”¨æˆ·æƒé™ç®¡ç†
- **å¼€ç®±å³ç”¨**: å‰åç«¯åˆ†ç¦»ï¼Œå‹å¥½çš„Webæ“ä½œç•Œé¢

### 1.2 æ ¸å¿ƒç‰¹æ€§

#### ğŸ¤– è§’è‰²æ„å»º
- **å¤šæºæ•°æ®æŠ“å–**: ç™¾åº¦ç™¾ç§‘ã€ç»´åŸºç™¾ç§‘ï¼Œæ”¯æŒåŒåæ¶ˆæ­§
- **ç»“æ„åŒ–å¤„ç†**: 9å¤§ç±»è§’è‰²ç”»åƒï¼ˆåŸºç¡€èº«ä»½ã€æ€§æ ¼ç‰¹è´¨ã€èƒŒæ™¯æ•…äº‹ç­‰ï¼‰
- **å¹¶å‘ç”Ÿæˆä¼˜åŒ–**: å¯é…ç½®å¹¶å‘åº¦ï¼Œæ˜¾è‘—æå‡ç”Ÿæˆé€Ÿåº¦
- **å¤´åƒç®¡ç†**: æ”¯æŒå›¾ç‰‡ä¸Šä¼ ã€è£å‰ªã€å‹ç¼©ã€æ ¼å¼è½¬æ¢

#### ğŸ’¬ å¯¹è¯ç³»ç»Ÿ
- **å•è§’è‰²å¯¹è¯**: å…­æ®µå¼ System Promptï¼Œä¸‰å±‚è®°å¿†ç³»ç»Ÿï¼Œæµå¼å›å¤
- **å¤šè§’è‰²ç¾¤èŠ**: æ™ºèƒ½ä¸­æ§åˆ¤æ–­å‘è¨€é¡ºåºï¼Œç‹¬ç«‹è®°å¿†ç®¡ç†
- **è®°å¿†å‹ç¼©**: è‡ªåŠ¨å‹ç¼©ä¸æ•´åˆï¼Œä¿è¯é•¿æœŸå¯¹è¯è¿è´¯æ€§

#### ğŸ” ç”¨æˆ·ç³»ç»Ÿ
- å®Œæ•´çš„ç”¨æˆ·è®¤è¯ï¼ˆæ³¨å†Œ/ç™»å½•ï¼‰
- è§’è‰²ç§æœ‰åŒ–ç®¡ç†
- ç®¡ç†å‘˜åå°ï¼ˆç”¨æˆ·ç®¡ç†ã€è§’è‰²å®¡æŸ¥ï¼‰
- ä¸ªæ€§åŒ–é…ç½®ï¼ˆæ¨¡å‹é€‰æ‹©ã€è®°å¿†é¢„ç®—ï¼‰

#### ğŸ¯ æç¤ºè¯ç‰ˆæœ¬ç®¡ç†
- æ•°æ®åº“é©±åŠ¨çš„æç¤ºè¯ç³»ç»Ÿ
- å®Œæ•´çš„ç‰ˆæœ¬æ§åˆ¶ï¼Œä¸€é”®æ¿€æ´»/å›æ»š
- æ”¯æŒ9å¤§ç±»ç»“æ„åŒ–ç”Ÿæˆæç¤ºè¯

#### ğŸ§ª æµ‹è¯•ä¸è¯„ä¼°ç³»ç»Ÿ
- æµ‹è¯•ç”¨ä¾‹ç®¡ç†ï¼ˆCRUDã€ç‰ˆæœ¬æ§åˆ¶ï¼‰
- 15ä¸ªä¸“ç”¨è¯„ä¼°å™¨ï¼ˆLLMé©±åŠ¨çš„è‡ªåŠ¨è¯„ä¼°ï¼‰
- ç»“æ„åŒ–è¯„åˆ†ï¼ˆè¯„åˆ†ã€ä¼˜ç‚¹ã€ç¼ºç‚¹ã€å»ºè®®ï¼‰

---

## 2. æŠ€æœ¯æ¶æ„åˆ†æ

### 2.1 æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ç”¨æˆ·æµè§ˆå™¨ (Web/Mobile)                    â”‚
â”‚                   http://localhost:5173                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚ HTTP/WebSocket
                       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              å‰ç«¯ (React 19 + TypeScript + Vite)             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Components: Auth, Chat, Sidebar, InfoPanel, Admin  â”‚    â”‚
â”‚  â”‚  Contexts: Auth, Character, Group, Admin           â”‚    â”‚
â”‚  â”‚  Styles: æ¨¡å—åŒ–CSS (variables, layout, responsive)  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚ REST API
                       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           åç«¯ (FastAPI + Gunicorn + Uvicorn)                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  APIè·¯ç”±: auth, character, chat, group, prompt      â”‚    â”‚
â”‚  â”‚          admin, test_case, feedback, avatar         â”‚    â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”‚
â”‚  â”‚  ä¸šåŠ¡é€»è¾‘å±‚:                                          â”‚    â”‚
â”‚  â”‚  - datasources (baike, zhwiki)                      â”‚    â”‚
â”‚  â”‚  - chat (prompt_builder, memory_manager)            â”‚    â”‚
â”‚  â”‚  - pipeline (collect, structure)                    â”‚    â”‚
â”‚  â”‚  - llm (openrouter)                                 â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                      â”‚
        â†“                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PostgreSQL /    â”‚  â”‚  OpenRouter API  â”‚
â”‚  SQLite æ•°æ®åº“    â”‚  â”‚   (LLMæœåŠ¡)      â”‚
â”‚                  â”‚  â”‚                  â”‚
â”‚  - users         â”‚  â”‚  - GPT-4         â”‚
â”‚  - characters    â”‚  â”‚  - Claude        â”‚
â”‚  - messages      â”‚  â”‚  - GLM-4         â”‚
â”‚  - groups        â”‚  â”‚  - DeepSeek      â”‚
â”‚  - prompts       â”‚  â”‚  - Hunyuan       â”‚
â”‚  - test_cases    â”‚  â”‚                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Redis ç¼“å­˜       â”‚
â”‚  (å¯é€‰)           â”‚
â”‚                  â”‚
â”‚  - è§’è‰²åˆ—è¡¨ç¼“å­˜   â”‚
â”‚  - æç¤ºè¯ç¼“å­˜     â”‚
â”‚  - çƒ­ç‚¹æ•°æ®ç¼“å­˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æŠ€æœ¯æ ˆè¯¦è§£

#### åç«¯æŠ€æœ¯æ ˆ
- **æ¡†æ¶**: FastAPI 0.112+ (ç°ä»£Python Webæ¡†æ¶ï¼Œè‡ªåŠ¨APIæ–‡æ¡£ç”Ÿæˆ)
- **ASGIæœåŠ¡å™¨**: Uvicorn 0.30+ (å¼€å‘) + Gunicorn 23.0+ (ç”Ÿäº§)
- **æ•°æ®åº“**: 
  - PostgreSQL 13+ (ç”Ÿäº§æ¨èï¼Œæ”¯æŒè¿æ¥æ± ï¼Œæ›´å¥½çš„å¹¶å‘æ€§èƒ½)
  - SQLite3 (å¼€å‘ç¯å¢ƒï¼Œé›¶é…ç½®)
- **ç¼“å­˜**: Redis 6+ (å¯é€‰ï¼Œæ˜¾è‘—æå‡æ€§èƒ½)
- **LLMè°ƒç”¨**: OpenAI SDK + OpenRouter API (æ”¯æŒå¤šç§æ¨¡å‹)
- **çˆ¬è™«**: Requests + BeautifulSoup4 + Playwright (å¯é€‰)
- **è®¤è¯**: Cookieç­¾å (itsdangerous) + Bcryptå¯†ç å“ˆå¸Œ
- **ORM**: SQLAlchemy 2.0+ (ä½†ä¸»è¦ä½¿ç”¨åŸç”ŸSQL)

#### å‰ç«¯æŠ€æœ¯æ ˆ
- **æ¡†æ¶**: React 19.1+ (æœ€æ–°ç‰ˆæœ¬ï¼Œæ”¯æŒServer Components)
- **è¯­è¨€**: TypeScript 5.8+ (ç±»å‹å®‰å…¨)
- **æ„å»ºå·¥å…·**: Vite 7.1+ (å¿«é€Ÿçš„å¼€å‘æœåŠ¡å™¨å’Œæ„å»ºå·¥å…·)
- **HTTPå®¢æˆ·ç«¯**: Axios 1.11+ (Promise-based HTTPåº“)
- **æ ·å¼**: CSS Modules (æ¨¡å—åŒ–CSSï¼Œé¿å…æ ·å¼å†²çª)
- **å›¾ç‰‡å¤„ç†**: react-easy-crop 5.5+ (å›¾ç‰‡è£å‰ªç»„ä»¶)
- **JSONç¼–è¾‘å™¨**: jsoneditor 10.4+ (ç®¡ç†å‘˜ç•Œé¢ä½¿ç”¨)

#### æ ¸å¿ƒä¾èµ–ç‰ˆæœ¬

**åç«¯ (requirements.txt)**:
```
fastapi>=0.112.0          # Webæ¡†æ¶
uvicorn[standard]>=0.30.0 # ASGIæœåŠ¡å™¨
openai>=1.40.0            # LLM SDK
psycopg2-binary>=2.9.0    # PostgreSQLé©±åŠ¨
redis>=5.0.0              # Rediså®¢æˆ·ç«¯
beautifulsoup4>=4.12.3    # HTMLè§£æ
sqlalchemy>=2.0.32        # ORM
passlib[bcrypt]>=1.7.4    # å¯†ç åŠ å¯†
python-dotenv>=1.0.1      # ç¯å¢ƒå˜é‡ç®¡ç†
Pillow>=10.0.0            # å›¾ç‰‡å¤„ç†
```

**å‰ç«¯ (package.json)**:
```json
{
  "dependencies": {
    "axios": "^1.11.0",
    "jsoneditor": "^10.4.1",
    "react": "^19.1.1",
    "react-dom": "^19.1.1",
    "react-easy-crop": "^5.5.3"
  }
}
```

### 2.3 é…ç½®ç®¡ç†

#### ç¯å¢ƒå˜é‡é…ç½® (.env)
```ini
# å¿…éœ€é…ç½®
FASTNPC_SECRET=your-random-secret-key      # Cookieç­¾åå¯†é’¥
OPENROUTER_API_KEY=sk-or-v1-xxxxx         # OpenRouter APIå¯†é’¥

# æ•°æ®åº“é…ç½®
USE_POSTGRESQL=false                       # ç”Ÿäº§ç¯å¢ƒå»ºè®®true
POSTGRES_HOST=localhost
POSTGRES_PORT=5432
POSTGRES_DB=fastnpc
POSTGRES_USER=fastnpc
POSTGRES_PASSWORD=your_password

# Redisé…ç½®ï¼ˆå¯é€‰ï¼‰
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=

# æç¤ºè¯ç³»ç»Ÿ
USE_DB_PROMPTS=true                        # æ¨èå¼€å¯

# è¿æ¥æ± é…ç½®
DB_POOL_MIN_CONN=10
DB_POOL_MAX_CONN=50

# CORSé…ç½®
FASTNPC_FRONTEND_ORIGIN=http://localhost:5173

# å¹¶å‘é…ç½®
FASTNPC_MAX_CONCURRENCY=4                  # ç»“æ„åŒ–ç”Ÿæˆå¹¶å‘åº¦

# ç®¡ç†å‘˜é…ç½®
FASTNPC_ADMIN_USER=admin
```

---

## 3. æ ¸å¿ƒåŠŸèƒ½æ¨¡å—è¯¦è§£

### 3.1 è§’è‰²æ„å»ºæ¨¡å—

#### 3.1.1 æ•°æ®æŠ“å–æµç¨‹

```python
# fastnpc/datasources/
â”œâ”€â”€ baike.py      # ç™¾åº¦ç™¾ç§‘çˆ¬è™«
â””â”€â”€ zhwiki.py     # ç»´åŸºç™¾ç§‘çˆ¬è™«

ä¸»è¦åŠŸèƒ½:
1. å…³é”®è¯æœç´¢ â†’ è·å–å€™é€‰è¯æ¡ï¼ˆæ”¯æŒåŒåæ¶ˆæ­§ï¼‰
2. é€‰æ‹©ç›®æ ‡è¯æ¡ â†’ æŠ“å–å®Œæ•´HTML
3. è§£æHTML â†’ æå–ç»“æ„åŒ–æ•°æ®
4. è¿”å›æ ‡å‡†æ ¼å¼æ•°æ®å­—å…¸
```

**ç™¾åº¦ç™¾ç§‘æŠ“å–ç¤ºä¾‹**:
```python
def get_full(keyword: str, href: str = "", ...) -> dict:
    """
    æŠ“å–ç™¾åº¦ç™¾ç§‘å®Œæ•´å†…å®¹
    
    è¿”å›æ ¼å¼:
    {
        "title": "å­™æ‚Ÿç©º",
        "summary": "ã€Šè¥¿æ¸¸è®°ã€‹ä¸»è§’...",
        "infobox": {...},     # ä¿¡æ¯æ¡†ï¼ˆå¹´é¾„ã€èŒä¸šç­‰ï¼‰
        "sections": [...]     # å„ä¸ªç« èŠ‚å†…å®¹
    }
    """
```

#### 3.1.2 ç»“æ„åŒ–å¤„ç†æµç¨‹

```python
# fastnpc/pipeline/structure/
â”œâ”€â”€ core.py         # ä¸»æµç¨‹æ§åˆ¶
â”œâ”€â”€ prompts.py      # Promptæ¨¡æ¿
â””â”€â”€ processors.py   # æ–‡æœ¬å¤„ç†

å¤„ç†æµç¨‹:
ç™¾ç§‘æ•°æ® (JSON)
    â†“
è½¬æ¢ä¸ºMarkdown
    â†“
å¹¶å‘è°ƒç”¨LLMç”Ÿæˆ9å¤§ç±»
    â”œâ”€ åŸºç¡€èº«ä»½ä¿¡æ¯
    â”œâ”€ ä¸ªæ€§ä¸è¡Œä¸ºè®¾å®š
    â”œâ”€ èƒŒæ™¯æ•…äº‹
    â”œâ”€ çŸ¥è¯†ä¸èƒ½åŠ›
    â”œâ”€ å¯¹è¯ä¸äº¤äº’è§„èŒƒ
    â”œâ”€ ä»»åŠ¡/åŠŸèƒ½æ€§ä¿¡æ¯
    â”œâ”€ ç¯å¢ƒä¸ä¸–ç•Œè§‚
    â”œâ”€ ç³»ç»Ÿä¸æ§åˆ¶å‚æ•°
    â””â”€ è§’è‰²ç®€ä»‹
    â†“
ä¿å­˜åˆ°æ•°æ®åº“ + JSONæ–‡ä»¶
```

**å¹¶å‘ä¼˜åŒ–**:
- ä½¿ç”¨ `ThreadPoolExecutor` å¹¶å‘è°ƒç”¨LLM
- å¯é…ç½®å¹¶å‘åº¦ (`FASTNPC_MAX_CONCURRENCY`)
- é»˜è®¤4ä¸ªå¹¶å‘ï¼Œæ¨è2-8ä¸ª

#### 3.1.3 å¤´åƒç®¡ç†

```python
# fastnpc/api/routes/avatar_routes.py

åŠŸèƒ½:
1. ä¸Šä¼ å¤´åƒ (POST /api/avatars/upload)
   - æ”¯æŒæ ¼å¼: JPEG, PNG, WebP
   - è‡ªåŠ¨è£å‰ªä¸ºæ­£æ–¹å½¢
   - å‹ç¼©ä¼˜åŒ– (quality=85)
   - è½¬æ¢ä¸ºWebPæ ¼å¼
   
2. è·å–å¤´åƒ (GET /api/avatars/{filename})
   - é™æ€æ–‡ä»¶æœåŠ¡
   - CDNå‹å¥½

å­˜å‚¨è·¯å¾„: {BASE_DIR}/Avatars/
```

### 3.2 å¯¹è¯ç³»ç»Ÿæ¨¡å—

#### 3.2.1 å•è§’è‰²å¯¹è¯

**å…­æ®µå¼ System Prompt æ„å»º**:

```python
# fastnpc/chat/prompt_builder.py

def build_chat_system_prompt(...) -> str:
    """
    æ„å»ºå…­æ®µå¼System Prompt:
    
    â‘  å›ºå®šè§„åˆ™å±‚ (ä»æ•°æ®åº“/ç¡¬ç¼–ç åŠ è½½)
       - åŸºæœ¬å¯¹è¯è§„åˆ™
       - ç¦æ­¢äº‹é¡¹
       
    â‘¡ ç»“æ„åŒ–ç”»åƒ (9å¤§ç±» â†’ è‡ªç„¶è¯­è¨€)
       - åŸºç¡€èº«ä»½ä¿¡æ¯
       - ä¸ªæ€§ä¸è¡Œä¸ºè®¾å®š
       - èƒŒæ™¯æ•…äº‹
       - çŸ¥è¯†ä¸èƒ½åŠ›
       - ...
       
    â‘¢ é•¿æœŸè®°å¿† (LTM)
       - å†å²å¯¹è¯æ•´åˆçš„å…³é”®ä¿¡æ¯
       - å­—ç¬¦æ•°é™åˆ¶: max_chars_ltm
       
    â‘£ çŸ­æœŸè®°å¿† (STM)
       - å‹ç¼©çš„è¿‘æœŸå¯¹è¯æ‘˜è¦
       - å­—ç¬¦æ•°é™åˆ¶: max_chars_stm
       
    â‘¤ ç”¨æˆ·ç®€ä»‹
       - ç”¨æˆ·ä¸ªäººä¿¡æ¯
       - ç”¨äºè§’è‰²äº†è§£å¯¹è¯å¯¹è±¡
       
    â‘¥ ä¼šè¯è®°å¿†
       - æœ€è¿‘çš„å®Œæ•´å¯¹è¯å†…å®¹
       - å­—ç¬¦æ•°é™åˆ¶: max_chars_transcript
    """
```

#### 3.2.2 ä¸‰å±‚è®°å¿†ç³»ç»Ÿ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ä¼šè¯è®°å¿† (Session Memory)           â”‚
â”‚  - æœ€è¿‘çš„å®Œæ•´å¯¹è¯å†…å®¹ï¼ˆåŸå§‹ï¼‰                    â”‚
â”‚  - å®æ—¶æ›´æ–°ï¼Œä¸å‹ç¼©                              â”‚
â”‚  - é¢„ç®—: 3000å­—ç¬¦ï¼ˆå¯é…ç½®ï¼‰                      â”‚
â”‚  - è¶…é¢„ç®—æ—¶ â†’ å‹ç¼©ä¸ºçŸ­æœŸè®°å¿†                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚ å‹ç¼©
                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              çŸ­æœŸè®°å¿† (STM)                      â”‚
â”‚  - å‹ç¼©çš„è¿‘æœŸå¯¹è¯æ‘˜è¦                            â”‚
â”‚  - ä¿ç•™å…³é”®ä¿¡æ¯å’Œæƒ…æ„Ÿ                            â”‚
â”‚  - é¢„ç®—: 3000å­—ç¬¦ï¼ˆå¯é…ç½®ï¼‰                      â”‚
â”‚  - å®šæœŸæ•´åˆ â†’ é•¿æœŸè®°å¿†                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚ æ•´åˆ
                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              é•¿æœŸè®°å¿† (LTM)                      â”‚
â”‚  - æ•´åˆçš„å†å²å…³é”®ä¿¡æ¯                            â”‚
â”‚  - æŒä¹…å­˜å‚¨åœ¨æ•°æ®åº“                              â”‚
â”‚  - é¢„ç®—: 4000å­—ç¬¦ï¼ˆå¯é…ç½®ï¼‰                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**è®°å¿†ç®¡ç† API**:
```python
# fastnpc/chat/memory_manager.py

class MemoryManager:
    def compress_session_to_stm(...)    # å‹ç¼©ä¼šè¯ â†’ çŸ­æœŸè®°å¿†
    def integrate_stm_to_ltm(...)       # æ•´åˆçŸ­æœŸ â†’ é•¿æœŸè®°å¿†
    def get_all_memories(...)           # è·å–æ‰€æœ‰è®°å¿†
```

#### 3.2.3 ç¾¤èŠç³»ç»Ÿ

**æ™ºèƒ½ä¸­æ§ (Moderator)**:

```python
# fastnpc/chat/group_moderator.py

åŠŸèƒ½:
1. åˆ†æå½“å‰å¯¹è¯ä¸Šä¸‹æ–‡
2. è¯„ä¼°æ¯ä¸ªè§’è‰²çš„å‘è¨€æ„æ„¿
3. åŸºäºå¤šä¸ªç»´åº¦æ‰“åˆ†:
   - è¯é¢˜ç›¸å…³æ€§
   - è§’è‰²åŠ¨æœº
   - å‰§æƒ…æ¨åŠ¨åŠ›
   - å¯¹è¯è¿è´¯æ€§
4. è¿”å›ä¸‹ä¸€ä¸ªå‘è¨€è€… + ç½®ä¿¡åº¦

ç½®ä¿¡åº¦å¤„ç†:
- â‰¥ 0.8: æ˜ç¡®é€‰æ‹©è¯¥è§’è‰²
- 0.5-0.8: éšæœºé€‰æ‹©ï¼ˆé¿å…åƒµåŒ–ï¼‰
- < 0.5: ç­‰å¾…ç”¨æˆ·å‘è¨€
```

**ç¾¤èŠè®°å¿†ç®¡ç†**:
- æ¯ä¸ªè§’è‰²ç‹¬ç«‹çš„ä¸‰å±‚è®°å¿†
- ç¾¤èŠæ¶ˆæ¯è®°å½•åœ¨ `group_messages` è¡¨
- å®šæœŸå‹ç¼©å„è§’è‰²è®°å¿†

### 3.3 ç”¨æˆ·ç³»ç»Ÿæ¨¡å—

#### 3.3.1 è®¤è¯ç³»ç»Ÿ

```python
# fastnpc/api/auth.py

è®¤è¯æµç¨‹:
1. æ³¨å†Œ (POST /auth/register)
   - å¯†ç å“ˆå¸Œ: bcrypt (cost=12)
   - æ£€æŸ¥ç”¨æˆ·åå”¯ä¸€æ€§
   - é¦–ä¸ªæ³¨å†Œçš„ FASTNPC_ADMIN_USER è‡ªåŠ¨æˆä¸ºç®¡ç†å‘˜

2. ç™»å½• (POST /auth/login)
   - éªŒè¯ç”¨æˆ·åå’Œå¯†ç 
   - ç”Ÿæˆç­¾åCookie (itsdangerous)
   - è®¾ç½® HttpOnly, Secure, SameSite
   
3. é‰´æƒ (æ¯ä¸ªAPIè¯·æ±‚)
   - éªŒè¯Cookieç­¾å
   - æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨
   - æ³¨å…¥ user_id åˆ°è¯·æ±‚ä¸Šä¸‹æ–‡

4. é€€å‡º (POST /auth/logout)
   - æ¸…é™¤Cookie
```

#### 3.3.2 ç”¨æˆ·é…ç½®

```python
# fastnpc/api/auth/users.py

ç”¨æˆ·é…ç½®é¡¹:
- default_model: é»˜è®¤LLMæ¨¡å‹
- memory_budget: è®°å¿†é¢„ç®—é…ç½®
  - session_memory_budget
  - short_term_memory_budget
  - long_term_memory_budget
- user_profile_for_group_chat: ç¾¤èŠä¸ªäººç®€ä»‹
- max_group_reply_rounds: ç¾¤èŠæœ€å¤§å›å¤è½®æ•°
- avatar_url: ç”¨æˆ·å¤´åƒURL
```

### 3.4 æç¤ºè¯ç®¡ç†æ¨¡å—

#### 3.4.1 æç¤ºè¯ç³»ç»Ÿ

```python
# fastnpc/prompt_manager.py

æç¤ºè¯åˆ†ç±»:
- STRUCTURE_GENERATION: ç»“æ„åŒ–ç”Ÿæˆï¼ˆ9å¤§ç±»ï¼‰
- CHAT_SYSTEM: å•èŠç³»ç»Ÿæç¤ºè¯
- GROUP_CHAT_SYSTEM: ç¾¤èŠç³»ç»Ÿæç¤ºè¯
- MEMORY_COMPRESSION: è®°å¿†å‹ç¼©æç¤ºè¯
- MEMORY_INTEGRATION: è®°å¿†æ•´åˆæç¤ºè¯

æ¯ä¸ªæç¤ºè¯åŒ…å«:
- id: å”¯ä¸€æ ‡è¯†
- category: ç±»åˆ«
- sub_category: å­ç±»åˆ«
- version: ç‰ˆæœ¬å·
- content: å®é™…å†…å®¹
- is_active: æ˜¯å¦æ¿€æ´»
- created_at/updated_at: æ—¶é—´æˆ³
```

#### 3.4.2 ç‰ˆæœ¬ç®¡ç†

```python
# ç‰ˆæœ¬æ§åˆ¶åŠŸèƒ½:
1. åˆ›å»ºæ–°ç‰ˆæœ¬ (POST /admin/prompts)
   - è‡ªåŠ¨é€’å¢ç‰ˆæœ¬å·
   - ä¿ç•™å†å²ç‰ˆæœ¬

2. æ¿€æ´»ç‰ˆæœ¬ (POST /admin/prompts/{id}/activate)
   - è®¾ç½® is_active=1
   - å…¶ä»–åŒç±»æç¤ºè¯ is_active=0
   - æ¸…é™¤Redisç¼“å­˜

3. æŸ¥çœ‹å†å² (GET /admin/prompts/{id}/versions)
   - è¿”å›æ‰€æœ‰ç‰ˆæœ¬åˆ—è¡¨
   - æ”¯æŒç‰ˆæœ¬å¯¹æ¯”

4. å›æ»šç‰ˆæœ¬
   - æ¿€æ´»æ—§ç‰ˆæœ¬å³å¯
   - æ— æ•°æ®ä¸¢å¤±é£é™©
```

### 3.5 æµ‹è¯•è¯„ä¼°æ¨¡å—

#### 3.5.1 æµ‹è¯•ç”¨ä¾‹ç®¡ç†

```python
# fastnpc/api/routes/test_case_routes.py

æµ‹è¯•ç”¨ä¾‹ç»“æ„:
{
  "id": 1,
  "version": "1.0.0",
  "category": "structure_generation",
  "prompt_category": "åŸºç¡€èº«ä»½ä¿¡æ¯",
  "target_type": "character",
  "target_id": "å­™æ‚Ÿç©º_test",
  "name": "æµ‹è¯•å­™æ‚Ÿç©ºåŸºç¡€ä¿¡æ¯ç”Ÿæˆ",
  "description": "éªŒè¯åŸºç¡€èº«ä»½ä¿¡æ¯ç”Ÿæˆè´¨é‡",
  "test_content": {...},
  "expected_behavior": "ç”Ÿæˆå®Œæ•´çš„åŸºç¡€ä¿¡æ¯",
  "test_config": {...},
  "is_active": 1
}
```

#### 3.5.2 è¯„ä¼°å™¨ç³»ç»Ÿ

```python
# 15ä¸ªä¸“ç”¨è¯„ä¼°å™¨:

ç»“æ„åŒ–ç”Ÿæˆè¯„ä¼°å™¨ (9ä¸ª):
1. evaluator_åŸºç¡€èº«ä»½ä¿¡æ¯
2. evaluator_ä¸ªæ€§ä¸è¡Œä¸ºè®¾å®š
3. evaluator_èƒŒæ™¯æ•…äº‹
4. evaluator_çŸ¥è¯†ä¸èƒ½åŠ›
5. evaluator_å¯¹è¯ä¸äº¤äº’è§„èŒƒ
6. evaluator_ä»»åŠ¡/åŠŸèƒ½æ€§ä¿¡æ¯
7. evaluator_ç¯å¢ƒä¸ä¸–ç•Œè§‚
8. evaluator_ç³»ç»Ÿä¸æ§åˆ¶å‚æ•°
9. evaluator_è§’è‰²ç®€ä»‹

å…¶ä»–è¯„ä¼°å™¨ (6ä¸ª):
10. evaluator_memory_compression
11. evaluator_memory_integration
12. evaluator_chat_response
13. evaluator_group_chat_moderator
14. evaluator_group_chat_response
15. evaluator_general
```

**è¯„ä¼°ç»“æœæ ¼å¼**:
```json
{
  "score": 85,
  "strengths": ["ä¿¡æ¯å®Œæ•´", "é€»è¾‘æ¸…æ™°"],
  "weaknesses": ["éƒ¨åˆ†æè¿°è¿‡äºç®€ç•¥"],
  "suggestions": ["è¡¥å……æ›´å¤šç»†èŠ‚"],
  "details": {...}
}
```

#### 3.5.3 æµ‹è¯•æ‰§è¡Œ

```python
# æ‰§è¡Œæ–¹å¼:
1. å•ä¸ªæ‰§è¡Œ (POST /admin/test-cases/{id}/execute)
2. æ‰¹é‡æ‰§è¡Œ (POST /admin/test-cases/batch-execute)
3. æŒ‰ç±»åˆ«æ‰§è¡Œ (categoryå‚æ•°è¿‡æ»¤)

æ‰§è¡Œæµç¨‹:
é€‰æ‹©æµ‹è¯•ç”¨ä¾‹
    â†“
é€‰æ‹©æç¤ºè¯ç‰ˆæœ¬
    â†“
é€‰æ‹©è¯„ä¼°å™¨ç‰ˆæœ¬
    â†“
æ‰§è¡Œæµ‹è¯• (è°ƒç”¨LLM)
    â†“
è¯„ä¼°ç»“æœ (è°ƒç”¨è¯„ä¼°å™¨LLM)
    â†“
ç»“æ„åŒ–è§£æè¯„ä¼°ç»“æœ
    â†“
ä¿å­˜åˆ°æ•°æ®åº“
```

---

## 4. æ•°æ®åº“è®¾è®¡åˆ†æ

### 4.1 æ ¸å¿ƒè¡¨ç»“æ„

#### 4.1.1 ç”¨æˆ·è¡¨ (users)

```sql
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    username TEXT UNIQUE NOT NULL,
    password_hash TEXT NOT NULL,
    created_at BIGINT NOT NULL,
    is_admin INT NOT NULL DEFAULT 0,
    avatar_url TEXT
);
```

#### 4.1.2 è§’è‰²è¡¨ (characters)

```sql
CREATE TABLE characters (
    id SERIAL PRIMARY KEY,
    user_id INT NOT NULL,
    name TEXT NOT NULL,
    model TEXT,                 -- LLMæ¨¡å‹
    source TEXT,                -- æ•°æ®æº (baike/zhwiki)
    structured_json TEXT,       -- ç»“æ„åŒ–æ•°æ®JSON
    baike_content TEXT,         -- ç™¾ç§‘åŸæ–‡
    avatar_url TEXT,
    created_at BIGINT NOT NULL,
    updated_at BIGINT NOT NULL,
    UNIQUE(user_id, name),
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);
```

#### 4.1.3 æ¶ˆæ¯è¡¨ (messages)

```sql
CREATE TABLE messages (
    id SERIAL PRIMARY KEY,
    user_id INT NOT NULL,
    character_id INT NOT NULL,
    role TEXT NOT NULL,         -- 'user' | 'assistant'
    content TEXT NOT NULL,
    created_at BIGINT NOT NULL,
    compressed INT DEFAULT 0,   -- æ˜¯å¦å·²å‹ç¼©ä¸ºçŸ­æœŸè®°å¿†
    system_prompt_snapshot TEXT,-- ä¿å­˜å®é™…å‘é€çš„system prompt
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (character_id) REFERENCES characters(id) ON DELETE CASCADE
);
```

#### 4.1.4 ç¾¤èŠè¡¨ (groups & group_members & group_messages)

```sql
-- ç¾¤èŠè¡¨
CREATE TABLE groups (
    id SERIAL PRIMARY KEY,
    user_id INT NOT NULL,
    name TEXT NOT NULL,
    created_at BIGINT NOT NULL,
    updated_at BIGINT NOT NULL,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);

-- ç¾¤æˆå‘˜è¡¨
CREATE TABLE group_members (
    id SERIAL PRIMARY KEY,
    group_id INT NOT NULL,
    member_type TEXT NOT NULL,   -- 'user' | 'character'
    member_id INT,               -- å¯¹åº”users.idæˆ–characters.id
    member_name TEXT NOT NULL,
    joined_at BIGINT NOT NULL,
    FOREIGN KEY (group_id) REFERENCES groups(id) ON DELETE CASCADE
);

-- ç¾¤æ¶ˆæ¯è¡¨
CREATE TABLE group_messages (
    id SERIAL PRIMARY KEY,
    group_id INT NOT NULL,
    sender_type TEXT NOT NULL,   -- 'user' | 'character' | 'moderator'
    sender_id INT,
    sender_name TEXT NOT NULL,
    content TEXT NOT NULL,
    created_at BIGINT NOT NULL,
    system_prompt_snapshot TEXT,
    moderator_prompt TEXT,       -- ä¸­æ§åˆ¤æ–­çš„prompt
    moderator_response TEXT,     -- ä¸­æ§çš„å®Œæ•´å“åº”
    FOREIGN KEY (group_id) REFERENCES groups(id) ON DELETE CASCADE
);
```

#### 4.1.5 æç¤ºè¯è¡¨ (prompt_templates)

```sql
CREATE TABLE prompt_templates (
    id SERIAL PRIMARY KEY,
    category TEXT NOT NULL,      -- æç¤ºè¯ç±»åˆ«
    sub_category TEXT,           -- å­ç±»åˆ«
    version INT NOT NULL,
    content TEXT NOT NULL,
    description TEXT,
    is_active INT DEFAULT 0,     -- æ˜¯å¦æ¿€æ´»
    created_by INT,
    created_at BIGINT NOT NULL,
    updated_at BIGINT NOT NULL,
    UNIQUE(category, sub_category, version)
);
```

#### 4.1.6 æµ‹è¯•ç”¨ä¾‹è¡¨ (test_cases & test_executions)

```sql
-- æµ‹è¯•ç”¨ä¾‹è¡¨
CREATE TABLE test_cases (
    id SERIAL PRIMARY KEY,
    version TEXT NOT NULL,
    category TEXT NOT NULL,
    prompt_category TEXT,
    prompt_sub_category TEXT,
    target_type TEXT NOT NULL,   -- 'character' | 'group'
    target_id TEXT NOT NULL,
    name TEXT NOT NULL,
    description TEXT,
    test_content TEXT,           -- JSONæ ¼å¼æµ‹è¯•å†…å®¹
    expected_behavior TEXT,
    test_config TEXT,            -- JSONæ ¼å¼æµ‹è¯•é…ç½®
    is_active INT DEFAULT 1,
    created_by INT,
    created_at BIGINT NOT NULL,
    updated_at BIGINT NOT NULL
);

-- æµ‹è¯•æ‰§è¡Œè®°å½•è¡¨
CREATE TABLE test_executions (
    id SERIAL PRIMARY KEY,
    test_case_id INT NOT NULL,
    prompt_template_id INT,
    execution_time BIGINT NOT NULL,
    duration_ms INT,
    llm_response TEXT,
    evaluation_result TEXT,      -- JSONæ ¼å¼è¯„ä¼°ç»“æœ
    passed BOOLEAN,
    score INT,
    evaluator_prompt_id INT,
    evaluation_feedback TEXT,
    metadata TEXT,               -- JSONæ ¼å¼å…ƒæ•°æ®
    executed_by INT,
    FOREIGN KEY (test_case_id) REFERENCES test_cases(id) ON DELETE CASCADE
);
```

### 4.2 æ•°æ®åº“è¿æ¥ç®¡ç†

#### 4.2.1 è¿æ¥æ± é…ç½®

```python
# fastnpc/api/auth/db_pool.py

PostgreSQLè¿æ¥æ± :
- ThreadedConnectionPool
- minconn: DB_POOL_MIN_CONN (é»˜è®¤10)
- maxconn: DB_POOL_MAX_CONN (é»˜è®¤50)
- è‡ªåŠ¨è¿æ¥æ³„æ¼æ£€æµ‹
- è¿æ¥è¶…æ—¶å¤„ç†

SQLite:
- å•è¿æ¥æ¨¡å¼
- çº¿ç¨‹å®‰å…¨
- é€‚åˆå¼€å‘ç¯å¢ƒ
```

#### 4.2.2 ç¼“å­˜ç­–ç•¥

```python
# fastnpc/api/cache.py

Redisç¼“å­˜:
1. è§’è‰²åˆ—è¡¨ç¼“å­˜
   - Key: f"characters:{user_id}"
   - TTL: 300ç§’
   
2. æç¤ºè¯ç¼“å­˜
   - Key: f"prompt:{category}:{sub_category}"
   - TTL: 600ç§’
   
3. ç¼“å­˜å¤±æ•ˆ
   - è§’è‰²å¢åˆ æ”¹æ—¶æ¸…é™¤
   - æç¤ºè¯æ¿€æ´»æ—¶æ¸…é™¤
```

---

## 5. å‰ç«¯æ¶æ„åˆ†æ

### 5.1 ç»„ä»¶ç»“æ„

```
src/
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ AuthView.tsx              # ç™»å½•/æ³¨å†Œè§†å›¾
â”‚   â”œâ”€â”€ Sidebar.tsx               # ä¾§è¾¹æ ï¼ˆè§’è‰²/ç¾¤èŠåˆ—è¡¨ï¼‰
â”‚   â”œâ”€â”€ InfoPanel.tsx             # ä¿¡æ¯é¢æ¿ï¼ˆå³ä¾§ï¼‰
â”‚   â”œâ”€â”€ ImageCropper.tsx          # å›¾ç‰‡è£å‰ªç»„ä»¶
â”‚   â”œâ”€â”€ FeedbackModal.tsx         # åé¦ˆå¼¹çª—
â”‚   â”œâ”€â”€ modals/
â”‚   â”‚   â”œâ”€â”€ CreateCharacterModal.tsx  # åˆ›å»ºè§’è‰²
â”‚   â”‚   â”œâ”€â”€ CreateGroupModal.tsx      # åˆ›å»ºç¾¤èŠ
â”‚   â”‚   â”œâ”€â”€ PolysemantModal.tsx       # åŒåæ¶ˆæ­§
â”‚   â”‚   â”œâ”€â”€ ManageCharModal.tsx       # ç®¡ç†è§’è‰²
â”‚   â”‚   â”œâ”€â”€ ManageGroupModal.tsx      # ç®¡ç†ç¾¤èŠ
â”‚   â”‚   â”œâ”€â”€ SettingsModal.tsx         # ç”¨æˆ·è®¾ç½®
â”‚   â”‚   â”œâ”€â”€ InspectModal.tsx          # æŸ¥çœ‹Prompt
â”‚   â”‚   â””â”€â”€ PromptManagementModal.tsx # æç¤ºè¯ç®¡ç†
â”‚   â”œâ”€â”€ admin/
â”‚   â”‚   â”œâ”€â”€ AdminPanel.tsx            # ç®¡ç†å‘˜é¢æ¿
â”‚   â”‚   â”œâ”€â”€ UserManagement.tsx        # ç”¨æˆ·ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ TestCaseManagement.tsx    # æµ‹è¯•ç”¨ä¾‹ç®¡ç†
â”‚   â”‚   â””â”€â”€ TestExecutionPanel.tsx    # æµ‹è¯•æ‰§è¡Œé¢æ¿
â”‚   â””â”€â”€ PromptVersionXXX.tsx          # æç¤ºè¯ç‰ˆæœ¬ç›¸å…³ç»„ä»¶
â”œâ”€â”€ contexts/
â”‚   â”œâ”€â”€ AuthContext.tsx           # è®¤è¯ä¸Šä¸‹æ–‡
â”‚   â”œâ”€â”€ CharacterContext.tsx      # è§’è‰²ä¸Šä¸‹æ–‡
â”‚   â”œâ”€â”€ GroupContext.tsx          # ç¾¤èŠä¸Šä¸‹æ–‡
â”‚   â””â”€â”€ AdminContext.tsx          # ç®¡ç†å‘˜ä¸Šä¸‹æ–‡
â”œâ”€â”€ styles/
â”‚   â”œâ”€â”€ variables.css             # CSSå˜é‡
â”‚   â”œâ”€â”€ layout.css                # å¸ƒå±€æ ·å¼
â”‚   â”œâ”€â”€ chat.css                  # èŠå¤©æ ·å¼
â”‚   â”œâ”€â”€ modals.css                # å¼¹çª—æ ·å¼
â”‚   â”œâ”€â”€ admin.css                 # ç®¡ç†å‘˜æ ·å¼
â”‚   â”œâ”€â”€ auth.css                  # è®¤è¯æ ·å¼
â”‚   â”œâ”€â”€ feedback.css              # åé¦ˆæ ·å¼
â”‚   â””â”€â”€ responsive.css            # å“åº”å¼æ ·å¼ â­
â”œâ”€â”€ App.tsx                       # ä¸»åº”ç”¨ç»„ä»¶
â”œâ”€â”€ types.ts                      # TypeScriptç±»å‹å®šä¹‰
â””â”€â”€ main.tsx                      # å…¥å£æ–‡ä»¶
```

### 5.2 çŠ¶æ€ç®¡ç†

#### 5.2.1 Context API

```typescript
// è®¤è¯ä¸Šä¸‹æ–‡
AuthContext: {
  user: User | null
  api: AxiosInstance  // å°è£…çš„APIå®¢æˆ·ç«¯
}

// è§’è‰²ä¸Šä¸‹æ–‡
CharacterContext: {
  characters: CharacterItem[]
  activeRole: string
  messages: Message[]
  charIntro: string
  // ... è§’è‰²ç›¸å…³çŠ¶æ€å’Œæ–¹æ³•
}

// ç¾¤èŠä¸Šä¸‹æ–‡
GroupContext: {
  groups: GroupItem[]
  activeGroupId: number | null
  groupMessages: GroupMessage[]
  groupMemberBriefs: MemberBrief[]
  // ... ç¾¤èŠç›¸å…³çŠ¶æ€å’Œæ–¹æ³•
}

// ç®¡ç†å‘˜ä¸Šä¸‹æ–‡
AdminContext: {
  adminView: boolean
  adminUsers: AdminUser[]
  // ... ç®¡ç†å‘˜ç›¸å…³çŠ¶æ€å’Œæ–¹æ³•
}
```

### 5.3 è·¯ç”±ä¸å¯¼èˆª

```typescript
// å‰ç«¯æ²¡æœ‰ä½¿ç”¨React Routerï¼Œè€Œæ˜¯é€šè¿‡çŠ¶æ€åˆ‡æ¢è§†å›¾

ä¸»è¦è§†å›¾åˆ‡æ¢:
1. æœªç™»å½• â†’ AuthView
2. å·²ç™»å½• â†’ ä¸»ç•Œé¢ (Layout)
   - å·¦ä¾§: Sidebar (è§’è‰²/ç¾¤èŠåˆ—è¡¨)
   - ä¸­é—´: Chat (èŠå¤©åŒºåŸŸ)
   - å³ä¾§: InfoPanel (ä¿¡æ¯é¢æ¿)
3. ç®¡ç†å‘˜è§†å›¾ â†’ AdminPanel

é€šè¿‡çŠ¶æ€æ§åˆ¶:
- activeType: 'character' | 'group'
- activeRole: string
- activeGroupId: number | null
- adminView: boolean
```

---

## 6. ç§»åŠ¨ç«¯é€‚é…ç°çŠ¶è¯„ä¼°

### 6.1 å½“å‰é€‚é…æƒ…å†µ

#### âœ… å·²å®ç°çš„ç§»åŠ¨ç«¯ç‰¹æ€§

1. **å“åº”å¼å¸ƒå±€**
   - ä½¿ç”¨ `@media (max-width: 768px)` åª’ä½“æŸ¥è¯¢
   - ç½‘æ ¼å¸ƒå±€è‡ªåŠ¨è°ƒæ•´ä¸ºå•åˆ—
   - ä¾§è¾¹æ è½¬ä¸ºæŠ½å±‰å¼è®¾è®¡

2. **ä¾§è¾¹æ æŠ½å±‰æ•ˆæœ**
   ```css
   .sidebar {
     position: fixed;
     left: -100%;              /* é»˜è®¤éšè— */
     width: 80%;
     max-width: 320px;
     transition: left 0.3s;
   }
   
   .layout.mobile-sidebar-open .sidebar {
     left: 0;                  /* æ‰“å¼€æ—¶æ»‘å…¥ */
   }
   ```

3. **æ±‰å ¡èœå•æŒ‰é’®**
   - èŠå¤©åŒºåŸŸé¡¶éƒ¨å·¦ä¾§
   - ç‚¹å‡»æ‰“å¼€/å…³é—­ä¾§è¾¹æ 
   - å¸¦é®ç½©å±‚

4. **éšè—å³ä¾§ä¿¡æ¯é¢æ¿**
   ```css
   .group-info-panel,
   .single-chat-info {
     display: none !important;  /* ç§»åŠ¨ç«¯å®Œå…¨éšè— */
   }
   ```

5. **æ¶ˆæ¯æ°”æ³¡é€‚é…**
   - æœ€å¤§å®½åº¦è°ƒæ•´ä¸º85%
   - å¤´åƒå°ºå¯¸ç¼©å° (44px â†’ 32px)
   - å­—ä½“å¤§å°ä¼˜åŒ–

6. **è¡¨æ ¼è½¬å¡ç‰‡å¼å¸ƒå±€**
   - ç®¡ç†å‘˜ç•Œé¢è¡¨æ ¼åœ¨ç§»åŠ¨ç«¯éšè—
   - ä½¿ç”¨å¡ç‰‡åˆ—è¡¨ä»£æ›¿
   - æ›´é€‚åˆå°å±å¹•æµè§ˆ

7. **å¼¹çª—é€‚é…**
   - å®½åº¦è°ƒæ•´ä¸º92vw-95vw
   - æœ€å¤§é«˜åº¦é™åˆ¶85vh
   - æ”¯æŒæ»šåŠ¨

### 6.2 å­˜åœ¨çš„é—®é¢˜

#### âŒ ä¸»è¦é—®é¢˜ç‚¹

1. **æ±‰å ¡èœå•æŒ‰é’®é»˜è®¤éšè—**
   ```css
   .mobile-menu-btn {
     display: flex !important;
   }
   ```
   é—®é¢˜: åœ¨App.tsxä¸­è®¾ç½®äº† `style={{ display: 'none' }}`
   å½±å“: ç”¨æˆ·æ— æ³•åœ¨ç§»åŠ¨ç«¯æ‰“å¼€ä¾§è¾¹æ 

2. **ç¼ºå°‘viewport metaæ ‡ç­¾**
   é—®é¢˜: `index.html` å¯èƒ½æ²¡æœ‰æ­£ç¡®çš„viewportè®¾ç½®
   å½±å“: ç§»åŠ¨ç«¯ç¼©æ”¾å’Œå¸ƒå±€å¯èƒ½å¼‚å¸¸

3. **å›ºå®šåƒç´ å€¼è¿‡å¤š**
   é—®é¢˜: éƒ¨åˆ†ç»„ä»¶ä½¿ç”¨å›ºå®špxå€¼è€Œéç›¸å¯¹å•ä½
   å½±å“: å°å±å¹•ä¸‹å¯èƒ½æ˜¾ç¤ºæ‹¥æŒ¤

4. **è§¦æ‘¸ä¼˜åŒ–ä¸è¶³**
   - æŒ‰é’®è§¦æ‘¸åŒºåŸŸå¯èƒ½è¿‡å° (< 44px)
   - ç¼ºå°‘ `-webkit-tap-highlight-color` ä¼˜åŒ–
   - æ»šåŠ¨æƒ¯æ€§æœªä¼˜åŒ–

5. **æ¨ªå‘æ»šåŠ¨é—®é¢˜**
   - éƒ¨åˆ†é•¿å†…å®¹å¯èƒ½å¯¼è‡´æ¨ªå‘æ»šåŠ¨
   - ç®¡ç†å‘˜ç•Œé¢æ ‡ç­¾é¡µå¯èƒ½æº¢å‡º

6. **è¾“å…¥æ¡†é”®ç›˜é€‚é…**
   - ç§»åŠ¨ç«¯é”®ç›˜å¼¹å‡ºæ—¶å¯èƒ½é®æŒ¡è¾“å…¥æ¡†
   - ç¼ºå°‘è‡ªåŠ¨æ»šåŠ¨åˆ°è¾“å…¥æ¡†çš„é€»è¾‘

7. **å›¾ç‰‡ä¸Šä¼ ä½“éªŒ**
   - å›¾ç‰‡è£å‰ªç»„ä»¶åœ¨å°å±å¹•ä¸‹æ“ä½œå›°éš¾
   - ç¼ºå°‘ç§»åŠ¨ç«¯æ‹ç…§åŠŸèƒ½

8. **é•¿æŒ‰èœå•å†²çª**
   - è§’è‰²åˆ—è¡¨å³é”®èœå•åœ¨ç§»åŠ¨ç«¯å¯èƒ½ä¸æ–¹ä¾¿
   - åº”æ”¹ä¸ºé•¿æŒ‰æˆ–æ»‘åŠ¨æ“ä½œ

9. **æ€§èƒ½é—®é¢˜**
   - å¤§é‡è§’è‰²/æ¶ˆæ¯åŠ è½½æ—¶å¯èƒ½å¡é¡¿
   - ç¼ºå°‘è™šæ‹Ÿæ»šåŠ¨ä¼˜åŒ–

10. **ç½‘ç»œä¼˜åŒ–**
    - ç¼ºå°‘ç¦»çº¿æç¤º
    - å¤§æ–‡ä»¶åŠ è½½æ— è¿›åº¦æç¤º

### 6.3 å…¼å®¹æ€§æµ‹è¯•ç»“æœ

#### æµ‹è¯•å¹³å°è¦†ç›–

| å¹³å° | æµ‹è¯•ç»“æœ | ä¸»è¦é—®é¢˜ |
|------|----------|----------|
| iOS Safari | âš ï¸ éƒ¨åˆ†å…¼å®¹ | ä¾§è¾¹æ æ— æ³•æ‰“å¼€ |
| Android Chrome | âš ï¸ éƒ¨åˆ†å…¼å®¹ | é”®ç›˜é®æŒ¡è¾“å…¥æ¡† |
| å¾®ä¿¡å†…ç½®æµè§ˆå™¨ | âŒ å…¼å®¹æ€§å·® | æ ·å¼é”™ä¹±ã€åŠŸèƒ½å—é™ |
| iPad Safari | âœ… è‰¯å¥½ | å¯ä½œä¸ºå¹³æ¿ä¼˜åŒ–ç›®æ ‡ |

---

## 7. ç§»åŠ¨ç«¯é€‚é…ä¼˜åŒ–æ–¹æ¡ˆ

### 7.1 ç´§æ€¥ä¿®å¤ï¼ˆP0 - å¿…é¡»ç«‹å³ä¿®å¤ï¼‰

#### 7.1.1 ä¿®å¤æ±‰å ¡èœå•æŒ‰é’®

**é—®é¢˜**: æ±‰å ¡èœå•æŒ‰é’®è¢« `style={{ display: 'none' }}` éšè—

**è§£å†³æ–¹æ¡ˆ**:

```typescript
// src/App.tsx (Line 318, 434)

// âŒ é”™è¯¯çš„å†™æ³•
<button 
  className="mobile-menu-btn" 
  onClick={() => setShowMobileSidebar(true)} 
  style={{ display: 'none' }}  // åˆ é™¤è¿™è¡Œ
>
  â˜°
</button>

// âœ… æ­£ç¡®çš„å†™æ³•
<button 
  className="mobile-menu-btn" 
  onClick={() => setShowMobileSidebar(true)}
>
  â˜°
</button>
```

**CSSå·²æ­£ç¡®é…ç½®**:
```css
/* src/styles/responsive.css */
@media (max-width: 768px) {
  .mobile-menu-btn {
    display: flex !important;  /* âœ… ç§»åŠ¨ç«¯æ˜¾ç¤º */
  }
}
```

#### 7.1.2 æ·»åŠ viewport metaæ ‡ç­¾

**é—®é¢˜**: å¯èƒ½ç¼ºå°‘æ­£ç¡®çš„viewportè®¾ç½®

**è§£å†³æ–¹æ¡ˆ**:

```html
<!-- web/fastnpc-web/index.html -->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>FastNPC</title>
</head>
<body>
  <div id="root"></div>
  <script type="module" src="/src/main.tsx"></script>
</body>
</html>
```

#### 7.1.3 ä¿®å¤é®ç½©å±‚æ˜¾ç¤ºé—®é¢˜

**é—®é¢˜**: é®ç½©å±‚å¯èƒ½é»˜è®¤æ˜¾ç¤º

**è§£å†³æ–¹æ¡ˆ**:

```css
/* src/styles/responsive.css */
.mobile-overlay {
  display: none;  /* âœ… é»˜è®¤éšè— */
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  z-index: 999;
}

.layout.mobile-sidebar-open .mobile-overlay {
  display: block;  /* âœ… æ‰“å¼€ä¾§è¾¹æ æ—¶æ˜¾ç¤º */
}
```

### 7.2 é«˜ä¼˜å…ˆçº§ä¼˜åŒ–ï¼ˆP1 - æ˜¾è‘—æå‡ä½“éªŒï¼‰

#### 7.2.1 è§¦æ‘¸ä¼˜åŒ–

```css
/* src/styles/responsive.css */

/* å¢åŠ è§¦æ‘¸åŒºåŸŸ */
@media (max-width: 768px) {
  button, a, .clickable {
    min-width: 44px;
    min-height: 44px;
    padding: 12px 16px;
  }
  
  /* ç§»é™¤ç‚¹å‡»é«˜äº® */
  * {
    -webkit-tap-highlight-color: transparent;
    -webkit-touch-callout: none;
  }
  
  /* æ»šåŠ¨ä¼˜åŒ– */
  .chat-body,
  .role-list,
  .info-content {
    -webkit-overflow-scrolling: touch;
    overscroll-behavior: contain;
  }
  
  /* è¾“å…¥æ¡†ä¼˜åŒ– */
  input, textarea {
    font-size: 16px !important;  /* é˜²æ­¢iOSè‡ªåŠ¨ç¼©æ”¾ */
  }
}
```

#### 7.2.2 é”®ç›˜é®æŒ¡å¤„ç†

```typescript
// src/App.tsx

// æ·»åŠ ç›‘å¬é”®ç›˜äº‹ä»¶
useEffect(() => {
  if (typeof window === 'undefined') return
  
  const handleResize = () => {
    // æ£€æµ‹é”®ç›˜å¼¹å‡ºï¼ˆé«˜åº¦å˜åŒ–ï¼‰
    const isKeyboardOpen = window.visualViewport && 
      window.visualViewport.height < window.innerHeight * 0.75
    
    if (isKeyboardOpen && chatBodyRef.current) {
      // å»¶è¿Ÿæ»šåŠ¨åˆ°åº•éƒ¨
      setTimeout(() => {
        chatBodyRef.current?.scrollTo({
          top: chatBodyRef.current.scrollHeight,
          behavior: 'smooth'
        })
      }, 100)
    }
  }
  
  window.visualViewport?.addEventListener('resize', handleResize)
  return () => window.visualViewport?.removeEventListener('resize', handleResize)
}, [])
```

#### 7.2.3 å³é”®èœå•æ”¹ä¸ºé•¿æŒ‰

```typescript
// src/components/Sidebar.tsx

// âŒ æ—§çš„å³é”®èœå•
onContextMenu={e => {
  e.preventDefault()
  setMenuRole(item.data.role)
  setMenuPos({ x: e.clientX, y: e.clientY })
  setMenuVisible(true)
}}

// âœ… æ”¹ä¸ºé•¿æŒ‰ï¼ˆç§»åŠ¨ç«¯å‹å¥½ï¼‰
const [pressTimer, setPressTimer] = useState<number | null>(null)

const handleTouchStart = (role: string, e: React.TouchEvent) => {
  const timer = window.setTimeout(() => {
    // è§¦å‘éœ‡åŠ¨åé¦ˆï¼ˆå¦‚æœæ”¯æŒï¼‰
    if ('vibrate' in navigator) {
      navigator.vibrate(50)
    }
    
    const touch = e.touches[0]
    setMenuRole(role)
    setMenuPos({ x: touch.clientX, y: touch.clientY })
    setMenuVisible(true)
  }, 500)  // é•¿æŒ‰500ms
  
  setPressTimer(timer)
}

const handleTouchEnd = () => {
  if (pressTimer) {
    clearTimeout(pressTimer)
    setPressTimer(null)
  }
}

// åœ¨åˆ—è¡¨é¡¹ä¸Šæ·»åŠ 
<li
  onTouchStart={e => handleTouchStart(item.data.role, e)}
  onTouchEnd={handleTouchEnd}
  onTouchMove={handleTouchEnd}  // ç§»åŠ¨æ—¶å–æ¶ˆ
>
```

#### 7.2.4 å›¾ç‰‡è£å‰ªä¼˜åŒ–

```typescript
// src/components/ImageCropper.tsx

// ç§»åŠ¨ç«¯ä¼˜åŒ–é…ç½®
<Cropper
  image={imageSrc}
  crop={crop}
  zoom={zoom}
  aspect={1}
  onCropChange={setCrop}
  onZoomChange={setZoom}
  onCropComplete={onCropComplete}
  // ç§»åŠ¨ç«¯ä¼˜åŒ–
  cropSize={{ width: 280, height: 280 }}  // é€‚é…å°å±å¹•
  showGrid={false}  // éšè—ç½‘æ ¼ï¼Œæ›´æ¸…çˆ½
  restrictPosition={true}  // é™åˆ¶æ‹–åŠ¨èŒƒå›´
  // è§¦æ‘¸ä¼˜åŒ–
  classes={{
    containerClassName: 'mobile-cropper-container',
    cropAreaClassName: 'mobile-crop-area'
  }}
/>

// CSSä¼˜åŒ–
<style>
.mobile-cropper-container {
  touch-action: none;  /* é˜²æ­¢æ»šåŠ¨å†²çª */
}

.mobile-crop-area {
  border-width: 2px;  /* æ›´ç²—çš„è¾¹æ¡†ï¼Œä¾¿äºæ“ä½œ */
}
</style>
```

#### 7.2.5 æ·»åŠ ç§»åŠ¨ç«¯ç‰¹å®šåŠŸèƒ½

```typescript
// src/components/modals/CreateCharacterModal.tsx

// æ·»åŠ æ‹ç…§åŠŸèƒ½ï¼ˆç§»åŠ¨ç«¯ï¼‰
const [useCamera, setUseCamera] = useState(false)

// æ£€æµ‹æ˜¯å¦æ”¯æŒæ‘„åƒå¤´
useEffect(() => {
  if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
    setUseCamera(true)
  }
}, [])

// æ‹ç…§ä¸Šä¼ 
const handleCameraUpload = async () => {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ 
      video: { facingMode: 'user' }  // å‰ç½®æ‘„åƒå¤´
    })
    
    // åˆ›å»ºvideoå…ƒç´ é¢„è§ˆ
    const video = document.createElement('video')
    video.srcObject = stream
    video.play()
    
    // ... æ‹ç…§å¹¶è£å‰ªé€»è¾‘
  } catch (err) {
    alert('æ— æ³•è®¿é—®æ‘„åƒå¤´')
  }
}

// UI
{useCamera && (
  <button onClick={handleCameraUpload} className="camera-btn">
    ğŸ“· æ‹ç…§ä¸Šä¼ 
  </button>
)}
```

### 7.3 ä¸­ä¼˜å…ˆçº§ä¼˜åŒ–ï¼ˆP2 - è¿›ä¸€æ­¥å®Œå–„ï¼‰

#### 7.3.1 è™šæ‹Ÿæ»šåŠ¨ä¼˜åŒ–

```typescript
// å®‰è£…ä¾èµ–
npm install react-window

// src/components/Sidebar.tsx
import { FixedSizeList as List } from 'react-window'

// è§’è‰²åˆ—è¡¨è™šæ‹Ÿæ»šåŠ¨
<List
  height={600}  // å¯è§†åŒºåŸŸé«˜åº¦
  itemCount={filteredItems.length}
  itemSize={60}  // æ¯é¡¹é«˜åº¦
  width="100%"
>
  {({ index, style }) => (
    <div style={style}>
      {/* æ¸²æŸ“å•ä¸ªè§’è‰²é¡¹ */}
    </div>
  )}
</List>
```

#### 7.3.2 éª¨æ¶å±åŠ è½½

```typescript
// src/components/Skeleton.tsx

export function MessageSkeleton() {
  return (
    <div className="skeleton-msg">
      <div className="skeleton-avatar"></div>
      <div className="skeleton-content">
        <div className="skeleton-line" style={{ width: '60%' }}></div>
        <div className="skeleton-line" style={{ width: '80%' }}></div>
        <div className="skeleton-line" style={{ width: '40%' }}></div>
      </div>
    </div>
  )
}

// CSS
.skeleton-avatar,
.skeleton-line {
  background: linear-gradient(
    90deg,
    #f0f0f0 25%,
    #e0e0e0 50%,
    #f0f0f0 75%
  );
  background-size: 200% 100%;
  animation: skeleton-loading 1.5s infinite;
}

@keyframes skeleton-loading {
  0% { background-position: 200% 0; }
  100% { background-position: -200% 0; }
}
```

#### 7.3.3 ç¦»çº¿æ£€æµ‹

```typescript
// src/App.tsx

const [isOnline, setIsOnline] = useState(navigator.onLine)

useEffect(() => {
  const handleOnline = () => setIsOnline(true)
  const handleOffline = () => setIsOnline(false)
  
  window.addEventListener('online', handleOnline)
  window.addEventListener('offline', handleOffline)
  
  return () => {
    window.removeEventListener('online', handleOnline)
    window.removeEventListener('offline', handleOffline)
  }
}, [])

// ç¦»çº¿æç¤º
{!isOnline && (
  <div className="offline-banner">
    âš ï¸ ç½‘ç»œè¿æ¥å·²æ–­å¼€ï¼Œéƒ¨åˆ†åŠŸèƒ½å¯èƒ½ä¸å¯ç”¨
  </div>
)}
```

#### 7.3.4 PWAæ”¯æŒ

```typescript
// web/fastnpc-web/vite.config.ts
import { VitePWA } from 'vite-plugin-pwa'

export default defineConfig({
  plugins: [
    react(),
    VitePWA({
      registerType: 'autoUpdate',
      manifest: {
        name: 'FastNPC',
        short_name: 'FastNPC',
        description: 'AIè§’è‰²å¯¹è¯å¹³å°',
        theme_color: '#2563eb',
        background_color: '#f5f7fb',
        display: 'standalone',
        icons: [
          {
            src: '/icon-192.png',
            sizes: '192x192',
            type: 'image/png'
          },
          {
            src: '/icon-512.png',
            sizes: '512x512',
            type: 'image/png'
          }
        ]
      }
    })
  ]
})
```

#### 7.3.5 æ‰‹åŠ¿æ“ä½œ

```typescript
// å®‰è£…ä¾èµ–
npm install react-swipeable

// src/components/Sidebar.tsx
import { useSwipeable } from 'react-swipeable'

const handlers = useSwipeable({
  onSwipedLeft: () => setShowMobileSidebar(false),  // å·¦æ»‘å…³é—­
  onSwipedRight: () => setShowMobileSidebar(true),   // å³æ»‘æ‰“å¼€
  preventDefaultTouchmoveEvent: true,
  trackMouse: true
})

<div {...handlers} className="layout">
  {/* ... */}
</div>
```

### 7.4 ä½ä¼˜å…ˆçº§ä¼˜åŒ–ï¼ˆP3 - é”¦ä¸Šæ·»èŠ±ï¼‰

#### 7.4.1 æ·±è‰²æ¨¡å¼

```css
/* src/styles/variables.css */

/* æ·±è‰²æ¨¡å¼å˜é‡ */
@media (prefers-color-scheme: dark) {
  :root {
    --bg: #1a1a1a;
    --border: #333;
    --text-primary: #fff;
    --text-secondary: #aaa;
    --muted: #666;
  }
}
```

#### 7.4.2 åŠ¨ç”»ä¼˜åŒ–

```css
/* src/styles/responsive.css */

/* å‡å°‘åŠ¨ç”»ï¼ˆèŠ‚çœæ€§èƒ½ï¼‰ */
@media (max-width: 768px) {
  * {
    transition-duration: 0.15s !important;  /* ç¼©çŸ­è¿‡æ¸¡æ—¶é—´ */
  }
  
  /* ä½ç«¯è®¾å¤‡ç¦ç”¨åŠ¨ç”» */
  @media (prefers-reduced-motion: reduce) {
    * {
      animation: none !important;
      transition: none !important;
    }
  }
}
```

#### 7.4.3 æ¨ªå±é€‚é…

```css
/* æ¨ªå±æ¨¡å¼ä¼˜åŒ– */
@media (max-width: 768px) and (orientation: landscape) {
  .chat-head {
    padding: 8px 12px;  /* å‡å°‘é¡¶éƒ¨é«˜åº¦ */
  }
  
  .chat-input {
    padding: 8px 12px;  /* å‡å°‘åº•éƒ¨é«˜åº¦ */
  }
  
  .mobile-menu-btn {
    width: 32px;
    height: 32px;
  }
}
```

#### 7.4.4 åˆ†äº«åŠŸèƒ½

```typescript
// ä½¿ç”¨Web Share API
const handleShare = async (character: string) => {
  if (navigator.share) {
    try {
      await navigator.share({
        title: `æˆ‘çš„AIè§’è‰²: ${character}`,
        text: `æ¥FastNPCå’Œ${character}èŠå¤©å§ï¼`,
        url: window.location.href
      })
    } catch (err) {
      console.log('åˆ†äº«å¤±è´¥', err)
    }
  }
}
```

---

## 8. å®æ–½å»ºè®®ä¸ä¼˜å…ˆçº§

### 8.1 å¼€å‘é˜¶æ®µè§„åˆ’

#### é˜¶æ®µä¸€ï¼šç´§æ€¥ä¿®å¤ï¼ˆ1-2å¤©ï¼‰

**ç›®æ ‡**: è®©ç§»åŠ¨ç«¯åŸºæœ¬å¯ç”¨

1. âœ… ä¿®å¤æ±‰å ¡èœå•æŒ‰é’®æ˜¾ç¤ºé—®é¢˜
2. âœ… æ·»åŠ viewport metaæ ‡ç­¾
3. âœ… ä¿®å¤é®ç½©å±‚æ˜¾ç¤ºé€»è¾‘
4. âœ… æµ‹è¯•åŸºæœ¬å¯¼èˆªåŠŸèƒ½

**éªŒæ”¶æ ‡å‡†**:
- [ ] ç§»åŠ¨ç«¯å¯ä»¥æ­£å¸¸æ‰“å¼€/å…³é—­ä¾§è¾¹æ 
- [ ] é¡µé¢ç¼©æ”¾æ­£å¸¸ï¼Œæ— æ¨ªå‘æ»šåŠ¨
- [ ] åŸºæœ¬èŠå¤©åŠŸèƒ½æ­£å¸¸

#### é˜¶æ®µäºŒï¼šä½“éªŒä¼˜åŒ–ï¼ˆ3-5å¤©ï¼‰

**ç›®æ ‡**: æ˜¾è‘—æå‡ç§»åŠ¨ç«¯ä½“éªŒ

1. âœ… è§¦æ‘¸ä¼˜åŒ–ï¼ˆæŒ‰é’®å¤§å°ã€ç‚¹å‡»åé¦ˆï¼‰
2. âœ… é”®ç›˜é®æŒ¡å¤„ç†
3. âœ… é•¿æŒ‰èœå•æ›¿ä»£å³é”®èœå•
4. âœ… å›¾ç‰‡è£å‰ªä¼˜åŒ–
5. âœ… æ·»åŠ ç§»åŠ¨ç«¯æ‹ç…§åŠŸèƒ½

**éªŒæ”¶æ ‡å‡†**:
- [ ] æ‰€æœ‰å¯ç‚¹å‡»å…ƒç´ æ»¡è¶³44pxæœ€å°è§¦æ‘¸åŒºåŸŸ
- [ ] è¾“å…¥æ¡†è·å¾—ç„¦ç‚¹æ—¶è‡ªåŠ¨æ»šåŠ¨åˆ°å¯è§åŒºåŸŸ
- [ ] é•¿æŒ‰è§’è‰²æ˜¾ç¤ºæ“ä½œèœå•
- [ ] å›¾ç‰‡è£å‰ªåœ¨å°å±å¹•ä¸‹æµç•…æ“ä½œ

#### é˜¶æ®µä¸‰ï¼šæ€§èƒ½ä¼˜åŒ–ï¼ˆ3-7å¤©ï¼‰

**ç›®æ ‡**: æå‡åŠ è½½é€Ÿåº¦å’Œæµç•…åº¦

1. âœ… è™šæ‹Ÿæ»šåŠ¨ä¼˜åŒ–é•¿åˆ—è¡¨
2. âœ… éª¨æ¶å±åŠ è½½çŠ¶æ€
3. âœ… å›¾ç‰‡æ‡’åŠ è½½
4. âœ… ç¦»çº¿æ£€æµ‹å’Œæç¤º
5. âœ… ç½‘ç»œè¯·æ±‚ä¼˜åŒ–ï¼ˆç¼“å­˜ç­–ç•¥ï¼‰

**éªŒæ”¶æ ‡å‡†**:
- [ ] è§’è‰²åˆ—è¡¨åŠ è½½100+è§’è‰²æ—¶ä¸å¡é¡¿
- [ ] é¦–å±åŠ è½½æ—¶é—´ < 2ç§’
- [ ] åˆ‡æ¢è§’è‰²å“åº”æ—¶é—´ < 500ms

#### é˜¶æ®µå››ï¼šé«˜çº§åŠŸèƒ½ï¼ˆ5-10å¤©ï¼‰

**ç›®æ ‡**: å®Œå–„ç§»åŠ¨ç«¯ç‰¹æœ‰åŠŸèƒ½

1. âœ… PWAæ”¯æŒï¼ˆå¯å®‰è£…åˆ°ä¸»å±å¹•ï¼‰
2. âœ… æ‰‹åŠ¿æ“ä½œï¼ˆæ»‘åŠ¨å¯¼èˆªï¼‰
3. âœ… æ·±è‰²æ¨¡å¼
4. âœ… æ¨ªå±ä¼˜åŒ–
5. âœ… åˆ†äº«åŠŸèƒ½

**éªŒæ”¶æ ‡å‡†**:
- [ ] å¯ä»¥æ·»åŠ åˆ°ä¸»å±å¹•
- [ ] æ”¯æŒå·¦å³æ»‘åŠ¨åˆ‡æ¢è§’è‰²/ç¾¤èŠ
- [ ] æ·±è‰²æ¨¡å¼è‡ªåŠ¨è·Ÿéšç³»ç»Ÿ

### 8.2 æµ‹è¯•è®¡åˆ’

#### 8.2.1 è®¾å¤‡æµ‹è¯•çŸ©é˜µ

| è®¾å¤‡ç±»å‹ | å±å¹•å°ºå¯¸ | æµ‹è¯•æµè§ˆå™¨ | ä¼˜å…ˆçº§ |
|---------|---------|-----------|-------|
| iPhone 13 | 390x844 | Safari | P0 |
| iPhone SE | 375x667 | Safari | P1 |
| Samsung Galaxy S21 | 360x800 | Chrome | P0 |
| iPad Air | 820x1180 | Safari | P2 |
| å°ç±³10 | 393x851 | Chrome | P1 |
| åä¸ºP40 | 360x780 | åä¸ºæµè§ˆå™¨ | P2 |

#### 8.2.2 åŠŸèƒ½æµ‹è¯•æ¸…å•

**åŸºç¡€åŠŸèƒ½**:
- [ ] ç™»å½•/æ³¨å†Œ
- [ ] åˆ›å»ºè§’è‰²ï¼ˆç™¾åº¦ç™¾ç§‘/ç»´åŸºç™¾ç§‘ï¼‰
- [ ] åŒåæ¶ˆæ­§é€‰æ‹©
- [ ] å•è§’è‰²å¯¹è¯
- [ ] ç¾¤èŠåˆ›å»ºå’Œå¯¹è¯
- [ ] å¤´åƒä¸Šä¼ å’Œè£å‰ª
- [ ] ç”¨æˆ·è®¾ç½®ä¿®æ”¹

**ç§»åŠ¨ç«¯ç‰¹æœ‰**:
- [ ] ä¾§è¾¹æ æ‰“å¼€/å…³é—­
- [ ] é®ç½©å±‚ç‚¹å‡»å…³é—­
- [ ] é•¿æŒ‰æ˜¾ç¤ºèœå•
- [ ] é”®ç›˜å¼¹å‡ºä¸é®æŒ¡è¾“å…¥æ¡†
- [ ] å›¾ç‰‡è£å‰ªæµç•…
- [ ] æ¨ªå±æ¨¡å¼é€‚é…

**æ€§èƒ½æµ‹è¯•**:
- [ ] 100ä¸ªè§’è‰²åŠ è½½æ—¶é—´
- [ ] 100æ¡æ¶ˆæ¯æ»šåŠ¨æµç•…åº¦
- [ ] å›¾ç‰‡åŠ è½½é€Ÿåº¦
- [ ] ç½‘ç»œæ…¢é€Ÿæ¨¡æ‹Ÿ

**å…¼å®¹æ€§æµ‹è¯•**:
- [ ] iOS Safari 14+
- [ ] Android Chrome 80+
- [ ] å¾®ä¿¡å†…ç½®æµè§ˆå™¨
- [ ] QQæµè§ˆå™¨

### 8.3 ä»£ç å®¡æŸ¥è¦ç‚¹

1. **CSSå“åº”å¼**:
   - æ£€æŸ¥æ‰€æœ‰ `max-width: 768px` åª’ä½“æŸ¥è¯¢
   - ç¡®ä¿æ²¡æœ‰å›ºå®šåƒç´ å€¼å¯¼è‡´æº¢å‡º
   - éªŒè¯è§¦æ‘¸åŒºåŸŸå¤§å°

2. **JavaScriptäº‹ä»¶**:
   - æ£€æŸ¥æ˜¯å¦ä½¿ç”¨touchäº‹ä»¶
   - éªŒè¯ç‚¹å‡»å»¶è¿Ÿæ˜¯å¦æ¶ˆé™¤
   - ç¡®è®¤æ²¡æœ‰é˜»æ­¢é»˜è®¤è¡Œä¸º

3. **æ€§èƒ½**:
   - æ£€æŸ¥æ˜¯å¦æœ‰ä¸å¿…è¦çš„é‡æ¸²æŸ“
   - éªŒè¯å›¾ç‰‡æ˜¯å¦å‹ç¼©
   - ç¡®è®¤APIè¯·æ±‚æ˜¯å¦åˆç†

4. **ç”¨æˆ·ä½“éªŒ**:
   - æ£€æŸ¥åŠ è½½çŠ¶æ€æ˜¯å¦æ˜ç¡®
   - éªŒè¯é”™è¯¯æç¤ºæ˜¯å¦å‹å¥½
   - ç¡®è®¤æ“ä½œåé¦ˆæ˜¯å¦åŠæ—¶

---

## 9. æ€»ç»“ä¸å±•æœ›

### 9.1 é¡¹ç›®ä¼˜åŠ¿

1. **æ¶æ„æ¸…æ™°**: å‰åç«¯åˆ†ç¦»ï¼Œæ¨¡å—åŒ–è®¾è®¡ï¼Œæ˜“äºç»´æŠ¤å’Œæ‰©å±•
2. **åŠŸèƒ½å®Œæ•´**: è¦†ç›–è§’è‰²æ„å»ºã€å¯¹è¯ã€ç®¡ç†ã€æµ‹è¯•çš„å®Œæ•´æµç¨‹
3. **æŠ€æœ¯å…ˆè¿›**: ä½¿ç”¨æœ€æ–°çš„React 19ã€FastAPIã€PostgreSQLç­‰æŠ€æœ¯
4. **å¯æ‰©å±•æ€§å¼º**: æ”¯æŒå¤šç§æ•°æ®æºã€å¤šç§LLMæ¨¡å‹ã€æç¤ºè¯ç‰ˆæœ¬ç®¡ç†
5. **æ€§èƒ½ä¼˜åŒ–**: Redisç¼“å­˜ã€è¿æ¥æ± ã€å¹¶å‘ç”Ÿæˆç­‰ä¼˜åŒ–æªæ–½
6. **å·²æœ‰ç§»åŠ¨ç«¯åŸºç¡€**: å“åº”å¼CSSå·²ç»æ¯”è¾ƒå®Œå–„ï¼Œåªéœ€ä¿®å¤å…³é”®é—®é¢˜

### 9.2 ç§»åŠ¨ç«¯é€‚é…æ€»ç»“

#### å½“å‰çŠ¶æ€
- âœ… å“åº”å¼å¸ƒå±€æ¡†æ¶å®Œæ•´
- âœ… ä¾§è¾¹æ æŠ½å±‰è®¾è®¡å·²å®ç°
- âš ï¸ å…³é”®åŠŸèƒ½è¢«é”™è¯¯éšè—ï¼ˆæ±‰å ¡èœå•ï¼‰
- âŒ è§¦æ‘¸ä¼˜åŒ–ä¸è¶³
- âŒ ç¼ºå°‘ç§»åŠ¨ç«¯ç‰¹æœ‰åŠŸèƒ½

#### æ”¹è¿›æ½œåŠ›
- **çŸ­æœŸ**ï¼ˆ1-2å‘¨ï¼‰: ä¿®å¤å…³é”®é—®é¢˜ï¼Œè¾¾åˆ°åŸºæœ¬å¯ç”¨
- **ä¸­æœŸ**ï¼ˆ1ä¸ªæœˆï¼‰: å®Œæˆæ‰€æœ‰P1ä¼˜åŒ–ï¼Œä½“éªŒæ˜¾è‘—æå‡
- **é•¿æœŸ**ï¼ˆ2-3ä¸ªæœˆï¼‰: å®Œå–„PWAã€æ‰‹åŠ¿æ“ä½œç­‰é«˜çº§åŠŸèƒ½

### 9.3 å»ºè®®çš„ä¸‹ä¸€æ­¥

#### ç«‹å³æ‰§è¡Œ
1. ä¿®å¤æ±‰å ¡èœå•æ˜¾ç¤ºé—®é¢˜ï¼ˆ1å°æ—¶ï¼‰
2. æ·»åŠ viewport metaæ ‡ç­¾ï¼ˆ10åˆ†é’Ÿï¼‰
3. åœ¨çœŸæœºä¸Šæµ‹è¯•åŸºæœ¬åŠŸèƒ½ï¼ˆ1å°æ—¶ï¼‰

#### æœ¬å‘¨å®Œæˆ
1. è§¦æ‘¸ä¼˜åŒ–ï¼ˆè°ƒæ•´æŒ‰é’®å¤§å°ã€ç§»é™¤ç‚¹å‡»é«˜äº®ï¼‰
2. é”®ç›˜é®æŒ¡å¤„ç†
3. é•¿æŒ‰èœå•åŠŸèƒ½

#### æœ¬æœˆå®Œæˆ
1. è™šæ‹Ÿæ»šåŠ¨ä¼˜åŒ–
2. éª¨æ¶å±åŠ è½½
3. ç¦»çº¿æ£€æµ‹
4. å›¾ç‰‡è£å‰ªä¼˜åŒ–

#### é•¿æœŸè§„åˆ’
1. PWAæ”¯æŒ
2. æ‰‹åŠ¿æ“ä½œ
3. æ·±è‰²æ¨¡å¼
4. æ€§èƒ½ç›‘æ§

### 9.4 æŠ€æœ¯å€ºåŠ¡

1. **å‰ç«¯è·¯ç”±**: è€ƒè™‘å¼•å…¥React Routerè¿›è¡Œæ›´è§„èŒƒçš„è·¯ç”±ç®¡ç†
2. **çŠ¶æ€ç®¡ç†**: å¤§å‹åº”ç”¨å¯è€ƒè™‘å¼•å…¥Reduxæˆ–Zustand
3. **ç»„ä»¶åº“**: è€ƒè™‘å¼•å…¥Ant Design Mobileæˆ–ç±»ä¼¼ç»„ä»¶åº“
4. **æµ‹è¯•è¦†ç›–**: æ·»åŠ å•å…ƒæµ‹è¯•å’ŒE2Eæµ‹è¯•
5. **å›½é™…åŒ–**: æ”¯æŒå¤šè¯­è¨€ï¼ˆi18nï¼‰
6. **ä¸»é¢˜ç³»ç»Ÿ**: å®ç°å®Œæ•´çš„ä¸»é¢˜åˆ‡æ¢æœºåˆ¶

### 9.5 é£é™©ä¸æŒ‘æˆ˜

1. **å…¼å®¹æ€§**: å¾®ä¿¡å†…ç½®æµè§ˆå™¨çš„å…¼å®¹æ€§é—®é¢˜å¯èƒ½éœ€è¦ç‰¹æ®Šå¤„ç†
2. **æ€§èƒ½**: å¤§é‡æ¶ˆæ¯å’Œè§’è‰²å¯èƒ½å¯¼è‡´æ€§èƒ½ç“¶é¢ˆ
3. **ç½‘ç»œ**: å¼±ç½‘ç¯å¢ƒä¸‹çš„ç”¨æˆ·ä½“éªŒéœ€è¦ä¼˜åŒ–
4. **å®‰å…¨**: Cookieè®¤è¯åœ¨ç§»åŠ¨ç«¯å¯èƒ½æœ‰è·¨åŸŸé—®é¢˜
5. **æˆæœ¬**: PWAã€æ‰‹åŠ¿æ“ä½œç­‰é«˜çº§åŠŸèƒ½å¼€å‘æˆæœ¬è¾ƒé«˜

### 9.6 ç»“è®º

FastNPCæ˜¯ä¸€ä¸ª**æ¶æ„ä¼˜ç§€ã€åŠŸèƒ½å®Œæ•´**çš„AIè§’è‰²å¯¹è¯å¹³å°ï¼Œä½†**ç§»åŠ¨ç«¯é€‚é…å­˜åœ¨å…³é”®ç¼ºé™·**ã€‚å¥½æ¶ˆæ¯æ˜¯ï¼š

1. âœ… å“åº”å¼CSSæ¡†æ¶å·²ç»æ¯”è¾ƒå®Œå–„
2. âœ… å¤§éƒ¨åˆ†ç§»åŠ¨ç«¯é€‚é…å·²ç»åšäº†ï¼Œåªæ˜¯è¢«é”™è¯¯é…ç½®éšè—
3. âœ… ä¿®å¤æˆæœ¬ä½ï¼Œåªéœ€è°ƒæ•´å°‘é‡ä»£ç å³å¯æ˜¾è‘—æ”¹å–„

**å»ºè®®**ï¼š
- **ç«‹å³ä¿®å¤**æ±‰å ¡èœå•æ˜¾ç¤ºé—®é¢˜ï¼ˆP0ï¼‰
- **æœ¬å‘¨å®Œæˆ**è§¦æ‘¸ä¼˜åŒ–å’Œé”®ç›˜å¤„ç†ï¼ˆP1ï¼‰
- **æœ¬æœˆå®Œæˆ**æ€§èƒ½ä¼˜åŒ–å’Œé«˜çº§åŠŸèƒ½ï¼ˆP2ï¼‰

é€šè¿‡ç³»ç»Ÿæ€§çš„ç§»åŠ¨ç«¯ä¼˜åŒ–ï¼ŒFastNPCæœ‰æ½œåŠ›æˆä¸ºä¸€ä¸ª**æ¡Œé¢ç«¯å’Œç§»åŠ¨ç«¯ä½“éªŒéƒ½å¾ˆå‡ºè‰²**çš„AIå¯¹è¯å¹³å°ï¼

---

## é™„å½•

### A. ç›¸å…³æ–‡ä»¶æ¸…å•

#### å‰ç«¯æ–‡ä»¶
```
web/fastnpc-web/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ App.tsx                    # ä¸»åº”ç”¨ â­ éœ€ä¿®æ”¹
â”‚   â”œâ”€â”€ styles/
â”‚   â”‚   â”œâ”€â”€ responsive.css         # å“åº”å¼æ ·å¼ â­ éœ€ä¿®æ”¹
â”‚   â”‚   â”œâ”€â”€ variables.css          # CSSå˜é‡
â”‚   â”‚   â””â”€â”€ layout.css             # å¸ƒå±€æ ·å¼
â”‚   â””â”€â”€ components/
â”‚       â”œâ”€â”€ Sidebar.tsx            # ä¾§è¾¹æ  â­ éœ€ä¿®æ”¹
â”‚       â””â”€â”€ ImageCropper.tsx       # å›¾ç‰‡è£å‰ª â­ éœ€ä¿®æ”¹
â”œâ”€â”€ index.html                     # HTMLå…¥å£ â­ éœ€ä¿®æ”¹
â””â”€â”€ vite.config.ts                 # Viteé…ç½® â­ éœ€ä¿®æ”¹ï¼ˆPWAï¼‰
```

#### åç«¯æ–‡ä»¶
```
fastnpc/
â”œâ”€â”€ api/
â”‚   â”œâ”€â”€ server.py                  # APIæœåŠ¡å™¨å…¥å£
â”‚   â””â”€â”€ routes/                    # APIè·¯ç”±
â”‚       â”œâ”€â”€ character_routes.py
â”‚       â”œâ”€â”€ chat_routes.py
â”‚       â”œâ”€â”€ group_routes.py
â”‚       â””â”€â”€ avatar_routes.py
â”œâ”€â”€ chat/
â”‚   â”œâ”€â”€ prompt_builder.py          # Promptæ„å»º
â”‚   â””â”€â”€ memory_manager.py          # è®°å¿†ç®¡ç†
â”œâ”€â”€ datasources/
â”‚   â”œâ”€â”€ baike.py                   # ç™¾åº¦ç™¾ç§‘
â”‚   â””â”€â”€ zhwiki.py                  # ç»´åŸºç™¾ç§‘
â””â”€â”€ config.py                      # é…ç½®ç®¡ç†
```

### B. å…³é”®é…ç½®å‚æ•°

```ini
# ç§»åŠ¨ç«¯ç›¸å…³é…ç½®
FASTNPC_FRONTEND_ORIGIN=https://yourdomain.com  # ç”Ÿäº§ç¯å¢ƒåŸŸå

# æ€§èƒ½ä¼˜åŒ–
DB_POOL_MAX_CONN=50               # è¿æ¥æ± å¤§å°
REDIS_HOST=localhost              # Redisç¼“å­˜
FASTNPC_MAX_CONCURRENCY=4         # å¹¶å‘åº¦

# PWAç›¸å…³
# éœ€è¦HTTPSæ‰èƒ½å¯ç”¨Service Worker
```

### C. å¸¸ç”¨å‘½ä»¤

```bash
# å¼€å‘ç¯å¢ƒ
cd web/fastnpc-web
npm run dev -- --host --port 5173

# ç”Ÿäº§æ„å»º
npm run build

# åç«¯å¯åŠ¨
uvicorn fastnpc.api.server:app --host 0.0.0.0 --port 8000

# ç§»åŠ¨ç«¯è°ƒè¯•ï¼ˆä½¿ç”¨æ‰‹æœºè®¿é—®ï¼‰
# 1. ç¡®ä¿ç”µè„‘å’Œæ‰‹æœºåœ¨åŒä¸€å±€åŸŸç½‘
# 2. å¯åŠ¨å¼€å‘æœåŠ¡å™¨ï¼ˆ--hostå‚æ•°å¾ˆé‡è¦ï¼‰
# 3. æ‰‹æœºæµè§ˆå™¨è®¿é—®: http://<ç”µè„‘IP>:5173
```

### D. ç§»åŠ¨ç«¯è°ƒè¯•æŠ€å·§

1. **Chrome DevTools ç§»åŠ¨ç«¯æ¨¡æ‹Ÿ**:
   - F12 â†’ Toggle device toolbar
   - é€‰æ‹©è®¾å¤‡å‹å·
   - å¼€å¯è§¦æ‘¸æ¨¡æ‹Ÿ

2. **çœŸæœºè°ƒè¯•**:
   - iOS: Safari â†’ å¼€å‘ â†’ æ‰‹æœºåç§°
   - Android: Chrome â†’ chrome://inspect

3. **Erudaè°ƒè¯•å·¥å…·**ï¼ˆç§»åŠ¨ç«¯consoleï¼‰:
   ```html
   <script src="//cdn.jsdelivr.net/npm/eruda"></script>
   <script>eruda.init();</script>
   ```

4. **ç½‘ç»œè°ƒè¯•**:
   - Chrome DevTools â†’ Network â†’ Throttling â†’ Slow 3G

---

**æ–‡æ¡£ç»“æŸ**

*å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·è”ç³»å¼€å‘å›¢é˜Ÿ*

