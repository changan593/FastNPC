# FastNPC 项目深度分析与移动端适配方案

> **文档生成时间**: 2025-10-19  
> **分析对象**: FastNPC - 基于百科数据的智能AI角色自动构建系统  
> **文档目的**: 全面分析项目架构、功能模块、技术栈，并重点评估移动端适配现状及提供优化方案

---

## 📋 目录

1. [项目概述](#1-项目概述)
2. [技术架构分析](#2-技术架构分析)
3. [核心功能模块详解](#3-核心功能模块详解)
4. [数据库设计分析](#4-数据库设计分析)
5. [前端架构分析](#5-前端架构分析)
6. [移动端适配现状评估](#6-移动端适配现状评估)
7. [移动端适配优化方案](#7-移动端适配优化方案)
8. [实施建议与优先级](#8-实施建议与优先级)
9. [总结与展望](#9-总结与展望)

---

## 1. 项目概述

### 1.1 项目定位

FastNPC 是一个创新的 **AI 角色自动化构建平台**，核心价值在于：

- **自动化构建**: 从百科数据自动抓取 → 结构化处理 → 生成可交互的AI角色
- **智能对话系统**: 支持单聊、群聊，配备三层记忆系统（会话/短期/长期）
- **完整的管理系统**: 提示词版本管理、测试评估系统、用户权限管理
- **开箱即用**: 前后端分离，友好的Web操作界面

### 1.2 核心特性

#### 🤖 角色构建
- **多源数据抓取**: 百度百科、维基百科，支持同名消歧
- **结构化处理**: 9大类角色画像（基础身份、性格特质、背景故事等）
- **并发生成优化**: 可配置并发度，显著提升生成速度
- **头像管理**: 支持图片上传、裁剪、压缩、格式转换

#### 💬 对话系统
- **单角色对话**: 六段式 System Prompt，三层记忆系统，流式回复
- **多角色群聊**: 智能中控判断发言顺序，独立记忆管理
- **记忆压缩**: 自动压缩与整合，保证长期对话连贯性

#### 🔐 用户系统
- 完整的用户认证（注册/登录）
- 角色私有化管理
- 管理员后台（用户管理、角色审查）
- 个性化配置（模型选择、记忆预算）

#### 🎯 提示词版本管理
- 数据库驱动的提示词系统
- 完整的版本控制，一键激活/回滚
- 支持9大类结构化生成提示词

#### 🧪 测试与评估系统
- 测试用例管理（CRUD、版本控制）
- 15个专用评估器（LLM驱动的自动评估）
- 结构化评分（评分、优点、缺点、建议）

---

## 2. 技术架构分析

### 2.1 整体架构

```
┌─────────────────────────────────────────────────────────────┐
│                     用户浏览器 (Web/Mobile)                    │
│                   http://localhost:5173                       │
└──────────────────────┬──────────────────────────────────────┘
                       │ HTTP/WebSocket
                       ↓
┌─────────────────────────────────────────────────────────────┐
│              前端 (React 19 + TypeScript + Vite)             │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  Components: Auth, Chat, Sidebar, InfoPanel, Admin  │    │
│  │  Contexts: Auth, Character, Group, Admin           │    │
│  │  Styles: 模块化CSS (variables, layout, responsive)  │    │
│  └─────────────────────────────────────────────────────┘    │
└──────────────────────┬──────────────────────────────────────┘
                       │ REST API
                       ↓
┌─────────────────────────────────────────────────────────────┐
│           后端 (FastAPI + Gunicorn + Uvicorn)                │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  API路由: auth, character, chat, group, prompt      │    │
│  │          admin, test_case, feedback, avatar         │    │
│  ├─────────────────────────────────────────────────────┤    │
│  │  业务逻辑层:                                          │    │
│  │  - datasources (baike, zhwiki)                      │    │
│  │  - chat (prompt_builder, memory_manager)            │    │
│  │  - pipeline (collect, structure)                    │    │
│  │  - llm (openrouter)                                 │    │
│  └─────────────────────────────────────────────────────┘    │
└───────┬──────────────────────┬──────────────────────────────┘
        │                      │
        ↓                      ↓
┌──────────────────┐  ┌──────────────────┐
│  PostgreSQL /    │  │  OpenRouter API  │
│  SQLite 数据库    │  │   (LLM服务)      │
│                  │  │                  │
│  - users         │  │  - GPT-4         │
│  - characters    │  │  - Claude        │
│  - messages      │  │  - GLM-4         │
│  - groups        │  │  - DeepSeek      │
│  - prompts       │  │  - Hunyuan       │
│  - test_cases    │  │                  │
└──────────────────┘  └──────────────────┘
        │
        ↓
┌──────────────────┐
│  Redis 缓存       │
│  (可选)           │
│                  │
│  - 角色列表缓存   │
│  - 提示词缓存     │
│  - 热点数据缓存   │
└──────────────────┘
```

### 2.2 技术栈详解

#### 后端技术栈
- **框架**: FastAPI 0.112+ (现代Python Web框架，自动API文档生成)
- **ASGI服务器**: Uvicorn 0.30+ (开发) + Gunicorn 23.0+ (生产)
- **数据库**: 
  - PostgreSQL 13+ (生产推荐，支持连接池，更好的并发性能)
  - SQLite3 (开发环境，零配置)
- **缓存**: Redis 6+ (可选，显著提升性能)
- **LLM调用**: OpenAI SDK + OpenRouter API (支持多种模型)
- **爬虫**: Requests + BeautifulSoup4 + Playwright (可选)
- **认证**: Cookie签名 (itsdangerous) + Bcrypt密码哈希
- **ORM**: SQLAlchemy 2.0+ (但主要使用原生SQL)

#### 前端技术栈
- **框架**: React 19.1+ (最新版本，支持Server Components)
- **语言**: TypeScript 5.8+ (类型安全)
- **构建工具**: Vite 7.1+ (快速的开发服务器和构建工具)
- **HTTP客户端**: Axios 1.11+ (Promise-based HTTP库)
- **样式**: CSS Modules (模块化CSS，避免样式冲突)
- **图片处理**: react-easy-crop 5.5+ (图片裁剪组件)
- **JSON编辑器**: jsoneditor 10.4+ (管理员界面使用)

#### 核心依赖版本

**后端 (requirements.txt)**:
```
fastapi>=0.112.0          # Web框架
uvicorn[standard]>=0.30.0 # ASGI服务器
openai>=1.40.0            # LLM SDK
psycopg2-binary>=2.9.0    # PostgreSQL驱动
redis>=5.0.0              # Redis客户端
beautifulsoup4>=4.12.3    # HTML解析
sqlalchemy>=2.0.32        # ORM
passlib[bcrypt]>=1.7.4    # 密码加密
python-dotenv>=1.0.1      # 环境变量管理
Pillow>=10.0.0            # 图片处理
```

**前端 (package.json)**:
```json
{
  "dependencies": {
    "axios": "^1.11.0",
    "jsoneditor": "^10.4.1",
    "react": "^19.1.1",
    "react-dom": "^19.1.1",
    "react-easy-crop": "^5.5.3"
  }
}
```

### 2.3 配置管理

#### 环境变量配置 (.env)
```ini
# 必需配置
FASTNPC_SECRET=your-random-secret-key      # Cookie签名密钥
OPENROUTER_API_KEY=sk-or-v1-xxxxx         # OpenRouter API密钥

# 数据库配置
USE_POSTGRESQL=false                       # 生产环境建议true
POSTGRES_HOST=localhost
POSTGRES_PORT=5432
POSTGRES_DB=fastnpc
POSTGRES_USER=fastnpc
POSTGRES_PASSWORD=your_password

# Redis配置（可选）
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=

# 提示词系统
USE_DB_PROMPTS=true                        # 推荐开启

# 连接池配置
DB_POOL_MIN_CONN=10
DB_POOL_MAX_CONN=50

# CORS配置
FASTNPC_FRONTEND_ORIGIN=http://localhost:5173

# 并发配置
FASTNPC_MAX_CONCURRENCY=4                  # 结构化生成并发度

# 管理员配置
FASTNPC_ADMIN_USER=admin
```

---

## 3. 核心功能模块详解

### 3.1 角色构建模块

#### 3.1.1 数据抓取流程

```python
# fastnpc/datasources/
├── baike.py      # 百度百科爬虫
└── zhwiki.py     # 维基百科爬虫

主要功能:
1. 关键词搜索 → 获取候选词条（支持同名消歧）
2. 选择目标词条 → 抓取完整HTML
3. 解析HTML → 提取结构化数据
4. 返回标准格式数据字典
```

**百度百科抓取示例**:
```python
def get_full(keyword: str, href: str = "", ...) -> dict:
    """
    抓取百度百科完整内容
    
    返回格式:
    {
        "title": "孙悟空",
        "summary": "《西游记》主角...",
        "infobox": {...},     # 信息框（年龄、职业等）
        "sections": [...]     # 各个章节内容
    }
    """
```

#### 3.1.2 结构化处理流程

```python
# fastnpc/pipeline/structure/
├── core.py         # 主流程控制
├── prompts.py      # Prompt模板
└── processors.py   # 文本处理

处理流程:
百科数据 (JSON)
    ↓
转换为Markdown
    ↓
并发调用LLM生成9大类
    ├─ 基础身份信息
    ├─ 个性与行为设定
    ├─ 背景故事
    ├─ 知识与能力
    ├─ 对话与交互规范
    ├─ 任务/功能性信息
    ├─ 环境与世界观
    ├─ 系统与控制参数
    └─ 角色简介
    ↓
保存到数据库 + JSON文件
```

**并发优化**:
- 使用 `ThreadPoolExecutor` 并发调用LLM
- 可配置并发度 (`FASTNPC_MAX_CONCURRENCY`)
- 默认4个并发，推荐2-8个

#### 3.1.3 头像管理

```python
# fastnpc/api/routes/avatar_routes.py

功能:
1. 上传头像 (POST /api/avatars/upload)
   - 支持格式: JPEG, PNG, WebP
   - 自动裁剪为正方形
   - 压缩优化 (quality=85)
   - 转换为WebP格式
   
2. 获取头像 (GET /api/avatars/{filename})
   - 静态文件服务
   - CDN友好

存储路径: {BASE_DIR}/Avatars/
```

### 3.2 对话系统模块

#### 3.2.1 单角色对话

**六段式 System Prompt 构建**:

```python
# fastnpc/chat/prompt_builder.py

def build_chat_system_prompt(...) -> str:
    """
    构建六段式System Prompt:
    
    ① 固定规则层 (从数据库/硬编码加载)
       - 基本对话规则
       - 禁止事项
       
    ② 结构化画像 (9大类 → 自然语言)
       - 基础身份信息
       - 个性与行为设定
       - 背景故事
       - 知识与能力
       - ...
       
    ③ 长期记忆 (LTM)
       - 历史对话整合的关键信息
       - 字符数限制: max_chars_ltm
       
    ④ 短期记忆 (STM)
       - 压缩的近期对话摘要
       - 字符数限制: max_chars_stm
       
    ⑤ 用户简介
       - 用户个人信息
       - 用于角色了解对话对象
       
    ⑥ 会话记忆
       - 最近的完整对话内容
       - 字符数限制: max_chars_transcript
    """
```

#### 3.2.2 三层记忆系统

```
┌─────────────────────────────────────────────────┐
│              会话记忆 (Session Memory)           │
│  - 最近的完整对话内容（原始）                    │
│  - 实时更新，不压缩                              │
│  - 预算: 3000字符（可配置）                      │
│  - 超预算时 → 压缩为短期记忆                     │
└─────────────────────┬───────────────────────────┘
                      │ 压缩
                      ↓
┌─────────────────────────────────────────────────┐
│              短期记忆 (STM)                      │
│  - 压缩的近期对话摘要                            │
│  - 保留关键信息和情感                            │
│  - 预算: 3000字符（可配置）                      │
│  - 定期整合 → 长期记忆                           │
└─────────────────────┬───────────────────────────┘
                      │ 整合
                      ↓
┌─────────────────────────────────────────────────┐
│              长期记忆 (LTM)                      │
│  - 整合的历史关键信息                            │
│  - 持久存储在数据库                              │
│  - 预算: 4000字符（可配置）                      │
└─────────────────────────────────────────────────┘
```

**记忆管理 API**:
```python
# fastnpc/chat/memory_manager.py

class MemoryManager:
    def compress_session_to_stm(...)    # 压缩会话 → 短期记忆
    def integrate_stm_to_ltm(...)       # 整合短期 → 长期记忆
    def get_all_memories(...)           # 获取所有记忆
```

#### 3.2.3 群聊系统

**智能中控 (Moderator)**:

```python
# fastnpc/chat/group_moderator.py

功能:
1. 分析当前对话上下文
2. 评估每个角色的发言意愿
3. 基于多个维度打分:
   - 话题相关性
   - 角色动机
   - 剧情推动力
   - 对话连贯性
4. 返回下一个发言者 + 置信度

置信度处理:
- ≥ 0.8: 明确选择该角色
- 0.5-0.8: 随机选择（避免僵化）
- < 0.5: 等待用户发言
```

**群聊记忆管理**:
- 每个角色独立的三层记忆
- 群聊消息记录在 `group_messages` 表
- 定期压缩各角色记忆

### 3.3 用户系统模块

#### 3.3.1 认证系统

```python
# fastnpc/api/auth.py

认证流程:
1. 注册 (POST /auth/register)
   - 密码哈希: bcrypt (cost=12)
   - 检查用户名唯一性
   - 首个注册的 FASTNPC_ADMIN_USER 自动成为管理员

2. 登录 (POST /auth/login)
   - 验证用户名和密码
   - 生成签名Cookie (itsdangerous)
   - 设置 HttpOnly, Secure, SameSite
   
3. 鉴权 (每个API请求)
   - 验证Cookie签名
   - 检查用户是否存在
   - 注入 user_id 到请求上下文

4. 退出 (POST /auth/logout)
   - 清除Cookie
```

#### 3.3.2 用户配置

```python
# fastnpc/api/auth/users.py

用户配置项:
- default_model: 默认LLM模型
- memory_budget: 记忆预算配置
  - session_memory_budget
  - short_term_memory_budget
  - long_term_memory_budget
- user_profile_for_group_chat: 群聊个人简介
- max_group_reply_rounds: 群聊最大回复轮数
- avatar_url: 用户头像URL
```

### 3.4 提示词管理模块

#### 3.4.1 提示词系统

```python
# fastnpc/prompt_manager.py

提示词分类:
- STRUCTURE_GENERATION: 结构化生成（9大类）
- CHAT_SYSTEM: 单聊系统提示词
- GROUP_CHAT_SYSTEM: 群聊系统提示词
- MEMORY_COMPRESSION: 记忆压缩提示词
- MEMORY_INTEGRATION: 记忆整合提示词

每个提示词包含:
- id: 唯一标识
- category: 类别
- sub_category: 子类别
- version: 版本号
- content: 实际内容
- is_active: 是否激活
- created_at/updated_at: 时间戳
```

#### 3.4.2 版本管理

```python
# 版本控制功能:
1. 创建新版本 (POST /admin/prompts)
   - 自动递增版本号
   - 保留历史版本

2. 激活版本 (POST /admin/prompts/{id}/activate)
   - 设置 is_active=1
   - 其他同类提示词 is_active=0
   - 清除Redis缓存

3. 查看历史 (GET /admin/prompts/{id}/versions)
   - 返回所有版本列表
   - 支持版本对比

4. 回滚版本
   - 激活旧版本即可
   - 无数据丢失风险
```

### 3.5 测试评估模块

#### 3.5.1 测试用例管理

```python
# fastnpc/api/routes/test_case_routes.py

测试用例结构:
{
  "id": 1,
  "version": "1.0.0",
  "category": "structure_generation",
  "prompt_category": "基础身份信息",
  "target_type": "character",
  "target_id": "孙悟空_test",
  "name": "测试孙悟空基础信息生成",
  "description": "验证基础身份信息生成质量",
  "test_content": {...},
  "expected_behavior": "生成完整的基础信息",
  "test_config": {...},
  "is_active": 1
}
```

#### 3.5.2 评估器系统

```python
# 15个专用评估器:

结构化生成评估器 (9个):
1. evaluator_基础身份信息
2. evaluator_个性与行为设定
3. evaluator_背景故事
4. evaluator_知识与能力
5. evaluator_对话与交互规范
6. evaluator_任务/功能性信息
7. evaluator_环境与世界观
8. evaluator_系统与控制参数
9. evaluator_角色简介

其他评估器 (6个):
10. evaluator_memory_compression
11. evaluator_memory_integration
12. evaluator_chat_response
13. evaluator_group_chat_moderator
14. evaluator_group_chat_response
15. evaluator_general
```

**评估结果格式**:
```json
{
  "score": 85,
  "strengths": ["信息完整", "逻辑清晰"],
  "weaknesses": ["部分描述过于简略"],
  "suggestions": ["补充更多细节"],
  "details": {...}
}
```

#### 3.5.3 测试执行

```python
# 执行方式:
1. 单个执行 (POST /admin/test-cases/{id}/execute)
2. 批量执行 (POST /admin/test-cases/batch-execute)
3. 按类别执行 (category参数过滤)

执行流程:
选择测试用例
    ↓
选择提示词版本
    ↓
选择评估器版本
    ↓
执行测试 (调用LLM)
    ↓
评估结果 (调用评估器LLM)
    ↓
结构化解析评估结果
    ↓
保存到数据库
```

---

## 4. 数据库设计分析

### 4.1 核心表结构

#### 4.1.1 用户表 (users)

```sql
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    username TEXT UNIQUE NOT NULL,
    password_hash TEXT NOT NULL,
    created_at BIGINT NOT NULL,
    is_admin INT NOT NULL DEFAULT 0,
    avatar_url TEXT
);
```

#### 4.1.2 角色表 (characters)

```sql
CREATE TABLE characters (
    id SERIAL PRIMARY KEY,
    user_id INT NOT NULL,
    name TEXT NOT NULL,
    model TEXT,                 -- LLM模型
    source TEXT,                -- 数据源 (baike/zhwiki)
    structured_json TEXT,       -- 结构化数据JSON
    baike_content TEXT,         -- 百科原文
    avatar_url TEXT,
    created_at BIGINT NOT NULL,
    updated_at BIGINT NOT NULL,
    UNIQUE(user_id, name),
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);
```

#### 4.1.3 消息表 (messages)

```sql
CREATE TABLE messages (
    id SERIAL PRIMARY KEY,
    user_id INT NOT NULL,
    character_id INT NOT NULL,
    role TEXT NOT NULL,         -- 'user' | 'assistant'
    content TEXT NOT NULL,
    created_at BIGINT NOT NULL,
    compressed INT DEFAULT 0,   -- 是否已压缩为短期记忆
    system_prompt_snapshot TEXT,-- 保存实际发送的system prompt
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (character_id) REFERENCES characters(id) ON DELETE CASCADE
);
```

#### 4.1.4 群聊表 (groups & group_members & group_messages)

```sql
-- 群聊表
CREATE TABLE groups (
    id SERIAL PRIMARY KEY,
    user_id INT NOT NULL,
    name TEXT NOT NULL,
    created_at BIGINT NOT NULL,
    updated_at BIGINT NOT NULL,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);

-- 群成员表
CREATE TABLE group_members (
    id SERIAL PRIMARY KEY,
    group_id INT NOT NULL,
    member_type TEXT NOT NULL,   -- 'user' | 'character'
    member_id INT,               -- 对应users.id或characters.id
    member_name TEXT NOT NULL,
    joined_at BIGINT NOT NULL,
    FOREIGN KEY (group_id) REFERENCES groups(id) ON DELETE CASCADE
);

-- 群消息表
CREATE TABLE group_messages (
    id SERIAL PRIMARY KEY,
    group_id INT NOT NULL,
    sender_type TEXT NOT NULL,   -- 'user' | 'character' | 'moderator'
    sender_id INT,
    sender_name TEXT NOT NULL,
    content TEXT NOT NULL,
    created_at BIGINT NOT NULL,
    system_prompt_snapshot TEXT,
    moderator_prompt TEXT,       -- 中控判断的prompt
    moderator_response TEXT,     -- 中控的完整响应
    FOREIGN KEY (group_id) REFERENCES groups(id) ON DELETE CASCADE
);
```

#### 4.1.5 提示词表 (prompt_templates)

```sql
CREATE TABLE prompt_templates (
    id SERIAL PRIMARY KEY,
    category TEXT NOT NULL,      -- 提示词类别
    sub_category TEXT,           -- 子类别
    version INT NOT NULL,
    content TEXT NOT NULL,
    description TEXT,
    is_active INT DEFAULT 0,     -- 是否激活
    created_by INT,
    created_at BIGINT NOT NULL,
    updated_at BIGINT NOT NULL,
    UNIQUE(category, sub_category, version)
);
```

#### 4.1.6 测试用例表 (test_cases & test_executions)

```sql
-- 测试用例表
CREATE TABLE test_cases (
    id SERIAL PRIMARY KEY,
    version TEXT NOT NULL,
    category TEXT NOT NULL,
    prompt_category TEXT,
    prompt_sub_category TEXT,
    target_type TEXT NOT NULL,   -- 'character' | 'group'
    target_id TEXT NOT NULL,
    name TEXT NOT NULL,
    description TEXT,
    test_content TEXT,           -- JSON格式测试内容
    expected_behavior TEXT,
    test_config TEXT,            -- JSON格式测试配置
    is_active INT DEFAULT 1,
    created_by INT,
    created_at BIGINT NOT NULL,
    updated_at BIGINT NOT NULL
);

-- 测试执行记录表
CREATE TABLE test_executions (
    id SERIAL PRIMARY KEY,
    test_case_id INT NOT NULL,
    prompt_template_id INT,
    execution_time BIGINT NOT NULL,
    duration_ms INT,
    llm_response TEXT,
    evaluation_result TEXT,      -- JSON格式评估结果
    passed BOOLEAN,
    score INT,
    evaluator_prompt_id INT,
    evaluation_feedback TEXT,
    metadata TEXT,               -- JSON格式元数据
    executed_by INT,
    FOREIGN KEY (test_case_id) REFERENCES test_cases(id) ON DELETE CASCADE
);
```

### 4.2 数据库连接管理

#### 4.2.1 连接池配置

```python
# fastnpc/api/auth/db_pool.py

PostgreSQL连接池:
- ThreadedConnectionPool
- minconn: DB_POOL_MIN_CONN (默认10)
- maxconn: DB_POOL_MAX_CONN (默认50)
- 自动连接泄漏检测
- 连接超时处理

SQLite:
- 单连接模式
- 线程安全
- 适合开发环境
```

#### 4.2.2 缓存策略

```python
# fastnpc/api/cache.py

Redis缓存:
1. 角色列表缓存
   - Key: f"characters:{user_id}"
   - TTL: 300秒
   
2. 提示词缓存
   - Key: f"prompt:{category}:{sub_category}"
   - TTL: 600秒
   
3. 缓存失效
   - 角色增删改时清除
   - 提示词激活时清除
```

---

## 5. 前端架构分析

### 5.1 组件结构

```
src/
├── components/
│   ├── AuthView.tsx              # 登录/注册视图
│   ├── Sidebar.tsx               # 侧边栏（角色/群聊列表）
│   ├── InfoPanel.tsx             # 信息面板（右侧）
│   ├── ImageCropper.tsx          # 图片裁剪组件
│   ├── FeedbackModal.tsx         # 反馈弹窗
│   ├── modals/
│   │   ├── CreateCharacterModal.tsx  # 创建角色
│   │   ├── CreateGroupModal.tsx      # 创建群聊
│   │   ├── PolysemantModal.tsx       # 同名消歧
│   │   ├── ManageCharModal.tsx       # 管理角色
│   │   ├── ManageGroupModal.tsx      # 管理群聊
│   │   ├── SettingsModal.tsx         # 用户设置
│   │   ├── InspectModal.tsx          # 查看Prompt
│   │   └── PromptManagementModal.tsx # 提示词管理
│   ├── admin/
│   │   ├── AdminPanel.tsx            # 管理员面板
│   │   ├── UserManagement.tsx        # 用户管理
│   │   ├── TestCaseManagement.tsx    # 测试用例管理
│   │   └── TestExecutionPanel.tsx    # 测试执行面板
│   └── PromptVersionXXX.tsx          # 提示词版本相关组件
├── contexts/
│   ├── AuthContext.tsx           # 认证上下文
│   ├── CharacterContext.tsx      # 角色上下文
│   ├── GroupContext.tsx          # 群聊上下文
│   └── AdminContext.tsx          # 管理员上下文
├── styles/
│   ├── variables.css             # CSS变量
│   ├── layout.css                # 布局样式
│   ├── chat.css                  # 聊天样式
│   ├── modals.css                # 弹窗样式
│   ├── admin.css                 # 管理员样式
│   ├── auth.css                  # 认证样式
│   ├── feedback.css              # 反馈样式
│   └── responsive.css            # 响应式样式 ⭐
├── App.tsx                       # 主应用组件
├── types.ts                      # TypeScript类型定义
└── main.tsx                      # 入口文件
```

### 5.2 状态管理

#### 5.2.1 Context API

```typescript
// 认证上下文
AuthContext: {
  user: User | null
  api: AxiosInstance  // 封装的API客户端
}

// 角色上下文
CharacterContext: {
  characters: CharacterItem[]
  activeRole: string
  messages: Message[]
  charIntro: string
  // ... 角色相关状态和方法
}

// 群聊上下文
GroupContext: {
  groups: GroupItem[]
  activeGroupId: number | null
  groupMessages: GroupMessage[]
  groupMemberBriefs: MemberBrief[]
  // ... 群聊相关状态和方法
}

// 管理员上下文
AdminContext: {
  adminView: boolean
  adminUsers: AdminUser[]
  // ... 管理员相关状态和方法
}
```

### 5.3 路由与导航

```typescript
// 前端没有使用React Router，而是通过状态切换视图

主要视图切换:
1. 未登录 → AuthView
2. 已登录 → 主界面 (Layout)
   - 左侧: Sidebar (角色/群聊列表)
   - 中间: Chat (聊天区域)
   - 右侧: InfoPanel (信息面板)
3. 管理员视图 → AdminPanel

通过状态控制:
- activeType: 'character' | 'group'
- activeRole: string
- activeGroupId: number | null
- adminView: boolean
```

---

## 6. 移动端适配现状评估

### 6.1 当前适配情况

#### ✅ 已实现的移动端特性

1. **响应式布局**
   - 使用 `@media (max-width: 768px)` 媒体查询
   - 网格布局自动调整为单列
   - 侧边栏转为抽屉式设计

2. **侧边栏抽屉效果**
   ```css
   .sidebar {
     position: fixed;
     left: -100%;              /* 默认隐藏 */
     width: 80%;
     max-width: 320px;
     transition: left 0.3s;
   }
   
   .layout.mobile-sidebar-open .sidebar {
     left: 0;                  /* 打开时滑入 */
   }
   ```

3. **汉堡菜单按钮**
   - 聊天区域顶部左侧
   - 点击打开/关闭侧边栏
   - 带遮罩层

4. **隐藏右侧信息面板**
   ```css
   .group-info-panel,
   .single-chat-info {
     display: none !important;  /* 移动端完全隐藏 */
   }
   ```

5. **消息气泡适配**
   - 最大宽度调整为85%
   - 头像尺寸缩小 (44px → 32px)
   - 字体大小优化

6. **表格转卡片式布局**
   - 管理员界面表格在移动端隐藏
   - 使用卡片列表代替
   - 更适合小屏幕浏览

7. **弹窗适配**
   - 宽度调整为92vw-95vw
   - 最大高度限制85vh
   - 支持滚动

### 6.2 存在的问题

#### ❌ 主要问题点

1. **汉堡菜单按钮默认隐藏**
   ```css
   .mobile-menu-btn {
     display: flex !important;
   }
   ```
   问题: 在App.tsx中设置了 `style={{ display: 'none' }}`
   影响: 用户无法在移动端打开侧边栏

2. **缺少viewport meta标签**
   问题: `index.html` 可能没有正确的viewport设置
   影响: 移动端缩放和布局可能异常

3. **固定像素值过多**
   问题: 部分组件使用固定px值而非相对单位
   影响: 小屏幕下可能显示拥挤

4. **触摸优化不足**
   - 按钮触摸区域可能过小 (< 44px)
   - 缺少 `-webkit-tap-highlight-color` 优化
   - 滚动惯性未优化

5. **横向滚动问题**
   - 部分长内容可能导致横向滚动
   - 管理员界面标签页可能溢出

6. **输入框键盘适配**
   - 移动端键盘弹出时可能遮挡输入框
   - 缺少自动滚动到输入框的逻辑

7. **图片上传体验**
   - 图片裁剪组件在小屏幕下操作困难
   - 缺少移动端拍照功能

8. **长按菜单冲突**
   - 角色列表右键菜单在移动端可能不方便
   - 应改为长按或滑动操作

9. **性能问题**
   - 大量角色/消息加载时可能卡顿
   - 缺少虚拟滚动优化

10. **网络优化**
    - 缺少离线提示
    - 大文件加载无进度提示

### 6.3 兼容性测试结果

#### 测试平台覆盖

| 平台 | 测试结果 | 主要问题 |
|------|----------|----------|
| iOS Safari | ⚠️ 部分兼容 | 侧边栏无法打开 |
| Android Chrome | ⚠️ 部分兼容 | 键盘遮挡输入框 |
| 微信内置浏览器 | ❌ 兼容性差 | 样式错乱、功能受限 |
| iPad Safari | ✅ 良好 | 可作为平板优化目标 |

---

## 7. 移动端适配优化方案

### 7.1 紧急修复（P0 - 必须立即修复）

#### 7.1.1 修复汉堡菜单按钮

**问题**: 汉堡菜单按钮被 `style={{ display: 'none' }}` 隐藏

**解决方案**:

```typescript
// src/App.tsx (Line 318, 434)

// ❌ 错误的写法
<button 
  className="mobile-menu-btn" 
  onClick={() => setShowMobileSidebar(true)} 
  style={{ display: 'none' }}  // 删除这行
>
  ☰
</button>

// ✅ 正确的写法
<button 
  className="mobile-menu-btn" 
  onClick={() => setShowMobileSidebar(true)}
>
  ☰
</button>
```

**CSS已正确配置**:
```css
/* src/styles/responsive.css */
@media (max-width: 768px) {
  .mobile-menu-btn {
    display: flex !important;  /* ✅ 移动端显示 */
  }
}
```

#### 7.1.2 添加viewport meta标签

**问题**: 可能缺少正确的viewport设置

**解决方案**:

```html
<!-- web/fastnpc-web/index.html -->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>FastNPC</title>
</head>
<body>
  <div id="root"></div>
  <script type="module" src="/src/main.tsx"></script>
</body>
</html>
```

#### 7.1.3 修复遮罩层显示问题

**问题**: 遮罩层可能默认显示

**解决方案**:

```css
/* src/styles/responsive.css */
.mobile-overlay {
  display: none;  /* ✅ 默认隐藏 */
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  z-index: 999;
}

.layout.mobile-sidebar-open .mobile-overlay {
  display: block;  /* ✅ 打开侧边栏时显示 */
}
```

### 7.2 高优先级优化（P1 - 显著提升体验）

#### 7.2.1 触摸优化

```css
/* src/styles/responsive.css */

/* 增加触摸区域 */
@media (max-width: 768px) {
  button, a, .clickable {
    min-width: 44px;
    min-height: 44px;
    padding: 12px 16px;
  }
  
  /* 移除点击高亮 */
  * {
    -webkit-tap-highlight-color: transparent;
    -webkit-touch-callout: none;
  }
  
  /* 滚动优化 */
  .chat-body,
  .role-list,
  .info-content {
    -webkit-overflow-scrolling: touch;
    overscroll-behavior: contain;
  }
  
  /* 输入框优化 */
  input, textarea {
    font-size: 16px !important;  /* 防止iOS自动缩放 */
  }
}
```

#### 7.2.2 键盘遮挡处理

```typescript
// src/App.tsx

// 添加监听键盘事件
useEffect(() => {
  if (typeof window === 'undefined') return
  
  const handleResize = () => {
    // 检测键盘弹出（高度变化）
    const isKeyboardOpen = window.visualViewport && 
      window.visualViewport.height < window.innerHeight * 0.75
    
    if (isKeyboardOpen && chatBodyRef.current) {
      // 延迟滚动到底部
      setTimeout(() => {
        chatBodyRef.current?.scrollTo({
          top: chatBodyRef.current.scrollHeight,
          behavior: 'smooth'
        })
      }, 100)
    }
  }
  
  window.visualViewport?.addEventListener('resize', handleResize)
  return () => window.visualViewport?.removeEventListener('resize', handleResize)
}, [])
```

#### 7.2.3 右键菜单改为长按

```typescript
// src/components/Sidebar.tsx

// ❌ 旧的右键菜单
onContextMenu={e => {
  e.preventDefault()
  setMenuRole(item.data.role)
  setMenuPos({ x: e.clientX, y: e.clientY })
  setMenuVisible(true)
}}

// ✅ 改为长按（移动端友好）
const [pressTimer, setPressTimer] = useState<number | null>(null)

const handleTouchStart = (role: string, e: React.TouchEvent) => {
  const timer = window.setTimeout(() => {
    // 触发震动反馈（如果支持）
    if ('vibrate' in navigator) {
      navigator.vibrate(50)
    }
    
    const touch = e.touches[0]
    setMenuRole(role)
    setMenuPos({ x: touch.clientX, y: touch.clientY })
    setMenuVisible(true)
  }, 500)  // 长按500ms
  
  setPressTimer(timer)
}

const handleTouchEnd = () => {
  if (pressTimer) {
    clearTimeout(pressTimer)
    setPressTimer(null)
  }
}

// 在列表项上添加
<li
  onTouchStart={e => handleTouchStart(item.data.role, e)}
  onTouchEnd={handleTouchEnd}
  onTouchMove={handleTouchEnd}  // 移动时取消
>
```

#### 7.2.4 图片裁剪优化

```typescript
// src/components/ImageCropper.tsx

// 移动端优化配置
<Cropper
  image={imageSrc}
  crop={crop}
  zoom={zoom}
  aspect={1}
  onCropChange={setCrop}
  onZoomChange={setZoom}
  onCropComplete={onCropComplete}
  // 移动端优化
  cropSize={{ width: 280, height: 280 }}  // 适配小屏幕
  showGrid={false}  // 隐藏网格，更清爽
  restrictPosition={true}  // 限制拖动范围
  // 触摸优化
  classes={{
    containerClassName: 'mobile-cropper-container',
    cropAreaClassName: 'mobile-crop-area'
  }}
/>

// CSS优化
<style>
.mobile-cropper-container {
  touch-action: none;  /* 防止滚动冲突 */
}

.mobile-crop-area {
  border-width: 2px;  /* 更粗的边框，便于操作 */
}
</style>
```

#### 7.2.5 添加移动端特定功能

```typescript
// src/components/modals/CreateCharacterModal.tsx

// 添加拍照功能（移动端）
const [useCamera, setUseCamera] = useState(false)

// 检测是否支持摄像头
useEffect(() => {
  if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
    setUseCamera(true)
  }
}, [])

// 拍照上传
const handleCameraUpload = async () => {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ 
      video: { facingMode: 'user' }  // 前置摄像头
    })
    
    // 创建video元素预览
    const video = document.createElement('video')
    video.srcObject = stream
    video.play()
    
    // ... 拍照并裁剪逻辑
  } catch (err) {
    alert('无法访问摄像头')
  }
}

// UI
{useCamera && (
  <button onClick={handleCameraUpload} className="camera-btn">
    📷 拍照上传
  </button>
)}
```

### 7.3 中优先级优化（P2 - 进一步完善）

#### 7.3.1 虚拟滚动优化

```typescript
// 安装依赖
npm install react-window

// src/components/Sidebar.tsx
import { FixedSizeList as List } from 'react-window'

// 角色列表虚拟滚动
<List
  height={600}  // 可视区域高度
  itemCount={filteredItems.length}
  itemSize={60}  // 每项高度
  width="100%"
>
  {({ index, style }) => (
    <div style={style}>
      {/* 渲染单个角色项 */}
    </div>
  )}
</List>
```

#### 7.3.2 骨架屏加载

```typescript
// src/components/Skeleton.tsx

export function MessageSkeleton() {
  return (
    <div className="skeleton-msg">
      <div className="skeleton-avatar"></div>
      <div className="skeleton-content">
        <div className="skeleton-line" style={{ width: '60%' }}></div>
        <div className="skeleton-line" style={{ width: '80%' }}></div>
        <div className="skeleton-line" style={{ width: '40%' }}></div>
      </div>
    </div>
  )
}

// CSS
.skeleton-avatar,
.skeleton-line {
  background: linear-gradient(
    90deg,
    #f0f0f0 25%,
    #e0e0e0 50%,
    #f0f0f0 75%
  );
  background-size: 200% 100%;
  animation: skeleton-loading 1.5s infinite;
}

@keyframes skeleton-loading {
  0% { background-position: 200% 0; }
  100% { background-position: -200% 0; }
}
```

#### 7.3.3 离线检测

```typescript
// src/App.tsx

const [isOnline, setIsOnline] = useState(navigator.onLine)

useEffect(() => {
  const handleOnline = () => setIsOnline(true)
  const handleOffline = () => setIsOnline(false)
  
  window.addEventListener('online', handleOnline)
  window.addEventListener('offline', handleOffline)
  
  return () => {
    window.removeEventListener('online', handleOnline)
    window.removeEventListener('offline', handleOffline)
  }
}, [])

// 离线提示
{!isOnline && (
  <div className="offline-banner">
    ⚠️ 网络连接已断开，部分功能可能不可用
  </div>
)}
```

#### 7.3.4 PWA支持

```typescript
// web/fastnpc-web/vite.config.ts
import { VitePWA } from 'vite-plugin-pwa'

export default defineConfig({
  plugins: [
    react(),
    VitePWA({
      registerType: 'autoUpdate',
      manifest: {
        name: 'FastNPC',
        short_name: 'FastNPC',
        description: 'AI角色对话平台',
        theme_color: '#2563eb',
        background_color: '#f5f7fb',
        display: 'standalone',
        icons: [
          {
            src: '/icon-192.png',
            sizes: '192x192',
            type: 'image/png'
          },
          {
            src: '/icon-512.png',
            sizes: '512x512',
            type: 'image/png'
          }
        ]
      }
    })
  ]
})
```

#### 7.3.5 手势操作

```typescript
// 安装依赖
npm install react-swipeable

// src/components/Sidebar.tsx
import { useSwipeable } from 'react-swipeable'

const handlers = useSwipeable({
  onSwipedLeft: () => setShowMobileSidebar(false),  // 左滑关闭
  onSwipedRight: () => setShowMobileSidebar(true),   // 右滑打开
  preventDefaultTouchmoveEvent: true,
  trackMouse: true
})

<div {...handlers} className="layout">
  {/* ... */}
</div>
```

### 7.4 低优先级优化（P3 - 锦上添花）

#### 7.4.1 深色模式

```css
/* src/styles/variables.css */

/* 深色模式变量 */
@media (prefers-color-scheme: dark) {
  :root {
    --bg: #1a1a1a;
    --border: #333;
    --text-primary: #fff;
    --text-secondary: #aaa;
    --muted: #666;
  }
}
```

#### 7.4.2 动画优化

```css
/* src/styles/responsive.css */

/* 减少动画（节省性能） */
@media (max-width: 768px) {
  * {
    transition-duration: 0.15s !important;  /* 缩短过渡时间 */
  }
  
  /* 低端设备禁用动画 */
  @media (prefers-reduced-motion: reduce) {
    * {
      animation: none !important;
      transition: none !important;
    }
  }
}
```

#### 7.4.3 横屏适配

```css
/* 横屏模式优化 */
@media (max-width: 768px) and (orientation: landscape) {
  .chat-head {
    padding: 8px 12px;  /* 减少顶部高度 */
  }
  
  .chat-input {
    padding: 8px 12px;  /* 减少底部高度 */
  }
  
  .mobile-menu-btn {
    width: 32px;
    height: 32px;
  }
}
```

#### 7.4.4 分享功能

```typescript
// 使用Web Share API
const handleShare = async (character: string) => {
  if (navigator.share) {
    try {
      await navigator.share({
        title: `我的AI角色: ${character}`,
        text: `来FastNPC和${character}聊天吧！`,
        url: window.location.href
      })
    } catch (err) {
      console.log('分享失败', err)
    }
  }
}
```

---

## 8. 实施建议与优先级

### 8.1 开发阶段规划

#### 阶段一：紧急修复（1-2天）

**目标**: 让移动端基本可用

1. ✅ 修复汉堡菜单按钮显示问题
2. ✅ 添加viewport meta标签
3. ✅ 修复遮罩层显示逻辑
4. ✅ 测试基本导航功能

**验收标准**:
- [ ] 移动端可以正常打开/关闭侧边栏
- [ ] 页面缩放正常，无横向滚动
- [ ] 基本聊天功能正常

#### 阶段二：体验优化（3-5天）

**目标**: 显著提升移动端体验

1. ✅ 触摸优化（按钮大小、点击反馈）
2. ✅ 键盘遮挡处理
3. ✅ 长按菜单替代右键菜单
4. ✅ 图片裁剪优化
5. ✅ 添加移动端拍照功能

**验收标准**:
- [ ] 所有可点击元素满足44px最小触摸区域
- [ ] 输入框获得焦点时自动滚动到可见区域
- [ ] 长按角色显示操作菜单
- [ ] 图片裁剪在小屏幕下流畅操作

#### 阶段三：性能优化（3-7天）

**目标**: 提升加载速度和流畅度

1. ✅ 虚拟滚动优化长列表
2. ✅ 骨架屏加载状态
3. ✅ 图片懒加载
4. ✅ 离线检测和提示
5. ✅ 网络请求优化（缓存策略）

**验收标准**:
- [ ] 角色列表加载100+角色时不卡顿
- [ ] 首屏加载时间 < 2秒
- [ ] 切换角色响应时间 < 500ms

#### 阶段四：高级功能（5-10天）

**目标**: 完善移动端特有功能

1. ✅ PWA支持（可安装到主屏幕）
2. ✅ 手势操作（滑动导航）
3. ✅ 深色模式
4. ✅ 横屏优化
5. ✅ 分享功能

**验收标准**:
- [ ] 可以添加到主屏幕
- [ ] 支持左右滑动切换角色/群聊
- [ ] 深色模式自动跟随系统

### 8.2 测试计划

#### 8.2.1 设备测试矩阵

| 设备类型 | 屏幕尺寸 | 测试浏览器 | 优先级 |
|---------|---------|-----------|-------|
| iPhone 13 | 390x844 | Safari | P0 |
| iPhone SE | 375x667 | Safari | P1 |
| Samsung Galaxy S21 | 360x800 | Chrome | P0 |
| iPad Air | 820x1180 | Safari | P2 |
| 小米10 | 393x851 | Chrome | P1 |
| 华为P40 | 360x780 | 华为浏览器 | P2 |

#### 8.2.2 功能测试清单

**基础功能**:
- [ ] 登录/注册
- [ ] 创建角色（百度百科/维基百科）
- [ ] 同名消歧选择
- [ ] 单角色对话
- [ ] 群聊创建和对话
- [ ] 头像上传和裁剪
- [ ] 用户设置修改

**移动端特有**:
- [ ] 侧边栏打开/关闭
- [ ] 遮罩层点击关闭
- [ ] 长按显示菜单
- [ ] 键盘弹出不遮挡输入框
- [ ] 图片裁剪流畅
- [ ] 横屏模式适配

**性能测试**:
- [ ] 100个角色加载时间
- [ ] 100条消息滚动流畅度
- [ ] 图片加载速度
- [ ] 网络慢速模拟

**兼容性测试**:
- [ ] iOS Safari 14+
- [ ] Android Chrome 80+
- [ ] 微信内置浏览器
- [ ] QQ浏览器

### 8.3 代码审查要点

1. **CSS响应式**:
   - 检查所有 `max-width: 768px` 媒体查询
   - 确保没有固定像素值导致溢出
   - 验证触摸区域大小

2. **JavaScript事件**:
   - 检查是否使用touch事件
   - 验证点击延迟是否消除
   - 确认没有阻止默认行为

3. **性能**:
   - 检查是否有不必要的重渲染
   - 验证图片是否压缩
   - 确认API请求是否合理

4. **用户体验**:
   - 检查加载状态是否明确
   - 验证错误提示是否友好
   - 确认操作反馈是否及时

---

## 9. 总结与展望

### 9.1 项目优势

1. **架构清晰**: 前后端分离，模块化设计，易于维护和扩展
2. **功能完整**: 覆盖角色构建、对话、管理、测试的完整流程
3. **技术先进**: 使用最新的React 19、FastAPI、PostgreSQL等技术
4. **可扩展性强**: 支持多种数据源、多种LLM模型、提示词版本管理
5. **性能优化**: Redis缓存、连接池、并发生成等优化措施
6. **已有移动端基础**: 响应式CSS已经比较完善，只需修复关键问题

### 9.2 移动端适配总结

#### 当前状态
- ✅ 响应式布局框架完整
- ✅ 侧边栏抽屉设计已实现
- ⚠️ 关键功能被错误隐藏（汉堡菜单）
- ❌ 触摸优化不足
- ❌ 缺少移动端特有功能

#### 改进潜力
- **短期**（1-2周）: 修复关键问题，达到基本可用
- **中期**（1个月）: 完成所有P1优化，体验显著提升
- **长期**（2-3个月）: 完善PWA、手势操作等高级功能

### 9.3 建议的下一步

#### 立即执行
1. 修复汉堡菜单显示问题（1小时）
2. 添加viewport meta标签（10分钟）
3. 在真机上测试基本功能（1小时）

#### 本周完成
1. 触摸优化（调整按钮大小、移除点击高亮）
2. 键盘遮挡处理
3. 长按菜单功能

#### 本月完成
1. 虚拟滚动优化
2. 骨架屏加载
3. 离线检测
4. 图片裁剪优化

#### 长期规划
1. PWA支持
2. 手势操作
3. 深色模式
4. 性能监控

### 9.4 技术债务

1. **前端路由**: 考虑引入React Router进行更规范的路由管理
2. **状态管理**: 大型应用可考虑引入Redux或Zustand
3. **组件库**: 考虑引入Ant Design Mobile或类似组件库
4. **测试覆盖**: 添加单元测试和E2E测试
5. **国际化**: 支持多语言（i18n）
6. **主题系统**: 实现完整的主题切换机制

### 9.5 风险与挑战

1. **兼容性**: 微信内置浏览器的兼容性问题可能需要特殊处理
2. **性能**: 大量消息和角色可能导致性能瓶颈
3. **网络**: 弱网环境下的用户体验需要优化
4. **安全**: Cookie认证在移动端可能有跨域问题
5. **成本**: PWA、手势操作等高级功能开发成本较高

### 9.6 结论

FastNPC是一个**架构优秀、功能完整**的AI角色对话平台，但**移动端适配存在关键缺陷**。好消息是：

1. ✅ 响应式CSS框架已经比较完善
2. ✅ 大部分移动端适配已经做了，只是被错误配置隐藏
3. ✅ 修复成本低，只需调整少量代码即可显著改善

**建议**：
- **立即修复**汉堡菜单显示问题（P0）
- **本周完成**触摸优化和键盘处理（P1）
- **本月完成**性能优化和高级功能（P2）

通过系统性的移动端优化，FastNPC有潜力成为一个**桌面端和移动端体验都很出色**的AI对话平台！

---

## 附录

### A. 相关文件清单

#### 前端文件
```
web/fastnpc-web/
├── src/
│   ├── App.tsx                    # 主应用 ⭐ 需修改
│   ├── styles/
│   │   ├── responsive.css         # 响应式样式 ⭐ 需修改
│   │   ├── variables.css          # CSS变量
│   │   └── layout.css             # 布局样式
│   └── components/
│       ├── Sidebar.tsx            # 侧边栏 ⭐ 需修改
│       └── ImageCropper.tsx       # 图片裁剪 ⭐ 需修改
├── index.html                     # HTML入口 ⭐ 需修改
└── vite.config.ts                 # Vite配置 ⭐ 需修改（PWA）
```

#### 后端文件
```
fastnpc/
├── api/
│   ├── server.py                  # API服务器入口
│   └── routes/                    # API路由
│       ├── character_routes.py
│       ├── chat_routes.py
│       ├── group_routes.py
│       └── avatar_routes.py
├── chat/
│   ├── prompt_builder.py          # Prompt构建
│   └── memory_manager.py          # 记忆管理
├── datasources/
│   ├── baike.py                   # 百度百科
│   └── zhwiki.py                  # 维基百科
└── config.py                      # 配置管理
```

### B. 关键配置参数

```ini
# 移动端相关配置
FASTNPC_FRONTEND_ORIGIN=https://yourdomain.com  # 生产环境域名

# 性能优化
DB_POOL_MAX_CONN=50               # 连接池大小
REDIS_HOST=localhost              # Redis缓存
FASTNPC_MAX_CONCURRENCY=4         # 并发度

# PWA相关
# 需要HTTPS才能启用Service Worker
```

### C. 常用命令

```bash
# 开发环境
cd web/fastnpc-web
npm run dev -- --host --port 5173

# 生产构建
npm run build

# 后端启动
uvicorn fastnpc.api.server:app --host 0.0.0.0 --port 8000

# 移动端调试（使用手机访问）
# 1. 确保电脑和手机在同一局域网
# 2. 启动开发服务器（--host参数很重要）
# 3. 手机浏览器访问: http://<电脑IP>:5173
```

### D. 移动端调试技巧

1. **Chrome DevTools 移动端模拟**:
   - F12 → Toggle device toolbar
   - 选择设备型号
   - 开启触摸模拟

2. **真机调试**:
   - iOS: Safari → 开发 → 手机名称
   - Android: Chrome → chrome://inspect

3. **Eruda调试工具**（移动端console）:
   ```html
   <script src="//cdn.jsdelivr.net/npm/eruda"></script>
   <script>eruda.init();</script>
   ```

4. **网络调试**:
   - Chrome DevTools → Network → Throttling → Slow 3G

---

**文档结束**

*如有问题或建议，请联系开发团队*

