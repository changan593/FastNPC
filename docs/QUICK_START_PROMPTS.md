# 📝 提示词版本控制系统 - 快速开始

## 🎉 好消息！

**您的提示词版本控制系统已经完全集成并正在运行！**

根据系统检查结果：
- ✅ 数据库提示词已启用
- ✅ 41个提示词已初始化，24个已激活
- ✅ 所有核心功能模块已接入（100%覆盖）
- ✅ Redis缓存正常工作
- ✅ 变量替换功能正常

---

## 🚀 立即开始使用

### 1. 访问管理界面

启动服务器后，以管理员身份登录，点击**"🎯 提示词与测试管理"**按钮。

### 2. 查看提示词

系统包含三个标签页：
- **🎯 提示词** - 管理所有提示词版本
- **⭐ 评估** - 管理评估提示词
- **🧪 测试用例** - 管理测试用例

### 3. 编辑提示词

1. 在左侧选择类别（如"单聊系统提示"）
2. 在中间查看/编辑提示词内容
3. 修改描述和版本号
4. 点击**"保存"**按钮

### 4. 激活新版本

1. 保存后，点击**"激活"**按钮
2. 系统自动清除缓存
3. **立即生效**！下次调用就会使用新版本

### 5. 版本管理

- **复制版本**: 基于当前版本创建新版本
- **查看历史**: 查看所有历史版本
- **版本切换**: 激活任意历史版本即可回滚

---

## 💡 实际效果测试

### 方式1: 创建新角色

1. 创建一个新角色（会调用结构化生成提示词）
2. 观察生成的角色信息
3. 修改"结构化生成"相关提示词
4. 激活新版本
5. 再创建一个角色，对比效果

### 方式2: 单聊对话

1. 与角色聊天（会调用单聊系统提示词）
2. 修改"单聊系统提示"
3. 激活新版本
4. 继续聊天，观察效果变化

### 方式3: 群聊测试

1. 创建群聊并发送消息
2. 修改"群聊中控"或"群聊角色发言"提示词
3. 激活新版本
4. 继续群聊，观察中控选择的变化

---

## 📊 当前已激活的提示词

根据检查结果，以下提示词已激活：

### 核心功能提示词（11个）
| 类别 | 版本 | 状态 |
|------|------|------|
| 结构化生成 - 基础身份信息 | v1.0.0 | ✅ |
| 结构化生成 - 个性与行为设定 | v1.0.0 | ✅ |
| 结构化生成 - 背景故事 | v1.0.0 | ✅ |
| 结构化系统消息 | v1.0.0 | ✅ |
| 简介生成 | v1.0.0 | ✅ |
| 单聊系统提示 | v1.0.0 | ✅ |
| 单聊短期记忆凝练 | v1.0.0 | ✅ |
| 群聊短期记忆凝练 | v1.0.0 | ✅ |
| 长期记忆整合 | v1.0.0 | ✅ |
| 群聊中控 | v1.0.0 | ✅ |
| 群聊角色发言 | v1.0.0 | ✅ |

### 评估提示词（7个）
| 评估器 | 版本 | 状态 |
|--------|------|------|
| 结构化生成评估器 | v1.0.0 | ✅ |
| 简介生成评估器 | v1.0.0 | ✅ |
| 单聊对话评估器 | v1.0.0 | ✅ |
| 群聊对话评估器 | v1.0.0 | ✅ |
| 短期记忆凝练评估器 | v1.0.0 | ✅ |
| 长期记忆整合评估器 | v1.0.0 | ✅ |
| 群聊中控评估器 | v1.0.0 | ✅ |

---

## 🔄 提示词生效流程

```
┌─────────────────────┐
│ 管理员修改提示词      │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│ 点击"保存"按钮       │ → 更新数据库
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│ 点击"激活"按钮       │ → 设置 is_active=1
└──────────┬──────────┘   → 清除Redis缓存
           │
           ▼
┌─────────────────────┐
│ 下次调用立即生效     │
└─────────────────────┘
```

---

## 🛠️ 常用命令

### 检查系统状态
```bash
python fastnpc/scripts/check_prompt_status.py
```

### 清除提示词缓存
```bash
# 方式1: Python脚本
python -c "
from fastnpc.api.cache import get_redis_cache
cache = get_redis_cache()
deleted = cache.delete_pattern('prompt:active:*')
print(f'清除了 {deleted} 个缓存键')
"

# 方式2: Redis CLI
redis-cli
> DEL prompt:active:SINGLE_CHAT_SYSTEM
> DEL prompt:active:BRIEF_GENERATION
# 或批量清除
> EVAL "return redis.call('del', unpack(redis.call('keys', 'prompt:active:*')))" 0
```

### 重新初始化提示词
```bash
# 初始化核心提示词
python fastnpc/scripts/init_prompts.py

# 初始化评估提示词
python fastnpc/scripts/init_evaluation_prompts.py
```

---

## 📚 支持的变量

不同类别的提示词支持不同的变量替换：

### 结构化生成
- `{persona_name}` - 角色名称

### 简介生成
- `{persona_name}` - 角色名称
- `{person}` - 人称（第一/第三人称）
- `{role_json}` - 角色结构化JSON

### 单聊系统提示
- `{display_name}` - 角色显示名称
- `{user_name}` - 用户名称

### 群聊中控
- `{participants}` - 参与者列表
- `{recent_messages}` - 最近消息

**使用方法**: 在提示词内容中使用 `{变量名}` 格式，系统会自动替换。

---

## ⚠️ 注意事项

### 1. 必须激活才生效
- ❌ 只保存不激活 → 不会生效
- ✅ 保存并激活 → 立即生效

### 2. 缓存机制
- 提示词会被缓存5分钟
- 激活时自动清除缓存
- 如需立即清除，使用上面的命令

### 3. 降级机制
- 如果数据库失败，自动使用硬编码版本
- 系统不会因提示词问题而崩溃
- 在日志中会显示警告信息

### 4. 版本号规范
- 建议使用语义化版本号：`主版本.次版本.修订号`
- 例如：`1.0.0` → `1.1.0` → `1.1.1` → `2.0.0`

---

## 🎯 最佳实践

### 1. 修改提示词的流程

```
1. 复制当前版本 → 创建新版本
2. 修改新版本内容
3. 保存（但不激活）
4. 在测试环境测试效果
5. 确认无问题后激活
6. 观察生产环境效果
7. 如有问题，激活旧版本回滚
```

### 2. 版本管理建议

- ✅ 保留历史版本（便于回滚）
- ✅ 写清楚变更说明
- ✅ 一次只改一个类别
- ✅ 测试后再激活
- ❌ 不要删除旧版本

### 3. 测试建议

- 使用测试用例功能（🧪 标签页）
- 为每个提示词创建专门的测试用例
- 修改后先运行测试，再激活
- 记录测试结果，对比效果

---

## 🆘 故障排除

### Q1: 修改后没有生效？

**检查步骤**:
1. 是否点击了"激活"按钮？
2. 是否有错误日志？
3. Redis缓存是否清除？

**解决方案**:
```bash
# 1. 确认激活状态
python fastnpc/scripts/check_prompt_status.py

# 2. 清除缓存
python -c "from fastnpc.api.cache import get_redis_cache; get_redis_cache().delete_pattern('prompt:active:*')"

# 3. 重启服务器
```

### Q2: 变量没有被替换？

**检查**:
- 变量名是否正确（大小写敏感）
- 是否使用了正确的格式 `{变量名}`

**参考**: 查看本文档"支持的变量"部分

### Q3: 日志显示"降级到硬编码版本"？

**原因**:
- 数据库中没有激活的提示词
- 数据库连接失败

**解决方案**:
```bash
# 检查数据库
python fastnpc/scripts/check_prompt_status.py

# 如果没有提示词，运行初始化
python fastnpc/scripts/init_prompts.py
```

---

## 📖 更多资源

- **详细文档**: [docs/PROMPT_VERSIONING_STATUS.md](./PROMPT_VERSIONING_STATUS.md)
- **API文档**: [docs/API_DOCUMENTATION.md](./API_DOCUMENTATION.md)
- **数据库管理**: [docs/DATABASE_MANAGEMENT.md](./DATABASE_MANAGEMENT.md)

---

## ✨ 总结

**提示词版本控制系统已经完全集成并运行正常！**

您现在可以：
- ✅ 在Web界面修改任何提示词
- ✅ 创建和管理多个版本
- ✅ 激活后立即生效
- ✅ 随时回滚到旧版本
- ✅ 查看修改历史

**开始优化您的提示词，提升系统效果吧！** 🚀


