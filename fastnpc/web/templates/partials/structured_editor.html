<article>
  <header>
    <h2>结构化数据（{{ role }}）</h2>
  </header>

  <!-- JSONEditor 资源（CDN） -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jsoneditor@9.10.5/dist/jsoneditor.min.css">
  <script src="https://cdn.jsdelivr.net/npm/jsoneditor@9.10.5/dist/jsoneditor.min.js"></script>
  
  <!-- Cropper.js 资源（CDN） -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cropperjs@1.6.1/dist/cropper.min.css">
  <script src="https://cdn.jsdelivr.net/npm/cropperjs@1.6.1/dist/cropper.min.js"></script>

  <div class="grid two">
    <div>
      <div class="card">
        <div id="jsoneditor" style="height: 520px;"></div>
        <div class="toolbar">
          <button id="btn-pretty" type="button">格式化</button>
          <button id="btn-validate" type="button">校验</button>
          <button id="btn-download" type="button">下载</button>
          <label class="upload-label">导入<input id="file-input" type="file" accept="application/json,.json" /></label>
          <span class="spacer"></span>
          <button id="btn-save" class="contrast" type="button">保存</button>
          <span id="save-result" class="muted"></span>
        </div>
      </div>
    </div>
    <aside>
      <!-- 角色头像 -->
      <div class="card" style="margin-bottom: 1rem;">
        <h3>角色头像</h3>
        <div style="text-align: center;">
          <div id="avatar-preview" style="
            width: 200px;
            height: 200px;
            margin: 1rem auto;
            border-radius: 16px;
            overflow: hidden;
            border: 2px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f9fafb;
            cursor: pointer;
          " onclick="document.getElementById('avatar-input').click()">
            <img id="avatar-img" src="" alt="角色头像" style="width: 100%; height: 100%; object-fit: cover; display: none;" />
            <div id="avatar-placeholder" style="color: #9ca3af; font-size: 48px;">👤</div>
          </div>
          <input 
            type="file" 
            id="avatar-input" 
            accept="image/*" 
            style="display: none;"
          />
          <div style="margin-top: 0.5rem;">
            <button id="btn-upload-avatar" type="button" style="padding: 0.5rem 1rem; font-size: 14px;">上传头像</button>
            <button id="btn-delete-avatar" type="button" style="padding: 0.5rem 1rem; font-size: 14px; display: none;" class="secondary">删除</button>
          </div>
          <div id="avatar-status" class="muted" style="margin-top: 0.5rem; font-size: 12px;"></div>
          <div class="muted" style="font-size: 12px; margin-top: 0.5rem;">
            支持 JPG、PNG、GIF 等格式，最大10MB<br/>
            上传后可裁剪调整
          </div>
        </div>
      </div>
      
      <!-- 图片裁剪器模态框 -->
      <div id="cropperModal" style="
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.9);
        z-index: 10000;
        flex-direction: column;
      ">
        <div style="position: relative; flex: 1; min-height: 0; padding: 20px;">
          <img id="cropperImage" src="" style="max-width: 100%; max-height: 100%;">
        </div>
        <div style="background: #1f2937; padding: 20px; display: flex; flex-direction: column; gap: 16px;">
          <div style="display: flex; align-items: center; gap: 12px; color: #fff;">
            <span style="font-size: 14px; min-width: 60px;">缩放</span>
            <input type="range" id="cropperZoom" min="0" max="100" step="1" value="0" style="flex: 1;">
            <span id="cropperZoomValue" style="font-size: 14px; min-width: 40px; text-align: right;">1.0x</span>
          </div>
          <div style="color: #9ca3af; font-size: 13px; text-align: center;">
            拖动图片调整位置，使用滑块缩放
          </div>
          <div style="display: flex; gap: 12px;">
            <button id="cropperCancel" type="button" style="flex: 1; padding: 12px; background: #374151; color: #fff; border: none; border-radius: 8px; font-size: 15px; cursor: pointer;">
              取消
            </button>
            <button id="cropperConfirm" type="button" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; border: none; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer;">
              确认裁剪
            </button>
          </div>
        </div>
      </div>
      
      <!-- 关键信息 -->
      <div class="card">
        <h3>关键信息</h3>
        <div class="kv"><span>任务目标</span><em id="kv-goal">—</em></div>
        <div class="kv"><span>对话意图</span><em id="kv-intent">—</em></div>
        <div class="kv"><span>角色姓名</span><em id="kv-name">—</em></div>
        <div class="kv"><span>世界主线</span><em id="kv-world">—</em></div>
      </div>
    </aside>
  </div>

  <!-- 记忆管理 -->
  <div style="margin-top: 2rem;">
    <div class="card">
      <h3>角色记忆</h3>
      <p class="muted" style="margin-bottom: 1rem;">管理角色的短期记忆和长期记忆，每行一条记忆。</p>
      
      <div style="margin-bottom: 1.5rem;">
        <label for="stm-editor">
          <strong>短期记忆 (Short-term Memory)</strong>
          <small class="muted" style="margin-left: 0.5rem;">最近的对话和经历，会自动整合到长期记忆</small>
        </label>
        <textarea 
          id="stm-editor" 
          rows="8" 
          placeholder="每行一条短期记忆..."
          style="width: 100%; font-family: monospace; font-size: 14px; resize: vertical; margin-top: 0.5rem;"
        ></textarea>
        <div class="muted" style="font-size: 12px; margin-top: 0.25rem;">
          <span id="stm-count">0</span> 条记忆
        </div>
      </div>

      <div style="margin-bottom: 1rem;">
        <label for="ltm-editor">
          <strong>长期记忆 (Long-term Memory)</strong>
          <small class="muted" style="margin-left: 0.5rem;">重要的知识和经历，会长期保留</small>
        </label>
        <textarea 
          id="ltm-editor" 
          rows="8" 
          placeholder="每行一条长期记忆..."
          style="width: 100%; font-family: monospace; font-size: 14px; resize: vertical; margin-top: 0.5rem;"
        ></textarea>
        <div class="muted" style="font-size: 12px; margin-top: 0.25rem;">
          <span id="ltm-count">0</span> 条记忆
        </div>
      </div>

      <div class="toolbar">
        <button id="btn-load-memories" type="button">重新加载</button>
        <span class="spacer"></span>
        <button id="btn-save-memories" class="contrast" type="button">保存记忆</button>
        <span id="memories-save-result" class="muted"></span>
      </div>
    </div>
  </div>

  <script>
    // 注入聊天 session
    (function(){
      var el = document.getElementById('chat-session');
      if (el) el.value = '{{ session_id }}';
    })();

    // ===== 头像管理 =====
    (function(){
      const avatarImg = document.getElementById('avatar-img');
      const avatarPlaceholder = document.getElementById('avatar-placeholder');
      const avatarInput = document.getElementById('avatar-input');
      const btnUpload = document.getElementById('btn-upload-avatar');
      const btnDelete = document.getElementById('btn-delete-avatar');
      const avatarStatus = document.getElementById('avatar-status');
      const role = '{{ role }}';
      let currentAvatarUrl = '';
      let cropper = null;
      let pendingFile = null;

      function setAvatarStatus(text, isSuccess) {
        avatarStatus.textContent = text || '';
        avatarStatus.style.color = isSuccess ? 'var(--success, #16a34a)' : 'var(--muted, #6b7280)';
        if (text) {
          setTimeout(() => setAvatarStatus('', false), 3000);
        }
      }

      function displayAvatar(url) {
        if (url) {
          currentAvatarUrl = url;
          avatarImg.src = url;
          avatarImg.style.display = 'block';
          avatarPlaceholder.style.display = 'none';
          btnDelete.style.display = 'inline-block';
        } else {
          currentAvatarUrl = '';
          avatarImg.style.display = 'none';
          avatarPlaceholder.style.display = 'block';
          btnDelete.style.display = 'none';
        }
      }

      async function loadAvatar() {
        try {
          const res = await fetch(`/api/characters/${encodeURIComponent(role)}/structured`);
          const data = await res.json();
          if (data && data._metadata && data._metadata.avatar_url) {
            displayAvatar(data._metadata.avatar_url);
          }
        } catch(e) {
          console.error('加载头像失败:', e);
        }
      }

      function showCropper(file) {
        if (!file) return;
        
        // 验证文件类型
        if (!file.type.startsWith('image/')) {
          setAvatarStatus('只支持图片文件', false);
          return;
        }

        // 验证文件大小（10MB）
        if (file.size > 10 * 1024 * 1024) {
          setAvatarStatus('文件大小不能超过10MB', false);
          return;
        }

        pendingFile = file;
        const reader = new FileReader();
        reader.onload = function(e) {
          const cropperImage = document.getElementById('cropperImage');
          const cropperModal = document.getElementById('cropperModal');
          
          cropperImage.src = e.target.result;
          cropperModal.style.display = 'flex';
          
          // 销毁旧的cropper
          if (cropper) {
            cropper.destroy();
          }
          
          // 创建新的cropper
          cropper = new Cropper(cropperImage, {
            aspectRatio: 1,
            viewMode: 1,
            dragMode: 'move',
            autoCropArea: 1,
            restore: false,
            guides: true,
            center: true,
            highlight: false,
            cropBoxMovable: true,
            cropBoxResizable: true,
            toggleDragModeOnDblclick: false,
          });
          
          // 缩放滑块
          const zoomSlider = document.getElementById('cropperZoom');
          const zoomValue = document.getElementById('cropperZoomValue');
          
          zoomSlider.oninput = function() {
            const zoomRatio = this.value / 100 * 2; // 0-2倍缩放
            cropper.zoomTo(zoomRatio);
            zoomValue.textContent = (1 + zoomRatio).toFixed(1) + 'x';
          };
        };
        reader.readAsDataURL(file);
      }

      function hideCropper() {
        const cropperModal = document.getElementById('cropperModal');
        cropperModal.style.display = 'none';
        if (cropper) {
          cropper.destroy();
          cropper = null;
        }
        pendingFile = null;
        // 重置文件输入
        const avatarInput = document.getElementById('avatar-input');
        avatarInput.value = '';
      }

      async function uploadCroppedImage() {
        if (!cropper) return;
        
        setAvatarStatus('处理中...', false);
        
        // 获取裁剪后的canvas
        const canvas = cropper.getCroppedCanvas({
          width: 512,
          height: 512,
          imageSmoothingEnabled: true,
          imageSmoothingQuality: 'high',
        });
        
        // 转换为blob
        canvas.toBlob(async function(blob) {
          hideCropper();
          
          if (!blob) {
            setAvatarStatus('处理图片失败', false);
            return;
          }
          
          setAvatarStatus('上传中...', false);
          const formData = new FormData();
          formData.append('file', blob, 'avatar.jpg');

          try {
            const res = await fetch(`/api/characters/${encodeURIComponent(role)}/avatar`, {
              method: 'POST',
              body: formData
            });
            
            const data = await res.json();
            
            if (res.ok && data.ok) {
              displayAvatar(data.avatar_url + '?t=' + Date.now());
              setAvatarStatus('上传成功！', true);
              
              // 刷新列表
              if (window.opener && window.opener.postMessage) {
                window.opener.postMessage({ type: 'avatar_updated', role: role }, '*');
              }
            } else {
              setAvatarStatus(data.error || '上传失败', false);
            }
          } catch(e) {
            console.error('上传头像失败:', e);
            setAvatarStatus('上传失败: ' + e.message, false);
          }
        }, 'image/jpeg', 0.92);
      }

      async function deleteAvatar() {
        if (!confirm('确定要删除头像吗？')) return;

        setAvatarStatus('删除中...', false);

        try {
          const res = await fetch(`/api/characters/${encodeURIComponent(role)}/avatar`, {
            method: 'DELETE'
          });
          
          const data = await res.json();
          
          if (res.ok && data.ok) {
            displayAvatar('');
            setAvatarStatus('已删除', true);
            
            // 刷新列表
            if (window.opener && window.opener.postMessage) {
              window.opener.postMessage({ type: 'avatar_updated', role: role }, '*');
            }
          } else {
            setAvatarStatus(data.error || '删除失败', false);
          }
        } catch(e) {
          console.error('删除头像失败:', e);
          setAvatarStatus('删除失败: ' + e.message, false);
        }
      }

      // 事件监听
      avatarInput.addEventListener('change', function(e) {
        const file = e.target.files && e.target.files[0];
        if (file) {
          showCropper(file);
        }
      });
      
      // 裁剪器按钮事件
      document.getElementById('cropperCancel').addEventListener('click', hideCropper);
      document.getElementById('cropperConfirm').addEventListener('click', uploadCroppedImage);

      btnUpload.addEventListener('click', function() {
        avatarInput.click();
      });

      btnDelete.addEventListener('click', deleteAvatar);

      // 支持拖拽上传
      const avatarPreview = document.getElementById('avatar-preview');
      
      avatarPreview.addEventListener('dragover', function(e) {
        e.preventDefault();
        e.stopPropagation();
        avatarPreview.style.borderColor = '#3b82f6';
        avatarPreview.style.background = '#eff6ff';
      });

      avatarPreview.addEventListener('dragleave', function(e) {
        e.preventDefault();
        e.stopPropagation();
        avatarPreview.style.borderColor = '#e5e7eb';
        avatarPreview.style.background = '#f9fafb';
      });

      avatarPreview.addEventListener('drop', function(e) {
        e.preventDefault();
        e.stopPropagation();
        avatarPreview.style.borderColor = '#e5e7eb';
        avatarPreview.style.background = '#f9fafb';

        const files = e.dataTransfer.files;
        if (files && files[0]) {
          uploadAvatar(files[0]);
        }
      });

      // 初始加载头像
      loadAvatar();
    })();

    // 初始化 JSONEditor
    (function(){
      var container = document.getElementById('jsoneditor');
      var options = { modes: ['tree','code'], mode: 'tree' };
      var editor = new JSONEditor(container, options);
      try {
        var initial = JSON.parse({{ content|tojson }});
        editor.set(initial);
      } catch(e) {
        try { editor.set(JSON.parse(String.raw`{{ content }}`)); } catch(_) {}
      }

      function getData(){
        try { return editor.get(); } catch(e) { return null; }
      }

      function setStatus(text, ok){
        var el = document.getElementById('save-result');
        el.textContent = text || '';
        el.style.color = ok ? 'var(--success)' : 'var(--muted)';
      }

      function refreshKV(obj){
        var val = (p, d='—') => {
          try {
            var x = p.split('.').reduce((o,k)=> (o? o[k] : undefined), obj);
            if (x && typeof x === 'string') return x;
            return d;
          } catch(_) { return d; }
        };
        document.getElementById('kv-goal').textContent = val('任务/功能性信息.任务目标');
        document.getElementById('kv-intent').textContent = val('任务/功能性信息.对话意图');
        document.getElementById('kv-name').textContent = val('基础身份信息.姓名');
        var world = val('环境与世界观.世界观_详细.主线');
        if (world === '—') world = val('环境与世界观.世界观');
        document.getElementById('kv-world').textContent = world;
      }

      refreshKV(getData()||{});

      document.getElementById('btn-pretty').addEventListener('click', function(){
        try { editor.update(editor.get()); } catch(_) {}
      });
      document.getElementById('btn-validate').addEventListener('click', function(){
        var data = getData();
        if (data === null) { setStatus('JSON 无效', false); return; }
        setStatus('JSON 语法有效', true);
      });
      document.getElementById('btn-download').addEventListener('click', function(){
        var data = getData();
        if (!data) return;
        var blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
        var a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'structured_{{ role }}.json';
        a.click();
      });
      document.getElementById('file-input').addEventListener('change', function(ev){
        var f = ev.target.files && ev.target.files[0];
        if (!f) return;
        var reader = new FileReader();
        reader.onload = function(){
          try { editor.set(JSON.parse(reader.result)); refreshKV(getData()||{}); setStatus('已导入', true);} catch(e){ setStatus('导入失败: '+e, false); }
        };
        reader.readAsText(f, 'utf-8');
        ev.target.value = '';
      });
      document.getElementById('btn-save').addEventListener('click', async function(){
        var data = getData();
        if (!data) { setStatus('JSON 无效，未保存', false); return; }
        try {
          const res = await fetch('/structured/{{ role }}', { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
          const j = await res.json();
          if (j && j.ok) { setStatus('已保存', true); refreshKV(data); }
          else { setStatus('保存失败', false); }
        } catch(e) { setStatus('保存失败: '+e, false); }
      });
    })();

    // 记忆管理
    (function(){
      var stmEditor = document.getElementById('stm-editor');
      var ltmEditor = document.getElementById('ltm-editor');
      var stmCount = document.getElementById('stm-count');
      var ltmCount = document.getElementById('ltm-count');
      var memoriesSaveResult = document.getElementById('memories-save-result');

      function updateCounts() {
        var stmLines = stmEditor.value.split('\n').filter(line => line.trim()).length;
        var ltmLines = ltmEditor.value.split('\n').filter(line => line.trim()).length;
        stmCount.textContent = stmLines;
        ltmCount.textContent = ltmLines;
      }

      function setMemoriesStatus(text, ok){
        memoriesSaveResult.textContent = text || '';
        memoriesSaveResult.style.color = ok ? 'var(--success)' : 'var(--muted)';
      }

      async function loadMemories() {
        try {
          const res = await fetch('/api/characters/{{ role }}/memories');
          const data = await res.json();
          stmEditor.value = (data.short_term || []).join('\n');
          ltmEditor.value = (data.long_term || []).join('\n');
          updateCounts();
          setMemoriesStatus('已加载', true);
          setTimeout(() => setMemoriesStatus('', false), 2000);
        } catch(e) {
          setMemoriesStatus('加载失败: '+e, false);
        }
      }

      async function saveMemories() {
        try {
          var shortTerm = stmEditor.value.split('\n').filter(line => line.trim());
          var longTerm = ltmEditor.value.split('\n').filter(line => line.trim());
          
          const res = await fetch('/api/characters/{{ role }}/memories', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ short_term: shortTerm, long_term: longTerm })
          });
          const j = await res.json();
          if (j && j.ok) {
            updateCounts();
            setMemoriesStatus('已保存', true);
            setTimeout(() => setMemoriesStatus('', false), 2000);
          } else {
            setMemoriesStatus('保存失败', false);
          }
        } catch(e) {
          setMemoriesStatus('保存失败: '+e, false);
        }
      }

      stmEditor.addEventListener('input', updateCounts);
      ltmEditor.addEventListener('input', updateCounts);
      document.getElementById('btn-load-memories').addEventListener('click', loadMemories);
      document.getElementById('btn-save-memories').addEventListener('click', saveMemories);

      // 初始加载记忆
      loadMemories();
    })();
  </script>
</article>


