<article>
  <header>
    <h2>ç»“æ„åŒ–æ•°æ®ï¼ˆ{{ role }}ï¼‰</h2>
  </header>

  <!-- JSONEditor èµ„æºï¼ˆCDNï¼‰ -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jsoneditor@9.10.5/dist/jsoneditor.min.css">
  <script src="https://cdn.jsdelivr.net/npm/jsoneditor@9.10.5/dist/jsoneditor.min.js"></script>
  
  <!-- Cropper.js èµ„æºï¼ˆCDNï¼‰ -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cropperjs@1.6.1/dist/cropper.min.css">
  <script src="https://cdn.jsdelivr.net/npm/cropperjs@1.6.1/dist/cropper.min.js"></script>

  <div class="grid two">
    <div>
      <div class="card">
        <div id="jsoneditor" style="height: 520px;"></div>
        <div class="toolbar">
          <button id="btn-pretty" type="button">æ ¼å¼åŒ–</button>
          <button id="btn-validate" type="button">æ ¡éªŒ</button>
          <button id="btn-download" type="button">ä¸‹è½½</button>
          <label class="upload-label">å¯¼å…¥<input id="file-input" type="file" accept="application/json,.json" /></label>
          <span class="spacer"></span>
          <button id="btn-save" class="contrast" type="button">ä¿å­˜</button>
          <span id="save-result" class="muted"></span>
        </div>
      </div>
    </div>
    <aside>
      <!-- è§’è‰²å¤´åƒ -->
      <div class="card" style="margin-bottom: 1rem;">
        <h3>è§’è‰²å¤´åƒ</h3>
        <div style="text-align: center;">
          <div id="avatar-preview" style="
            width: 200px;
            height: 200px;
            margin: 1rem auto;
            border-radius: 16px;
            overflow: hidden;
            border: 2px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f9fafb;
            cursor: pointer;
          " onclick="document.getElementById('avatar-input').click()">
            <img id="avatar-img" src="" alt="è§’è‰²å¤´åƒ" style="width: 100%; height: 100%; object-fit: cover; display: none;" />
            <div id="avatar-placeholder" style="color: #9ca3af; font-size: 48px;">ğŸ‘¤</div>
          </div>
          <input 
            type="file" 
            id="avatar-input" 
            accept="image/*" 
            style="display: none;"
          />
          <div style="margin-top: 0.5rem;">
            <button id="btn-upload-avatar" type="button" style="padding: 0.5rem 1rem; font-size: 14px;">ä¸Šä¼ å¤´åƒ</button>
            <button id="btn-delete-avatar" type="button" style="padding: 0.5rem 1rem; font-size: 14px; display: none;" class="secondary">åˆ é™¤</button>
          </div>
          <div id="avatar-status" class="muted" style="margin-top: 0.5rem; font-size: 12px;"></div>
          <div class="muted" style="font-size: 12px; margin-top: 0.5rem;">
            æ”¯æŒ JPGã€PNGã€GIF ç­‰æ ¼å¼ï¼Œæœ€å¤§10MB<br/>
            ä¸Šä¼ åå¯è£å‰ªè°ƒæ•´
          </div>
        </div>
      </div>
      
      <!-- å›¾ç‰‡è£å‰ªå™¨æ¨¡æ€æ¡† -->
      <div id="cropperModal" style="
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.9);
        z-index: 10000;
        flex-direction: column;
      ">
        <div style="position: relative; flex: 1; min-height: 0; padding: 20px;">
          <img id="cropperImage" src="" style="max-width: 100%; max-height: 100%;">
        </div>
        <div style="background: #1f2937; padding: 20px; display: flex; flex-direction: column; gap: 16px;">
          <div style="display: flex; align-items: center; gap: 12px; color: #fff;">
            <span style="font-size: 14px; min-width: 60px;">ç¼©æ”¾</span>
            <input type="range" id="cropperZoom" min="0" max="100" step="1" value="0" style="flex: 1;">
            <span id="cropperZoomValue" style="font-size: 14px; min-width: 40px; text-align: right;">1.0x</span>
          </div>
          <div style="color: #9ca3af; font-size: 13px; text-align: center;">
            æ‹–åŠ¨å›¾ç‰‡è°ƒæ•´ä½ç½®ï¼Œä½¿ç”¨æ»‘å—ç¼©æ”¾
          </div>
          <div style="display: flex; gap: 12px;">
            <button id="cropperCancel" type="button" style="flex: 1; padding: 12px; background: #374151; color: #fff; border: none; border-radius: 8px; font-size: 15px; cursor: pointer;">
              å–æ¶ˆ
            </button>
            <button id="cropperConfirm" type="button" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; border: none; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer;">
              ç¡®è®¤è£å‰ª
            </button>
          </div>
        </div>
      </div>
      
      <!-- å…³é”®ä¿¡æ¯ -->
      <div class="card">
        <h3>å…³é”®ä¿¡æ¯</h3>
        <div class="kv"><span>ä»»åŠ¡ç›®æ ‡</span><em id="kv-goal">â€”</em></div>
        <div class="kv"><span>å¯¹è¯æ„å›¾</span><em id="kv-intent">â€”</em></div>
        <div class="kv"><span>è§’è‰²å§“å</span><em id="kv-name">â€”</em></div>
        <div class="kv"><span>ä¸–ç•Œä¸»çº¿</span><em id="kv-world">â€”</em></div>
      </div>
    </aside>
  </div>

  <!-- è®°å¿†ç®¡ç† -->
  <div style="margin-top: 2rem;">
    <div class="card">
      <h3>è§’è‰²è®°å¿†</h3>
      <p class="muted" style="margin-bottom: 1rem;">ç®¡ç†è§’è‰²çš„çŸ­æœŸè®°å¿†å’Œé•¿æœŸè®°å¿†ï¼Œæ¯è¡Œä¸€æ¡è®°å¿†ã€‚</p>
      
      <div style="margin-bottom: 1.5rem;">
        <label for="stm-editor">
          <strong>çŸ­æœŸè®°å¿† (Short-term Memory)</strong>
          <small class="muted" style="margin-left: 0.5rem;">æœ€è¿‘çš„å¯¹è¯å’Œç»å†ï¼Œä¼šè‡ªåŠ¨æ•´åˆåˆ°é•¿æœŸè®°å¿†</small>
        </label>
        <textarea 
          id="stm-editor" 
          rows="8" 
          placeholder="æ¯è¡Œä¸€æ¡çŸ­æœŸè®°å¿†..."
          style="width: 100%; font-family: monospace; font-size: 14px; resize: vertical; margin-top: 0.5rem;"
        ></textarea>
        <div class="muted" style="font-size: 12px; margin-top: 0.25rem;">
          <span id="stm-count">0</span> æ¡è®°å¿†
        </div>
      </div>

      <div style="margin-bottom: 1rem;">
        <label for="ltm-editor">
          <strong>é•¿æœŸè®°å¿† (Long-term Memory)</strong>
          <small class="muted" style="margin-left: 0.5rem;">é‡è¦çš„çŸ¥è¯†å’Œç»å†ï¼Œä¼šé•¿æœŸä¿ç•™</small>
        </label>
        <textarea 
          id="ltm-editor" 
          rows="8" 
          placeholder="æ¯è¡Œä¸€æ¡é•¿æœŸè®°å¿†..."
          style="width: 100%; font-family: monospace; font-size: 14px; resize: vertical; margin-top: 0.5rem;"
        ></textarea>
        <div class="muted" style="font-size: 12px; margin-top: 0.25rem;">
          <span id="ltm-count">0</span> æ¡è®°å¿†
        </div>
      </div>

      <div class="toolbar">
        <button id="btn-load-memories" type="button">é‡æ–°åŠ è½½</button>
        <span class="spacer"></span>
        <button id="btn-save-memories" class="contrast" type="button">ä¿å­˜è®°å¿†</button>
        <span id="memories-save-result" class="muted"></span>
      </div>
    </div>
  </div>

  <script>
    // æ³¨å…¥èŠå¤© session
    (function(){
      var el = document.getElementById('chat-session');
      if (el) el.value = '{{ session_id }}';
    })();

    // ===== å¤´åƒç®¡ç† =====
    (function(){
      const avatarImg = document.getElementById('avatar-img');
      const avatarPlaceholder = document.getElementById('avatar-placeholder');
      const avatarInput = document.getElementById('avatar-input');
      const btnUpload = document.getElementById('btn-upload-avatar');
      const btnDelete = document.getElementById('btn-delete-avatar');
      const avatarStatus = document.getElementById('avatar-status');
      const role = '{{ role }}';
      let currentAvatarUrl = '';
      let cropper = null;
      let pendingFile = null;

      function setAvatarStatus(text, isSuccess) {
        avatarStatus.textContent = text || '';
        avatarStatus.style.color = isSuccess ? 'var(--success, #16a34a)' : 'var(--muted, #6b7280)';
        if (text) {
          setTimeout(() => setAvatarStatus('', false), 3000);
        }
      }

      function displayAvatar(url) {
        if (url) {
          currentAvatarUrl = url;
          avatarImg.src = url;
          avatarImg.style.display = 'block';
          avatarPlaceholder.style.display = 'none';
          btnDelete.style.display = 'inline-block';
        } else {
          currentAvatarUrl = '';
          avatarImg.style.display = 'none';
          avatarPlaceholder.style.display = 'block';
          btnDelete.style.display = 'none';
        }
      }

      async function loadAvatar() {
        try {
          const res = await fetch(`/api/characters/${encodeURIComponent(role)}/structured`);
          const data = await res.json();
          if (data && data._metadata && data._metadata.avatar_url) {
            displayAvatar(data._metadata.avatar_url);
          }
        } catch(e) {
          console.error('åŠ è½½å¤´åƒå¤±è´¥:', e);
        }
      }

      function showCropper(file) {
        if (!file) return;
        
        // éªŒè¯æ–‡ä»¶ç±»å‹
        if (!file.type.startsWith('image/')) {
          setAvatarStatus('åªæ”¯æŒå›¾ç‰‡æ–‡ä»¶', false);
          return;
        }

        // éªŒè¯æ–‡ä»¶å¤§å°ï¼ˆ10MBï¼‰
        if (file.size > 10 * 1024 * 1024) {
          setAvatarStatus('æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡10MB', false);
          return;
        }

        pendingFile = file;
        const reader = new FileReader();
        reader.onload = function(e) {
          const cropperImage = document.getElementById('cropperImage');
          const cropperModal = document.getElementById('cropperModal');
          
          cropperImage.src = e.target.result;
          cropperModal.style.display = 'flex';
          
          // é”€æ¯æ—§çš„cropper
          if (cropper) {
            cropper.destroy();
          }
          
          // åˆ›å»ºæ–°çš„cropper
          cropper = new Cropper(cropperImage, {
            aspectRatio: 1,
            viewMode: 1,
            dragMode: 'move',
            autoCropArea: 1,
            restore: false,
            guides: true,
            center: true,
            highlight: false,
            cropBoxMovable: true,
            cropBoxResizable: true,
            toggleDragModeOnDblclick: false,
          });
          
          // ç¼©æ”¾æ»‘å—
          const zoomSlider = document.getElementById('cropperZoom');
          const zoomValue = document.getElementById('cropperZoomValue');
          
          zoomSlider.oninput = function() {
            const zoomRatio = this.value / 100 * 2; // 0-2å€ç¼©æ”¾
            cropper.zoomTo(zoomRatio);
            zoomValue.textContent = (1 + zoomRatio).toFixed(1) + 'x';
          };
        };
        reader.readAsDataURL(file);
      }

      function hideCropper() {
        const cropperModal = document.getElementById('cropperModal');
        cropperModal.style.display = 'none';
        if (cropper) {
          cropper.destroy();
          cropper = null;
        }
        pendingFile = null;
        // é‡ç½®æ–‡ä»¶è¾“å…¥
        const avatarInput = document.getElementById('avatar-input');
        avatarInput.value = '';
      }

      async function uploadCroppedImage() {
        if (!cropper) return;
        
        setAvatarStatus('å¤„ç†ä¸­...', false);
        
        // è·å–è£å‰ªåçš„canvas
        const canvas = cropper.getCroppedCanvas({
          width: 512,
          height: 512,
          imageSmoothingEnabled: true,
          imageSmoothingQuality: 'high',
        });
        
        // è½¬æ¢ä¸ºblob
        canvas.toBlob(async function(blob) {
          hideCropper();
          
          if (!blob) {
            setAvatarStatus('å¤„ç†å›¾ç‰‡å¤±è´¥', false);
            return;
          }
          
          setAvatarStatus('ä¸Šä¼ ä¸­...', false);
          const formData = new FormData();
          formData.append('file', blob, 'avatar.jpg');

          try {
            const res = await fetch(`/api/characters/${encodeURIComponent(role)}/avatar`, {
              method: 'POST',
              body: formData
            });
            
            const data = await res.json();
            
            if (res.ok && data.ok) {
              displayAvatar(data.avatar_url + '?t=' + Date.now());
              setAvatarStatus('ä¸Šä¼ æˆåŠŸï¼', true);
              
              // åˆ·æ–°åˆ—è¡¨
              if (window.opener && window.opener.postMessage) {
                window.opener.postMessage({ type: 'avatar_updated', role: role }, '*');
              }
            } else {
              setAvatarStatus(data.error || 'ä¸Šä¼ å¤±è´¥', false);
            }
          } catch(e) {
            console.error('ä¸Šä¼ å¤´åƒå¤±è´¥:', e);
            setAvatarStatus('ä¸Šä¼ å¤±è´¥: ' + e.message, false);
          }
        }, 'image/jpeg', 0.92);
      }

      async function deleteAvatar() {
        if (!confirm('ç¡®å®šè¦åˆ é™¤å¤´åƒå—ï¼Ÿ')) return;

        setAvatarStatus('åˆ é™¤ä¸­...', false);

        try {
          const res = await fetch(`/api/characters/${encodeURIComponent(role)}/avatar`, {
            method: 'DELETE'
          });
          
          const data = await res.json();
          
          if (res.ok && data.ok) {
            displayAvatar('');
            setAvatarStatus('å·²åˆ é™¤', true);
            
            // åˆ·æ–°åˆ—è¡¨
            if (window.opener && window.opener.postMessage) {
              window.opener.postMessage({ type: 'avatar_updated', role: role }, '*');
            }
          } else {
            setAvatarStatus(data.error || 'åˆ é™¤å¤±è´¥', false);
          }
        } catch(e) {
          console.error('åˆ é™¤å¤´åƒå¤±è´¥:', e);
          setAvatarStatus('åˆ é™¤å¤±è´¥: ' + e.message, false);
        }
      }

      // äº‹ä»¶ç›‘å¬
      avatarInput.addEventListener('change', function(e) {
        const file = e.target.files && e.target.files[0];
        if (file) {
          showCropper(file);
        }
      });
      
      // è£å‰ªå™¨æŒ‰é’®äº‹ä»¶
      document.getElementById('cropperCancel').addEventListener('click', hideCropper);
      document.getElementById('cropperConfirm').addEventListener('click', uploadCroppedImage);

      btnUpload.addEventListener('click', function() {
        avatarInput.click();
      });

      btnDelete.addEventListener('click', deleteAvatar);

      // æ”¯æŒæ‹–æ‹½ä¸Šä¼ 
      const avatarPreview = document.getElementById('avatar-preview');
      
      avatarPreview.addEventListener('dragover', function(e) {
        e.preventDefault();
        e.stopPropagation();
        avatarPreview.style.borderColor = '#3b82f6';
        avatarPreview.style.background = '#eff6ff';
      });

      avatarPreview.addEventListener('dragleave', function(e) {
        e.preventDefault();
        e.stopPropagation();
        avatarPreview.style.borderColor = '#e5e7eb';
        avatarPreview.style.background = '#f9fafb';
      });

      avatarPreview.addEventListener('drop', function(e) {
        e.preventDefault();
        e.stopPropagation();
        avatarPreview.style.borderColor = '#e5e7eb';
        avatarPreview.style.background = '#f9fafb';

        const files = e.dataTransfer.files;
        if (files && files[0]) {
          uploadAvatar(files[0]);
        }
      });

      // åˆå§‹åŠ è½½å¤´åƒ
      loadAvatar();
    })();

    // åˆå§‹åŒ– JSONEditor
    (function(){
      var container = document.getElementById('jsoneditor');
      var options = { modes: ['tree','code'], mode: 'tree' };
      var editor = new JSONEditor(container, options);
      try {
        var initial = JSON.parse({{ content|tojson }});
        editor.set(initial);
      } catch(e) {
        try { editor.set(JSON.parse(String.raw`{{ content }}`)); } catch(_) {}
      }

      function getData(){
        try { return editor.get(); } catch(e) { return null; }
      }

      function setStatus(text, ok){
        var el = document.getElementById('save-result');
        el.textContent = text || '';
        el.style.color = ok ? 'var(--success)' : 'var(--muted)';
      }

      function refreshKV(obj){
        var val = (p, d='â€”') => {
          try {
            var x = p.split('.').reduce((o,k)=> (o? o[k] : undefined), obj);
            if (x && typeof x === 'string') return x;
            return d;
          } catch(_) { return d; }
        };
        document.getElementById('kv-goal').textContent = val('ä»»åŠ¡/åŠŸèƒ½æ€§ä¿¡æ¯.ä»»åŠ¡ç›®æ ‡');
        document.getElementById('kv-intent').textContent = val('ä»»åŠ¡/åŠŸèƒ½æ€§ä¿¡æ¯.å¯¹è¯æ„å›¾');
        document.getElementById('kv-name').textContent = val('åŸºç¡€èº«ä»½ä¿¡æ¯.å§“å');
        var world = val('ç¯å¢ƒä¸ä¸–ç•Œè§‚.ä¸–ç•Œè§‚_è¯¦ç»†.ä¸»çº¿');
        if (world === 'â€”') world = val('ç¯å¢ƒä¸ä¸–ç•Œè§‚.ä¸–ç•Œè§‚');
        document.getElementById('kv-world').textContent = world;
      }

      refreshKV(getData()||{});

      document.getElementById('btn-pretty').addEventListener('click', function(){
        try { editor.update(editor.get()); } catch(_) {}
      });
      document.getElementById('btn-validate').addEventListener('click', function(){
        var data = getData();
        if (data === null) { setStatus('JSON æ— æ•ˆ', false); return; }
        setStatus('JSON è¯­æ³•æœ‰æ•ˆ', true);
      });
      document.getElementById('btn-download').addEventListener('click', function(){
        var data = getData();
        if (!data) return;
        var blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
        var a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'structured_{{ role }}.json';
        a.click();
      });
      document.getElementById('file-input').addEventListener('change', function(ev){
        var f = ev.target.files && ev.target.files[0];
        if (!f) return;
        var reader = new FileReader();
        reader.onload = function(){
          try { editor.set(JSON.parse(reader.result)); refreshKV(getData()||{}); setStatus('å·²å¯¼å…¥', true);} catch(e){ setStatus('å¯¼å…¥å¤±è´¥: '+e, false); }
        };
        reader.readAsText(f, 'utf-8');
        ev.target.value = '';
      });
      document.getElementById('btn-save').addEventListener('click', async function(){
        var data = getData();
        if (!data) { setStatus('JSON æ— æ•ˆï¼Œæœªä¿å­˜', false); return; }
        try {
          const res = await fetch('/structured/{{ role }}', { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
          const j = await res.json();
          if (j && j.ok) { setStatus('å·²ä¿å­˜', true); refreshKV(data); }
          else { setStatus('ä¿å­˜å¤±è´¥', false); }
        } catch(e) { setStatus('ä¿å­˜å¤±è´¥: '+e, false); }
      });
    })();

    // è®°å¿†ç®¡ç†
    (function(){
      var stmEditor = document.getElementById('stm-editor');
      var ltmEditor = document.getElementById('ltm-editor');
      var stmCount = document.getElementById('stm-count');
      var ltmCount = document.getElementById('ltm-count');
      var memoriesSaveResult = document.getElementById('memories-save-result');

      function updateCounts() {
        var stmLines = stmEditor.value.split('\n').filter(line => line.trim()).length;
        var ltmLines = ltmEditor.value.split('\n').filter(line => line.trim()).length;
        stmCount.textContent = stmLines;
        ltmCount.textContent = ltmLines;
      }

      function setMemoriesStatus(text, ok){
        memoriesSaveResult.textContent = text || '';
        memoriesSaveResult.style.color = ok ? 'var(--success)' : 'var(--muted)';
      }

      async function loadMemories() {
        try {
          const res = await fetch('/api/characters/{{ role }}/memories');
          const data = await res.json();
          stmEditor.value = (data.short_term || []).join('\n');
          ltmEditor.value = (data.long_term || []).join('\n');
          updateCounts();
          setMemoriesStatus('å·²åŠ è½½', true);
          setTimeout(() => setMemoriesStatus('', false), 2000);
        } catch(e) {
          setMemoriesStatus('åŠ è½½å¤±è´¥: '+e, false);
        }
      }

      async function saveMemories() {
        try {
          var shortTerm = stmEditor.value.split('\n').filter(line => line.trim());
          var longTerm = ltmEditor.value.split('\n').filter(line => line.trim());
          
          const res = await fetch('/api/characters/{{ role }}/memories', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ short_term: shortTerm, long_term: longTerm })
          });
          const j = await res.json();
          if (j && j.ok) {
            updateCounts();
            setMemoriesStatus('å·²ä¿å­˜', true);
            setTimeout(() => setMemoriesStatus('', false), 2000);
          } else {
            setMemoriesStatus('ä¿å­˜å¤±è´¥', false);
          }
        } catch(e) {
          setMemoriesStatus('ä¿å­˜å¤±è´¥: '+e, false);
        }
      }

      stmEditor.addEventListener('input', updateCounts);
      ltmEditor.addEventListener('input', updateCounts);
      document.getElementById('btn-load-memories').addEventListener('click', loadMemories);
      document.getElementById('btn-save-memories').addEventListener('click', saveMemories);

      // åˆå§‹åŠ è½½è®°å¿†
      loadMemories();
    })();
  </script>
</article>


