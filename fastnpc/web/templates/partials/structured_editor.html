<article>
  <header>
    <h2>结构化数据（{{ role }}）</h2>
  </header>

  <!-- JSONEditor 资源（CDN） -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jsoneditor@9.10.5/dist/jsoneditor.min.css">
  <script src="https://cdn.jsdelivr.net/npm/jsoneditor@9.10.5/dist/jsoneditor.min.js"></script>

  <div class="grid two">
    <div>
      <div class="card">
        <div id="jsoneditor" style="height: 520px;"></div>
        <div class="toolbar">
          <button id="btn-pretty" type="button">格式化</button>
          <button id="btn-validate" type="button">校验</button>
          <button id="btn-download" type="button">下载</button>
          <label class="upload-label">导入<input id="file-input" type="file" accept="application/json,.json" /></label>
          <span class="spacer"></span>
          <button id="btn-save" class="contrast" type="button">保存</button>
          <span id="save-result" class="muted"></span>
        </div>
      </div>
    </div>
    <aside>
      <div class="card">
        <h3>关键信息</h3>
        <div class="kv"><span>任务目标</span><em id="kv-goal">—</em></div>
        <div class="kv"><span>对话意图</span><em id="kv-intent">—</em></div>
        <div class="kv"><span>角色姓名</span><em id="kv-name">—</em></div>
        <div class="kv"><span>世界主线</span><em id="kv-world">—</em></div>
      </div>
    </aside>
  </div>

  <!-- 记忆管理 -->
  <div style="margin-top: 2rem;">
    <div class="card">
      <h3>角色记忆</h3>
      <p class="muted" style="margin-bottom: 1rem;">管理角色的短期记忆和长期记忆，每行一条记忆。</p>
      
      <div style="margin-bottom: 1.5rem;">
        <label for="stm-editor">
          <strong>短期记忆 (Short-term Memory)</strong>
          <small class="muted" style="margin-left: 0.5rem;">最近的对话和经历，会自动整合到长期记忆</small>
        </label>
        <textarea 
          id="stm-editor" 
          rows="8" 
          placeholder="每行一条短期记忆..."
          style="width: 100%; font-family: monospace; font-size: 14px; resize: vertical; margin-top: 0.5rem;"
        ></textarea>
        <div class="muted" style="font-size: 12px; margin-top: 0.25rem;">
          <span id="stm-count">0</span> 条记忆
        </div>
      </div>

      <div style="margin-bottom: 1rem;">
        <label for="ltm-editor">
          <strong>长期记忆 (Long-term Memory)</strong>
          <small class="muted" style="margin-left: 0.5rem;">重要的知识和经历，会长期保留</small>
        </label>
        <textarea 
          id="ltm-editor" 
          rows="8" 
          placeholder="每行一条长期记忆..."
          style="width: 100%; font-family: monospace; font-size: 14px; resize: vertical; margin-top: 0.5rem;"
        ></textarea>
        <div class="muted" style="font-size: 12px; margin-top: 0.25rem;">
          <span id="ltm-count">0</span> 条记忆
        </div>
      </div>

      <div class="toolbar">
        <button id="btn-load-memories" type="button">重新加载</button>
        <span class="spacer"></span>
        <button id="btn-save-memories" class="contrast" type="button">保存记忆</button>
        <span id="memories-save-result" class="muted"></span>
      </div>
    </div>
  </div>

  <script>
    // 注入聊天 session
    (function(){
      var el = document.getElementById('chat-session');
      if (el) el.value = '{{ session_id }}';
    })();

    // 初始化 JSONEditor
    (function(){
      var container = document.getElementById('jsoneditor');
      var options = { modes: ['tree','code'], mode: 'tree' };
      var editor = new JSONEditor(container, options);
      try {
        var initial = JSON.parse({{ content|tojson }});
        editor.set(initial);
      } catch(e) {
        try { editor.set(JSON.parse(String.raw`{{ content }}`)); } catch(_) {}
      }

      function getData(){
        try { return editor.get(); } catch(e) { return null; }
      }

      function setStatus(text, ok){
        var el = document.getElementById('save-result');
        el.textContent = text || '';
        el.style.color = ok ? 'var(--success)' : 'var(--muted)';
      }

      function refreshKV(obj){
        var val = (p, d='—') => {
          try {
            var x = p.split('.').reduce((o,k)=> (o? o[k] : undefined), obj);
            if (x && typeof x === 'string') return x;
            return d;
          } catch(_) { return d; }
        };
        document.getElementById('kv-goal').textContent = val('任务/功能性信息.任务目标');
        document.getElementById('kv-intent').textContent = val('任务/功能性信息.对话意图');
        document.getElementById('kv-name').textContent = val('基础身份信息.姓名');
        var world = val('环境与世界观.世界观_详细.主线');
        if (world === '—') world = val('环境与世界观.世界观');
        document.getElementById('kv-world').textContent = world;
      }

      refreshKV(getData()||{});

      document.getElementById('btn-pretty').addEventListener('click', function(){
        try { editor.update(editor.get()); } catch(_) {}
      });
      document.getElementById('btn-validate').addEventListener('click', function(){
        var data = getData();
        if (data === null) { setStatus('JSON 无效', false); return; }
        setStatus('JSON 语法有效', true);
      });
      document.getElementById('btn-download').addEventListener('click', function(){
        var data = getData();
        if (!data) return;
        var blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
        var a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'structured_{{ role }}.json';
        a.click();
      });
      document.getElementById('file-input').addEventListener('change', function(ev){
        var f = ev.target.files && ev.target.files[0];
        if (!f) return;
        var reader = new FileReader();
        reader.onload = function(){
          try { editor.set(JSON.parse(reader.result)); refreshKV(getData()||{}); setStatus('已导入', true);} catch(e){ setStatus('导入失败: '+e, false); }
        };
        reader.readAsText(f, 'utf-8');
        ev.target.value = '';
      });
      document.getElementById('btn-save').addEventListener('click', async function(){
        var data = getData();
        if (!data) { setStatus('JSON 无效，未保存', false); return; }
        try {
          const res = await fetch('/structured/{{ role }}', { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
          const j = await res.json();
          if (j && j.ok) { setStatus('已保存', true); refreshKV(data); }
          else { setStatus('保存失败', false); }
        } catch(e) { setStatus('保存失败: '+e, false); }
      });
    })();

    // 记忆管理
    (function(){
      var stmEditor = document.getElementById('stm-editor');
      var ltmEditor = document.getElementById('ltm-editor');
      var stmCount = document.getElementById('stm-count');
      var ltmCount = document.getElementById('ltm-count');
      var memoriesSaveResult = document.getElementById('memories-save-result');

      function updateCounts() {
        var stmLines = stmEditor.value.split('\n').filter(line => line.trim()).length;
        var ltmLines = ltmEditor.value.split('\n').filter(line => line.trim()).length;
        stmCount.textContent = stmLines;
        ltmCount.textContent = ltmLines;
      }

      function setMemoriesStatus(text, ok){
        memoriesSaveResult.textContent = text || '';
        memoriesSaveResult.style.color = ok ? 'var(--success)' : 'var(--muted)';
      }

      async function loadMemories() {
        try {
          const res = await fetch('/api/characters/{{ role }}/memories');
          const data = await res.json();
          stmEditor.value = (data.short_term || []).join('\n');
          ltmEditor.value = (data.long_term || []).join('\n');
          updateCounts();
          setMemoriesStatus('已加载', true);
          setTimeout(() => setMemoriesStatus('', false), 2000);
        } catch(e) {
          setMemoriesStatus('加载失败: '+e, false);
        }
      }

      async function saveMemories() {
        try {
          var shortTerm = stmEditor.value.split('\n').filter(line => line.trim());
          var longTerm = ltmEditor.value.split('\n').filter(line => line.trim());
          
          const res = await fetch('/api/characters/{{ role }}/memories', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ short_term: shortTerm, long_term: longTerm })
          });
          const j = await res.json();
          if (j && j.ok) {
            updateCounts();
            setMemoriesStatus('已保存', true);
            setTimeout(() => setMemoriesStatus('', false), 2000);
          } else {
            setMemoriesStatus('保存失败', false);
          }
        } catch(e) {
          setMemoriesStatus('保存失败: '+e, false);
        }
      }

      stmEditor.addEventListener('input', updateCounts);
      ltmEditor.addEventListener('input', updateCounts);
      document.getElementById('btn-load-memories').addEventListener('click', loadMemories);
      document.getElementById('btn-save-memories').addEventListener('click', saveMemories);

      // 初始加载记忆
      loadMemories();
    })();
  </script>
</article>


