# ç¼“å­˜æœºåˆ¶ä¼˜åŒ–è®¡åˆ’

## ç›®æ ‡

å®æ–½ç¼“å­˜å±‚ï¼Œå‡å°‘æ•°æ®åº“æŸ¥è¯¢ï¼š
- **æ•°æ®åº“æŸ¥è¯¢å‡å°‘**ï¼š80%
- **å“åº”é€Ÿåº¦æå‡**ï¼š50-200ms â†’ 1-5ms
- **æ•°æ®åº“è´Ÿè½½é™ä½**ï¼š80%
- **ç³»ç»Ÿååé‡æå‡**ï¼š2-3å€

---

## å½“å‰é—®é¢˜åˆ†æ

### é—®é¢˜1ï¼šé¢‘ç¹æŸ¥è¯¢ç”¨æˆ·è®¾ç½®

```python
# æ¯æ¬¡èŠå¤©éƒ½æŸ¥è¯¢ï¼ˆfastnpc/api/routes/chat_routes.pyï¼‰
def api_post_message(...):
    user_settings = get_user_settings(user_id)  # æŸ¥æ•°æ®åº“ âŒ
    ctx_max_chat = int(user_settings.get('ctx_max_chat') or 3000)
    # ...
```

**å½±å“**ï¼š
- æ¯æ¡æ¶ˆæ¯æŸ¥è¯¢1æ¬¡ï¼š50-100ms
- 10äººå¹¶å‘ï¼š10æ¬¡æŸ¥è¯¢
- ç”¨æˆ·è®¾ç½®å¾ˆå°‘å˜åŒ–ï¼Œä½†æ¯æ¬¡éƒ½æŸ¥

### é—®é¢˜2ï¼šé¢‘ç¹æŸ¥è¯¢è§’è‰²é…ç½®

```python
# æ¯æ¬¡èŠå¤©éƒ½æŸ¥è¯¢è§’è‰²å®Œæ•´æ•°æ®
def _load_character_profile(role, user_id):
    character_id = get_character_id(user_id, role)  # æŸ¥æ•°æ®åº“ âŒ
    full_data = load_character_full_data(character_id)  # æŸ¥æ•°æ®åº“ âŒ
    memories = load_character_memories(character_id)  # æŸ¥æ•°æ®åº“ âŒ
    # æ€»å…±3æ¬¡æ•°æ®åº“æŸ¥è¯¢ï¼
```

**å½±å“**ï¼š
- æ¯æ¡æ¶ˆæ¯æŸ¥è¯¢3æ¬¡ï¼š150-300ms
- è§’è‰²é…ç½®å¾ˆå°‘å˜åŒ–ï¼Œä½†æ¯æ¬¡éƒ½æŸ¥

### é—®é¢˜3ï¼šé¢‘ç¹æŸ¥è¯¢è§’è‰²åˆ—è¡¨

```python
# å‰ç«¯æ¯æ¬¡åˆ·æ–°éƒ½æŸ¥è¯¢
@router.get("/api/characters")
def api_characters(request):
    return list_characters(user_id)  # æŸ¥æ•°æ®åº“ âŒ
```

**å½±å“**ï¼š
- ç”¨æˆ·åˆ‡æ¢é¡µé¢å°±æŸ¥è¯¢
- åˆ—è¡¨å¾ˆå°‘å˜åŒ–ï¼ˆåªæœ‰åˆ›å»º/åˆ é™¤æ—¶ï¼‰

### ç»Ÿè®¡

**å•æ¬¡èŠå¤©æ•°æ®åº“æŸ¥è¯¢**ï¼š
```
1. ç”¨æˆ·è®¾ç½®ï¼š1æ¬¡
2. è§’è‰²IDï¼š1æ¬¡
3. è§’è‰²é…ç½®ï¼š8æ¬¡ï¼ˆ8ä¸ªåˆ†ç±»è¡¨ï¼‰
4. è§’è‰²è®°å¿†ï¼š1æ¬¡
æ€»è®¡ï¼š11æ¬¡æŸ¥è¯¢ âŒ

ä¼˜åŒ–åï¼š0æ¬¡æŸ¥è¯¢ï¼ˆå…¨éƒ¨ç¼“å­˜ï¼‰âœ…
```

---

## è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆï¼šPythonå†…å­˜ç¼“å­˜ï¼ˆfunctools.lru_cache + æ‰‹åŠ¨ç¼“å­˜ï¼‰

**æŠ€æœ¯é€‰å‹**ï¼š

#### é€‰é¡¹1ï¼šfunctools.lru_cacheï¼ˆæ¨èå¼€å§‹ä½¿ç”¨ï¼‰
- âœ… Pythonå†…ç½®ï¼Œæ— éœ€é¢å¤–ä¾èµ–
- âœ… ç®€å•æ˜“ç”¨ï¼Œè£…é¥°å™¨å³å¯
- âœ… è‡ªåŠ¨LRUæ·˜æ±°ç­–ç•¥
- âš ï¸ å•è¿›ç¨‹å†…å­˜ç¼“å­˜ï¼ˆå¤šworkerä¸å…±äº«ï¼‰

#### é€‰é¡¹2ï¼šRedisï¼ˆå¯é€‰ï¼Œåç»­ä¼˜åŒ–ï¼‰
- âœ… å¤šworkerå…±äº«
- âœ… æŒä¹…åŒ–
- âœ… åŠŸèƒ½å¼ºå¤§
- âš ï¸ éœ€è¦é¢å¤–éƒ¨ç½²Redis

#### é€‰é¡¹3ï¼šè‡ªå®šä¹‰å†…å­˜ç¼“å­˜å­—å…¸
- âœ… å®Œå…¨å¯æ§
- âœ… å¯æ·»åŠ TTLã€å¤±æ•ˆç­–ç•¥
- âš ï¸ éœ€è¦æ‰‹åŠ¨ç®¡ç†

**æ¨èæ–¹æ¡ˆ**ï¼š
1. **é˜¶æ®µ1**ï¼šä½¿ç”¨ `lru_cache` + è‡ªå®šä¹‰ç¼“å­˜å­—å…¸ï¼ˆç®€å•å¿«é€Ÿï¼‰
2. **é˜¶æ®µ2**ï¼ˆå¯é€‰ï¼‰ï¼šè¿ç§»åˆ°Redisï¼ˆå¦‚æœéœ€è¦å¤šworkerå…±äº«ï¼‰

---

## å®æ–½æ­¥éª¤

### æ­¥éª¤1ï¼šåˆ›å»ºç¼“å­˜ç®¡ç†æ¨¡å—

**æ–°å»ºæ–‡ä»¶**ï¼š`fastnpc/api/cache.py`

**åŠŸèƒ½**ï¼š
- ç»Ÿä¸€ç¼“å­˜ç®¡ç†
- TTLæ”¯æŒï¼ˆè¿‡æœŸæ—¶é—´ï¼‰
- ç¼“å­˜å¤±æ•ˆæœºåˆ¶
- ç¼“å­˜ç»Ÿè®¡

**æ ¸å¿ƒç±»**ï¼š
```python
class SimpleCache:
    """ç®€å•çš„å†…å­˜ç¼“å­˜ï¼Œæ”¯æŒTTL"""
    def __init__(self, default_ttl=300):
        self._cache = {}
        self._timestamps = {}
        self._default_ttl = default_ttl
        self._lock = threading.Lock()
    
    def get(self, key):
        """è·å–ç¼“å­˜"""
        pass
    
    def set(self, key, value, ttl=None):
        """è®¾ç½®ç¼“å­˜"""
        pass
    
    def delete(self, key):
        """åˆ é™¤ç¼“å­˜"""
        pass
    
    def clear(self):
        """æ¸…ç©ºç¼“å­˜"""
        pass
```

### æ­¥éª¤2ï¼šç¼“å­˜ç”¨æˆ·è®¾ç½®

**æ›´æ–°æ–‡ä»¶**ï¼š`fastnpc/api/auth/users.py`

**æ”¹åŠ¨**ï¼š
```python
# æ·»åŠ LRUç¼“å­˜
from functools import lru_cache

@lru_cache(maxsize=1000)  # ç¼“å­˜1000ä¸ªç”¨æˆ·
def get_user_settings_cached(user_id: int) -> Dict[str, Any]:
    """ç¼“å­˜ç‰ˆæœ¬çš„ç”¨æˆ·è®¾ç½®æŸ¥è¯¢"""
    return get_user_settings(user_id)

# æä¾›ç¼“å­˜æ¸…ç†å‡½æ•°
def invalidate_user_settings_cache(user_id: int):
    """æ¸…é™¤æŒ‡å®šç”¨æˆ·çš„è®¾ç½®ç¼“å­˜"""
    get_user_settings_cached.cache_clear()
```

**ä½¿ç”¨ä½ç½®**ï¼š
- `chat_routes.py`
- `group_routes.py`

### æ­¥éª¤3ï¼šç¼“å­˜è§’è‰²é…ç½®

**æ›´æ–°æ–‡ä»¶**ï¼š`fastnpc/api/utils.py`

**æ”¹åŠ¨**ï¼š
```python
from fastnpc.api.cache import SimpleCache

# è§’è‰²é…ç½®ç¼“å­˜ï¼ˆ5åˆ†é’ŸTTLï¼‰
character_cache = SimpleCache(default_ttl=300)

def _load_character_profile_cached(role: str, user_id: int):
    """ç¼“å­˜ç‰ˆæœ¬çš„è§’è‰²é…ç½®åŠ è½½"""
    cache_key = f"char_profile:{user_id}:{role}"
    
    # å°è¯•ä»ç¼“å­˜è·å–
    cached = character_cache.get(cache_key)
    if cached is not None:
        return cached
    
    # ç¼“å­˜æœªå‘½ä¸­ï¼ŒæŸ¥è¯¢æ•°æ®åº“
    profile = _load_character_profile(role, user_id)
    
    # ä¿å­˜åˆ°ç¼“å­˜
    if profile:
        character_cache.set(cache_key, profile)
    
    return profile

def invalidate_character_cache(user_id: int, role: str):
    """æ¸…é™¤è§’è‰²ç¼“å­˜ï¼ˆæ›´æ–°æ—¶è°ƒç”¨ï¼‰"""
    cache_key = f"char_profile:{user_id}:{role}"
    character_cache.delete(cache_key)
```

### æ­¥éª¤4ï¼šç¼“å­˜è§’è‰²IDæ˜ å°„

**æ›´æ–°æ–‡ä»¶**ï¼š`fastnpc/api/auth/characters.py`

**æ”¹åŠ¨**ï¼š
```python
from functools import lru_cache

@lru_cache(maxsize=5000)  # ç¼“å­˜5000ä¸ªæ˜ å°„
def get_character_id_cached(user_id: int, name: str) -> Optional[int]:
    """ç¼“å­˜ç‰ˆæœ¬çš„è§’è‰²IDæŸ¥è¯¢"""
    return get_character_id(user_id, name)

def invalidate_character_id_cache():
    """æ¸…é™¤è§’è‰²IDç¼“å­˜"""
    get_character_id_cached.cache_clear()
```

### æ­¥éª¤5ï¼šç¼“å­˜è§’è‰²åˆ—è¡¨

**æ›´æ–°æ–‡ä»¶**ï¼š`fastnpc/api/utils.py`

**æ”¹åŠ¨**ï¼š
```python
# è§’è‰²åˆ—è¡¨ç¼“å­˜ï¼ˆ1åˆ†é’ŸTTLï¼‰
character_list_cache = SimpleCache(default_ttl=60)

def _list_structured_files_cached(user_id: int):
    """ç¼“å­˜ç‰ˆæœ¬çš„è§’è‰²åˆ—è¡¨"""
    cache_key = f"char_list:{user_id}"
    
    cached = character_list_cache.get(cache_key)
    if cached is not None:
        return cached
    
    items = _list_structured_files(user_id)
    character_list_cache.set(cache_key, items)
    
    return items

def invalidate_character_list_cache(user_id: int):
    """æ¸…é™¤è§’è‰²åˆ—è¡¨ç¼“å­˜"""
    cache_key = f"char_list:{user_id}"
    character_list_cache.delete(cache_key)
```

### æ­¥éª¤6ï¼šæ›´æ–°è°ƒç”¨ç‚¹

**æ›´æ–°æ–‡ä»¶**ï¼š
- `fastnpc/api/routes/chat_routes.py`
- `fastnpc/api/routes/group_routes.py`
- `fastnpc/api/routes/character_routes.py`

**æ”¹åŠ¨**ï¼šå°†æ‰€æœ‰æ•°æ®åº“æŸ¥è¯¢æ›¿æ¢ä¸ºç¼“å­˜ç‰ˆæœ¬

### æ­¥éª¤7ï¼šç¼“å­˜å¤±æ•ˆæœºåˆ¶

**å…³é”®ç‚¹**ï¼šåœ¨æ•°æ®æ›´æ–°æ—¶æ¸…é™¤ç¼“å­˜

```python
# ç”¨æˆ·è®¾ç½®æ›´æ–°æ—¶
def update_user_settings(...):
    # æ›´æ–°æ•°æ®åº“
    ...
    # æ¸…é™¤ç¼“å­˜
    invalidate_user_settings_cache(user_id)

# è§’è‰²æ›´æ–°æ—¶
def update_character_structured(...):
    # æ›´æ–°æ•°æ®åº“
    ...
    # æ¸…é™¤ç¼“å­˜
    invalidate_character_cache(user_id, role)
    invalidate_character_list_cache(user_id)

# è§’è‰²åˆ é™¤æ—¶
def delete_character(...):
    # åˆ é™¤æ•°æ®åº“è®°å½•
    ...
    # æ¸…é™¤ç¼“å­˜
    invalidate_character_cache(user_id, name)
    invalidate_character_list_cache(user_id)
```

### æ­¥éª¤8ï¼šç¼“å­˜ç›‘æ§å’Œç»Ÿè®¡

**åŠŸèƒ½**ï¼š
- ç¼“å­˜å‘½ä¸­ç‡ç»Ÿè®¡
- ç¼“å­˜å¤§å°ç›‘æ§
- æ€§èƒ½å¯¹æ¯”

```python
class CacheStats:
    def __init__(self):
        self.hits = 0
        self.misses = 0
    
    @property
    def hit_rate(self):
        total = self.hits + self.misses
        return self.hits / total if total > 0 else 0
    
    def record_hit(self):
        self.hits += 1
    
    def record_miss(self):
        self.misses += 1
```

---

## ç¼“å­˜ç­–ç•¥

### 1. ç”¨æˆ·è®¾ç½®ç¼“å­˜

```python
# ç­–ç•¥
ç¼“å­˜é”®ï¼šf"user_settings:{user_id}"
TTLï¼šæ°¸ä¹…ï¼ˆLRUæ·˜æ±°ï¼‰
å¤±æ•ˆæ—¶æœºï¼šç”¨æˆ·æ›´æ–°è®¾ç½®æ—¶
ç¼“å­˜å¤§å°ï¼š1000ä¸ªç”¨æˆ·

# åŸå› 
- ç”¨æˆ·è®¾ç½®å‡ ä¹ä¸å˜
- æ¯æ¬¡èŠå¤©éƒ½éœ€è¦
- æ•°æ®é‡å°ï¼ˆå‡ KBï¼‰
```

### 2. è§’è‰²é…ç½®ç¼“å­˜

```python
# ç­–ç•¥
ç¼“å­˜é”®ï¼šf"char_profile:{user_id}:{role}"
TTLï¼š5åˆ†é’Ÿ
å¤±æ•ˆæ—¶æœºï¼šè§’è‰²æ›´æ–°æ—¶
ç¼“å­˜å¤§å°ï¼šæ— é™åˆ¶ï¼ˆè‡ªåŠ¨æ·˜æ±°ï¼‰

# åŸå› 
- è§’è‰²é…ç½®å˜åŒ–å°‘
- æ•°æ®é‡è¾ƒå¤§ï¼ˆå‡ åKBï¼‰
- æ¯æ¬¡èŠå¤©éƒ½éœ€è¦
```

### 3. è§’è‰²IDæ˜ å°„ç¼“å­˜

```python
# ç­–ç•¥
ç¼“å­˜é”®ï¼š(user_id, name)
TTLï¼šæ°¸ä¹…ï¼ˆLRUæ·˜æ±°ï¼‰
å¤±æ•ˆæ—¶æœºï¼šè§’è‰²åˆ›å»º/åˆ é™¤æ—¶
ç¼“å­˜å¤§å°ï¼š5000ä¸ªæ˜ å°„

# åŸå› 
- IDæ˜ å°„ä¸å˜
- æŸ¥è¯¢é¢‘ç¹
- æ•°æ®é‡æå°
```

### 4. è§’è‰²åˆ—è¡¨ç¼“å­˜

```python
# ç­–ç•¥
ç¼“å­˜é”®ï¼šf"char_list:{user_id}"
TTLï¼š1åˆ†é’Ÿ
å¤±æ•ˆæ—¶æœºï¼šè§’è‰²åˆ›å»º/åˆ é™¤æ—¶
ç¼“å­˜å¤§å°ï¼šæ— é™åˆ¶

# åŸå› 
- åˆ—è¡¨å˜åŒ–è¾ƒå°‘
- å‰ç«¯é¢‘ç¹åˆ·æ–°
- æ•°æ®é‡ä¸­ç­‰
```

---

## æ€§èƒ½æå‡é¢„æœŸ

### å•æ¬¡èŠå¤©å¯¹è¯

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|------|--------|--------|------|
| **æ•°æ®åº“æŸ¥è¯¢æ¬¡æ•°** | 11æ¬¡ | 0æ¬¡ | **å‡å°‘100%** ğŸ‰ |
| **æ•°æ®åº“æŸ¥è¯¢è€—æ—¶** | 300-500ms | 0ms | **èŠ‚çœ500ms** âš¡ |
| **æ€»å“åº”æ—¶é—´** | 5-10ç§’ | 4.5-9.5ç§’ | **å¿«10%** |

### è§’è‰²åˆ—è¡¨æŸ¥è¯¢

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|------|--------|--------|------|
| **å“åº”æ—¶é—´** | 50-200ms | 1-5ms | **10-40å€** ğŸš€ |
| **æ•°æ®åº“è´Ÿè½½** | æ¯æ¬¡æŸ¥è¯¢ | 1åˆ†é’Ÿ1æ¬¡ | **å‡å°‘99%** |

### 100æ¬¡èŠå¤©å¯¹è¯

```
ä¼˜åŒ–å‰ï¼š
- æ•°æ®åº“æŸ¥è¯¢ï¼š1100æ¬¡
- æ•°æ®åº“è€—æ—¶ï¼š30-50ç§’
- æ€»è€—æ—¶ï¼š500-1000ç§’

ä¼˜åŒ–åï¼š
- æ•°æ®åº“æŸ¥è¯¢ï¼š0-10æ¬¡ï¼ˆé¦–æ¬¡+è¿‡æœŸï¼‰
- æ•°æ®åº“è€—æ—¶ï¼š0-3ç§’
- æ€»è€—æ—¶ï¼š450-950ç§’

èŠ‚çœï¼š10%å“åº”æ—¶é—´ + 95%æ•°æ®åº“è´Ÿè½½
```

### æ•°æ®åº“è´Ÿè½½é™ä½

```
åœºæ™¯ï¼š50äººåŒæ—¶åœ¨çº¿

ä¼˜åŒ–å‰ï¼š
- æ¯äººæ¯åˆ†é’Ÿï¼š10æ¡æ¶ˆæ¯
- æ¯æ¡æ¶ˆæ¯ï¼š11æ¬¡æŸ¥è¯¢
- æ€»æŸ¥è¯¢ï¼š50Ã—10Ã—11 = 5500æ¬¡/åˆ†é’Ÿ

ä¼˜åŒ–åï¼š
- é¦–æ¬¡æŸ¥è¯¢ï¼š50Ã—11 = 550æ¬¡
- åç»­æŸ¥è¯¢ï¼š0æ¬¡ï¼ˆç¼“å­˜å‘½ä¸­ï¼‰
- æ€»æŸ¥è¯¢ï¼š550æ¬¡/é¦–æ¬¡ï¼Œåç»­0-50æ¬¡/åˆ†é’Ÿ

é™ä½ï¼š90-98%æ•°æ®åº“è´Ÿè½½ ğŸŠ
```

---

## ç¼“å­˜ä¸€è‡´æ€§

### é—®é¢˜ï¼šå¤šWorkerç¼“å­˜ä¸ä¸€è‡´

**åœºæ™¯**ï¼š
```
Worker1: æ›´æ–°è§’è‰²é…ç½® â†’ æ¸…é™¤Worker1ç¼“å­˜ âœ“
Worker2: ä»æœ‰æ—§ç¼“å­˜ âœ—
```

**è§£å†³æ–¹æ¡ˆ**ï¼š

#### æ–¹æ¡ˆAï¼šæ¥å—çŸ­æœŸä¸ä¸€è‡´ï¼ˆæ¨èï¼Œ2æ ¸æœåŠ¡å™¨ï¼‰
```python
# ä½¿ç”¨TTLè‡ªåŠ¨è¿‡æœŸ
- è§’è‰²é…ç½®ï¼š5åˆ†é’ŸTTL
- ç”¨æˆ·è®¾ç½®ï¼šæ›´æ–°æ—¶å…¨å±€æ¸…é™¤
- è§’è‰²åˆ—è¡¨ï¼š1åˆ†é’ŸTTL

ä¼˜ç‚¹ï¼š
- ç®€å•ï¼Œæ— éœ€é¢å¤–ç»„ä»¶
- å¯¹ç”¨æˆ·å½±å“å°ï¼ˆ5åˆ†é’Ÿå†…ç”Ÿæ•ˆï¼‰
- é€‚åˆ2 workeråœºæ™¯

ç¼ºç‚¹ï¼š
- çŸ­æœŸä¸ä¸€è‡´ï¼ˆæœ€å¤š5åˆ†é’Ÿï¼‰
```

#### æ–¹æ¡ˆBï¼šä½¿ç”¨Rediså…±äº«ç¼“å­˜ï¼ˆå¯é€‰ï¼‰
```python
# æ‰€æœ‰workerå…±äº«Redis
- ç«‹å³ä¸€è‡´
- éœ€è¦éƒ¨ç½²Redis
- é€‚åˆå¤šworkeråœºæ™¯ï¼ˆ8+ï¼‰

ä½•æ—¶è¿ç§»ï¼š
- Workeræ•°é‡ >4
- éœ€è¦ç«‹å³ä¸€è‡´æ€§
- æœ‰è¿ç»´èµ„æº
```

#### æ–¹æ¡ˆCï¼šç¼“å­˜å¤±æ•ˆå¹¿æ’­ï¼ˆå¤æ‚ï¼‰
```python
# Workeré—´é€šä¿¡
- ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—
- å¤æ‚åº¦é«˜
- ä¸æ¨èï¼ˆ2æ ¸æœåŠ¡å™¨ï¼‰
```

**æ¨è**ï¼šå…ˆç”¨æ–¹æ¡ˆAï¼ˆTTLï¼‰ï¼Œå¦‚æœæœ‰é—®é¢˜å†å‡çº§åˆ°Redis

---

## å†…å­˜ä½¿ç”¨è¯„ä¼°

### 2æ ¸2GæœåŠ¡å™¨ï¼ˆ2 workersï¼‰

```python
å•ä¸ªç¼“å­˜é¡¹å¤§å°ä¼°ç®—ï¼š

ç”¨æˆ·è®¾ç½®ï¼š~1KB Ã— 1000 = 1MB
è§’è‰²é…ç½®ï¼š~50KB Ã— 100 = 5MB
è§’è‰²IDæ˜ å°„ï¼š~100B Ã— 5000 = 500KB
è§’è‰²åˆ—è¡¨ï¼š~10KB Ã— 50 = 500KB

æ€»è®¡ï¼ˆå•workerï¼‰ï¼š~7MB
2 workersï¼š~14MB

æœåŠ¡å™¨æ€»å†…å­˜ï¼š2G
å¯ç”¨å†…å­˜ï¼š~1.5G
ç¼“å­˜å ç”¨ï¼š14MBï¼ˆ1%ï¼‰

ç»“è®ºï¼šå†…å­˜å ç”¨å¯å¿½ç•¥ âœ“
```

---

## æ³¨æ„äº‹é¡¹

### 1. ç¼“å­˜å¤±æ•ˆ

**å…³é”®**ï¼šæ•°æ®æ›´æ–°æ—¶å¿…é¡»æ¸…é™¤ç¼“å­˜

```python
# âœ… æ­£ç¡®
def update_user_settings(...):
    # 1. æ›´æ–°æ•°æ®åº“
    conn = _get_conn()
    cur.execute("UPDATE user_settings ...")
    conn.commit()
    
    # 2. æ¸…é™¤ç¼“å­˜
    invalidate_user_settings_cache(user_id)

# âŒ é”™è¯¯
def update_user_settings(...):
    # åªæ›´æ–°æ•°æ®åº“ï¼Œå¿˜è®°æ¸…é™¤ç¼“å­˜
    cur.execute("UPDATE user_settings ...")
    conn.commit()
    # ç¼“å­˜ä»æ˜¯æ—§æ•°æ®ï¼
```

### 2. å¹¶å‘å®‰å…¨

```python
# âœ… ä½¿ç”¨é”ä¿æŠ¤
class SimpleCache:
    def __init__(self):
        self._lock = threading.Lock()
    
    def get(self, key):
        with self._lock:
            return self._cache.get(key)
```

### 3. å†…å­˜æ³„æ¼

```python
# âœ… ä½¿ç”¨LRUè‡ªåŠ¨æ·˜æ±°
@lru_cache(maxsize=1000)  # é™åˆ¶å¤§å°
def get_user_settings_cached(...):
    pass

# âœ… ä½¿ç”¨TTLè‡ªåŠ¨è¿‡æœŸ
cache = SimpleCache(default_ttl=300)  # 5åˆ†é’Ÿè¿‡æœŸ
```

### 4. ç¼“å­˜é¢„çƒ­

```python
# å¯é€‰ï¼šåº”ç”¨å¯åŠ¨æ—¶é¢„åŠ è½½çƒ­ç‚¹æ•°æ®
def warmup_cache():
    """é¢„çƒ­ç¼“å­˜"""
    # åŠ è½½æ´»è·ƒç”¨æˆ·è®¾ç½®
    for user_id in get_active_users():
        get_user_settings_cached(user_id)
```

---

## ç›‘æ§å’Œè°ƒè¯•

### ç¼“å­˜å‘½ä¸­ç‡

```python
# æ·»åŠ ç»Ÿè®¡
@router.get("/admin/cache/stats")
def cache_stats(request: Request):
    return {
        "user_settings": {
            "hits": ...,
            "misses": ...,
            "hit_rate": "95%"
        },
        "character_profile": {
            "hits": ...,
            "misses": ...,
            "hit_rate": "90%"
        }
    }
```

### ç¼“å­˜å¤§å°

```python
# ç›‘æ§å†…å­˜ä½¿ç”¨
def get_cache_size():
    import sys
    return {
        "user_settings_size": sys.getsizeof(user_settings_cache),
        "character_cache_size": sys.getsizeof(character_cache),
    }
```

### æ¸…é™¤æ‰€æœ‰ç¼“å­˜

```python
# è°ƒè¯•ç”¨
@router.post("/admin/cache/clear")
def clear_all_caches(request: Request):
    get_user_settings_cached.cache_clear()
    character_cache.clear()
    character_list_cache.clear()
    return {"ok": True}
```

---

## å®æ–½ä¼˜å…ˆçº§

### é«˜ä¼˜å…ˆçº§ï¼ˆå¿…é¡»ï¼‰

1. âœ… ç”¨æˆ·è®¾ç½®ç¼“å­˜ï¼ˆå‡å°‘50%æŸ¥è¯¢ï¼‰
2. âœ… è§’è‰²IDæ˜ å°„ç¼“å­˜ï¼ˆå‡å°‘10%æŸ¥è¯¢ï¼‰

### ä¸­ä¼˜å…ˆçº§ï¼ˆæ¨èï¼‰

3. âœ… è§’è‰²é…ç½®ç¼“å­˜ï¼ˆå‡å°‘20%æŸ¥è¯¢ï¼‰
4. âœ… è§’è‰²åˆ—è¡¨ç¼“å­˜ï¼ˆå‡å°‘10%æŸ¥è¯¢ï¼‰

### ä½ä¼˜å…ˆçº§ï¼ˆå¯é€‰ï¼‰

5. â¸ï¸ Rediså…±äº«ç¼“å­˜ï¼ˆå¤šworkerä¸€è‡´æ€§ï¼‰
6. â¸ï¸ ç¼“å­˜é¢„çƒ­ï¼ˆå¯åŠ¨é€Ÿåº¦ä¼˜åŒ–ï¼‰

---

## éªŒæ”¶æ ‡å‡†

- âœ… æ•°æ®åº“æŸ¥è¯¢å‡å°‘80%
- âœ… å“åº”æ—¶é—´å‡å°‘50-200ms
- âœ… ç¼“å­˜å‘½ä¸­ç‡>90%
- âœ… å†…å­˜ä½¿ç”¨<50MB
- âœ… æ›´æ–°æ•°æ®æ—¶ç¼“å­˜æ­£ç¡®å¤±æ•ˆ
- âœ… æ— ç¼“å­˜ä¸€è‡´æ€§é—®é¢˜

---

## åç»­ä¼˜åŒ–ï¼ˆå¯é€‰ï¼‰

### 1. è¿ç§»åˆ°Redis

**ä½•æ—¶**ï¼š
- Workeræ•°é‡>4
- éœ€è¦æŒä¹…åŒ–
- éœ€è¦ç«‹å³ä¸€è‡´æ€§

**æ”¹åŠ¨**ï¼š
```python
import redis
r = redis.Redis(host='localhost', port=6379)

def get_user_settings_cached(user_id):
    key = f"user_settings:{user_id}"
    cached = r.get(key)
    if cached:
        return json.loads(cached)
    
    settings = get_user_settings(user_id)
    r.setex(key, 300, json.dumps(settings))
    return settings
```

### 2. åˆ†å¸ƒå¼ç¼“å­˜

**ä½¿ç”¨åœºæ™¯**ï¼š
- å¤šæœåŠ¡å™¨éƒ¨ç½²
- éœ€è¦å…±äº«ç¼“å­˜

**æŠ€æœ¯**ï¼š
- Redis Cluster
- Memcached

### 3. ç¼“å­˜å±‚æ¬¡

```
L1: è¿›ç¨‹å†…ç¼“å­˜ï¼ˆlru_cacheï¼‰- æœ€å¿«
L2: Redisç¼“å­˜ - è¾ƒå¿«ï¼Œå…±äº«
L3: æ•°æ®åº“ - è¾ƒæ…¢ï¼ŒæŒä¹…åŒ–
```

---

## æ€»ç»“

è¿™ä¸ªä¼˜åŒ–å°†å¸¦æ¥ï¼š

âœ… **80%æ•°æ®åº“æŸ¥è¯¢å‡å°‘**  
âœ… **2-3å€ç³»ç»Ÿååé‡æå‡**  
âœ… **90%æ•°æ®åº“è´Ÿè½½é™ä½**  
âœ… **10%å“åº”æ—¶é—´æå‡**  

**ç»¼åˆæ•ˆæœï¼ˆæ‰€æœ‰ä¼˜åŒ–ï¼‰**ï¼š
1. æ•°æ®åº“è¿æ¥æ± ï¼š3-5å€
2. LLMå¼‚æ­¥è°ƒç”¨ï¼š10å€
3. å¤šWorkerï¼š2å€
4. ç¼“å­˜æœºåˆ¶ï¼š2-3å€ï¼ˆååé‡ï¼‰
5. **æ€»è®¡ï¼š120-300å€æ€§èƒ½æå‡** ğŸ‰

---

*è®¡åˆ’åˆ›å»ºæ—¶é—´*: 2025-10-17  
*ä¼˜åŒ–ç±»å‹*: ç¼“å­˜æœºåˆ¶  
*é¢„æœŸæå‡*: 80%æŸ¥è¯¢å‡å°‘ + 2-3å€ååé‡

